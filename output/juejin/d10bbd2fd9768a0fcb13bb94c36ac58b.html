<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover"><meta name="google-site-verification" content="cCHsgG9ktuCTgWgYfqCJql8AeR4gAne4DTZqztPoirE"><meta name="apple-itunes-app" content="app-id=987739104"><meta name="baidu-site-verification" content="qiK2a1kcFc"><meta name="360-site-verification" content="4c3c7d57d59f0e1a308462fbc7fd7e51"><meta name="sogou_site_verification" content="c49WUDZczQ"><meta data-vue-meta="true" data-vmid="keywords" name="keywords" content="Java"><meta data-vue-meta="true" data-vmid="description" name="description" content="è‡ªæˆ‘è¡¨æ‰¬ï¼šã€ŠDubbo å®ç°åŸç†ä¸æºç è§£æ â€”â€” ç²¾å“åˆé›†ã€‹ è¡¨æ‰¬è‡ªå·±ï¼šã€ŠDæ•°æ®åº“å®ä½“è®¾è®¡åˆé›†ã€‹ æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/ ã€ŒèŠ‹é“"><title data-vue-meta="true">åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ - åç«¯ - æ˜é‡‘</title><link rel="preload" href="https://b-gold-cdn.xitu.io/v3/static/js/manifest.20254fa563d3539b68bf.js" as="script"><link rel="preload" href="https://b-gold-cdn.xitu.io/v3/static/js/vendor.e6fd81aa1499049a5bee.js" as="script"><link rel="preload" href="https://b-gold-cdn.xitu.io/v3/static/js/app.a99a1e8180beec940a3f.js" as="script"><link rel="preload" href="https://b-gold-cdn.xitu.io/v3/static/css/app.37151bbb8a40894c7953daf9b02b2ff7.css" as="style"><link rel="preload" href="https://b-gold-cdn.xitu.io/v3/static/js/3.f84ea6333e04793cc1e2.js" as="script"><link rel="apple-touch-icon" sizes="180x180" href="https://b-gold-cdn.xitu.io/favicons/v2/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://b-gold-cdn.xitu.io/favicons/v2/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://b-gold-cdn.xitu.io/favicons/v2/favicon-16x16.png"><link rel="manifest" href="https://b-gold-cdn.xitu.io/favicons/v2/manifest.json"><link rel="mask-icon" href="https://b-gold-cdn.xitu.io/favicons/v2/safari-pinned-tab.svg" color="#5bbad5"><link rel="shortcut icon" href="https://b-gold-cdn.xitu.io/favicons/v2/favicon.ico"><meta name="msapplication-config" content="https://b-gold-cdn.xitu.io/favicons/v2/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="search" title="æ˜é‡‘" href="https://b-gold-cdn.xitu.io/conf/search.xml" type="application/opensearchdescription+xml"><link rel="stylesheet" href="https://b-gold-cdn.xitu.io/ionicons/2.0.1/css/ionicons.min.css"><link rel="stylesheet" href="https://b-gold-cdn.xitu.io/asset/fw-icon/1.0.9/iconfont.css"><link href="https://b-gold-cdn.xitu.io/v3/static/css/app.37151bbb8a40894c7953daf9b02b2ff7.css" rel="stylesheet"><script async="" src="https://hm.baidu.com/hm.js?93bbd335a208870aa1f296bcd6842e5e"></script><script async="" src="//www.google-analytics.com/analytics.js"></script><script type="text/javascript" async="" src="https://assets.growingio.com/vds.js"></script><script type="text/javascript" charset="utf-8" async="" src="https://b-gold-cdn.xitu.io/v3/static/js/3.f84ea6333e04793cc1e2.js"></script></head><body><div id="juejin" data-v-6ede48a3=""><div class="global-component-box" data-v-6ede48a3=""><!----><div data-v-2840e9c3="" data-v-6ede48a3="" class="alert-list alert-list"></div><div data-v-6ddb54c6="" data-v-6ede48a3="" class="suspension-panel suspension-panel"><button data-v-6ddb54c6="" title="å›åˆ°é¡¶éƒ¨" class="btn to-top-btn" style="display: none;"><i data-v-6ddb54c6="" class="ion-android-arrow-dropup"></i></button><button data-v-6ddb54c6="" title="å»ºè®®åé¦ˆ" class="btn meiqia-btn" style=""><i data-v-6ddb54c6="" class="ion-chatbubble-working"></i></button></div><!----><!----><div class="emoji-barrage" data-v-475389e2="" data-v-6ede48a3=""><!----></div><div class="book-new-user-award-popup" style="display: none;" data-v-7c95f01f="" data-v-6ede48a3=""><div class="content-box" style="display:;" data-v-7c95f01f=""><div class="close ion-close-round" data-v-7c95f01f=""></div><div class="header" data-v-7c95f01f=""><div class="icon" data-v-7c95f01f=""><img src="https://b-gold-cdn.xitu.io/v3/static/img/icon.a87e5ae.svg" data-v-7c95f01f=""></div><div class="txt" data-v-7c95f01f="">æ–°äººä¸“äº«å¥½ç¤¼</div></div><div class="desc" data-v-7c95f01f="">å‡¡æœªè´­ä¹°è¿‡å°å†Œçš„ç”¨æˆ·ï¼Œå‡å¯é¢†å–ä¸‰å¼  5 æŠ˜æ–°äººä¸“äº«åˆ¸ï¼Œè´­ä¹°å°å†Œæ—¶è‡ªåŠ¨ä½¿ç”¨ä¸“äº«åˆ¸ï¼Œæœ€é«˜å¯èŠ‚çœ 45 å…ƒã€‚</div><div class="tickets" data-v-7c95f01f=""><div class="ticket" data-v-7c95f01f=""><div class="ticket__inner" data-v-7c95f01f=""><div class="enjoy" data-v-7c95f01f=""><span class="new-title" data-v-7c95f01f="">å°å†Œæ–°äºº 5 æŠ˜åˆ¸</span></div><div class="sale" data-v-7c95f01f="">æœ€é«˜å¯çœ 15 å…ƒ</div></div></div><div class="ticket" data-v-7c95f01f=""><div class="ticket__inner" data-v-7c95f01f=""><div class="enjoy" data-v-7c95f01f=""><span class="new-title" data-v-7c95f01f="">å°å†Œæ–°äºº 5 æŠ˜åˆ¸</span></div><div class="sale" data-v-7c95f01f="">æœ€é«˜å¯çœ 15 å…ƒ</div></div></div><div class="ticket" data-v-7c95f01f=""><div class="ticket__inner" data-v-7c95f01f=""><div class="enjoy" data-v-7c95f01f=""><span class="new-title" data-v-7c95f01f="">å°å†Œæ–°äºº 5 æŠ˜åˆ¸</span></div><div class="sale" data-v-7c95f01f="">æœ€é«˜å¯çœ 15 å…ƒ</div></div></div></div><div class="remark" data-v-7c95f01f="">æ³¨ï¼šä¸“äº«åˆ¸çš„ä½¿ç”¨æœŸé™åœ¨é¢†åˆ¸çš„ä¸ƒå¤©å†…ã€‚</div><div class="submit-btn" data-v-7c95f01f="">ä¸€é”®é¢†å–</div></div><div class="model success" style="display: none;" data-v-7c95f01f=""><div class="heading" data-v-7c95f01f="">é¢†å–æˆåŠŸ</div><div class="content-text" data-v-7c95f01f="">è´­ä¹°å°å†Œæ—¶è‡ªåŠ¨ä½¿ç”¨ä¸“äº«åˆ¸</div><div class="btn-success-footer" data-v-7c95f01f=""><div class="btn-ok" data-v-7c95f01f="">çŸ¥é“äº†</div><div class="btn-ok btn-link" data-v-7c95f01f="">å‰å¾€å°å†Œé¦–é¡µ</div></div></div><div class="model fail" style="display: none;" data-v-7c95f01f=""><div class="heading" data-v-7c95f01f="">é¢†å–å¤±è´¥</div><div class="content-text" data-v-7c95f01f="">æœ¬æ´»åŠ¨ä»…é€‚ç”¨äºå°å†Œæ–°ç”¨æˆ·</div><div class="btn-ok" data-v-7c95f01f="">çŸ¥é“äº†</div></div></div><!----></div><!----><div data-v-3f216172="" data-v-41d33d72="" data-v-6ede48a3="" class="view-container"><div data-v-3f216172="" class="main-header-box"><header data-v-5ce25e66="" data-v-3f216172="" class="main-header main-header unauthorized visible"><div data-v-5ce25e66="" class="container"><a data-v-5ce25e66="" href="/" class="logo"><img data-v-5ce25e66="" src="https://b-gold-cdn.xitu.io/v3/static/img/logo.a7995ad.svg" alt="æ˜é‡‘" class="logo-img"></a><nav data-v-5ce25e66="" role="navigation" class="main-nav"><ul data-v-5ce25e66="" class="nav-list"><li data-v-5ce25e66="" class="main-nav-list"><div data-v-5ce25e66="" class="phone-show-menu"><span data-v-5ce25e66="">é¦–é¡µ</span><div data-v-5ce25e66="" class="icon ion-arrow-down-b"></div></div><ul data-v-5ce25e66="" class="phone-hide"><li data-v-5ce25e66="" class="nav-item link-item route-active"><a data-v-5ce25e66="" href="/">é¦–é¡µ</a></li><li data-v-5ce25e66="" class="nav-item link-item pin"><a data-v-5ce25e66="" href="/pins">æ²¸ç‚¹</a><!----></li><li data-v-5ce25e66="" class="nav-item link-item book"><a data-v-5ce25e66="" href="/books">å°å†Œ</a></li><li data-v-5ce25e66="" class="nav-item link-item"><a data-v-5ce25e66="" href="/repos">å¼€æºåº“</a></li><li data-v-5ce25e66="" class="nav-item link-item"><a data-v-5ce25e66="" href="/events/all">æ´»åŠ¨</a></li><li data-v-5ce25e66="" class="nav-item link-item conf"><a data-v-5ce25e66="" st:name="confGif" title="æ˜é‡‘å¼€å‘è€…å¤§ä¼š Â· å¾®ä¿¡å°ç¨‹åºä¸“åœº" target="_blank" href="https://conf.juejin.im/2018/mini-programs"><img data-v-5ce25e66="" src="https://b-gold-cdn.xitu.io/v3/static/img/conf.78960f5.gif" alt="æ˜é‡‘å¼€å‘è€…å¤§ä¼š Â· å¾®ä¿¡å°ç¨‹åºä¸“åœº" class="conf-icon"></a></li></ul></li><li data-v-5ce25e66="" class="nav-item search"><form data-v-5ce25e66="" role="search" class="search-form"><input data-v-5ce25e66="" maxlength="32" placeholder="æœç´¢æ˜é‡‘" class="search-input"><img data-v-5ce25e66="" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjJweCIgaGVpZ2h0PSIyMnB4IiB2aWV3Qm94PSIwIDAgMjIgMjIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogc2tldGNodG9vbCA0MS4yICgzNTM5NykgLSBodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2ggLS0+CiAgICA8dGl0bGU+Qjk3RUIxMEEtOEYzNC00QUI1LUFCQUYtNDFEOTMzNzQxRUQwPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBza2V0Y2h0b29sLjwvZGVzYz4KICAgIDxkZWZzPjwvZGVmcz4KICAgIDxnIGlkPSLpppbpobUiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSLlr7zoiKrmoI/mkJzntKLmoYYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC05OTAuMDAwMDAwLCAtMTkuMDAwMDAwKSIgZmlsbD0iI0MzQ0NENSI+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOTkwLjAwMDAwMCwgMTkuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMTIuOTg2MTI2LDE0LjQwMDMzOTUgTDE2LjI5Mjg5MzIsMTcuNzA3MTA2OCBDMTYuNjgzNDE3NSwxOC4wOTc2MzExIDE3LjMxNjU4MjUsMTguMDk3NjMxMSAxNy43MDcxMDY4LDE3LjcwNzEwNjggQzE4LjA5NzYzMTEsMTcuMzE2NTgyNSAxOC4wOTc2MzExLDE2LjY4MzQxNzUgMTcuNzA3MTA2OCwxNi4yOTI4OTMyIEwxNC40MDAzMzk1LDEyLjk4NjEyNiBDMTUuOTYwMzg4MSwxMC43NTczMjk4IDE1Ljc0NTI0MDIsNy42NjQwMTk4MyAxMy43NTQ4OTU5LDUuNjczNjc1NTQgQzExLjUyMzMyODUsMy40NDIxMDgxNSA3LjkwNTI0MjkyLDMuNDQyMTA4MTUgNS42NzM2NzU1NCw1LjY3MzY3NTU0IEMzLjQ0MjEwODE1LDcuOTA1MjQyOTIgMy40NDIxMDgxNSwxMS41MjMzMjg1IDUuNjczNjc1NTQsMTMuNzU0ODk1OSBDNy42NjQwMTk4MywxNS43NDUyNDAyIDEwLjc1NzMyOTgsMTUuOTYwMzg4MSAxMi45ODYxMjYsMTQuNDAwMzM5NSBaIE03LjA4Nzg4OTEsMTIuMzQwNjgyMyBDNS42MzczNzAzLDEwLjg5MDE2MzUgNS42MzczNzAzLDguNTM4NDA3OSA3LjA4Nzg4OTEsNy4wODc4ODkxIEM4LjUzODQwNzksNS42MzczNzAzIDEwLjg5MDE2MzUsNS42MzczNzAzIDEyLjM0MDY4MjMsNy4wODc4ODkxIEMxMy43OTEyMDExLDguNTM4NDA3OSAxMy43OTEyMDExLDEwLjg5MDE2MzUgMTIuMzQwNjgyMywxMi4zNDA2ODIzIEMxMC44OTAxNjM1LDEzLjc5MTIwMTEgOC41Mzg0MDc5LDEzLjc5MTIwMTEgNy4wODc4ODkxLDEyLjM0MDY4MjMgWiIgaWQ9IkNvbWJpbmVkLVNoYXBlIj48L3BhdGg+CiAgICAgICAgICAgIDwvZz4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="æœç´¢" class="search-icon"></form></li><!----><!----><!----><li data-v-5ce25e66="" class="nav-item submit"><img data-v-5ce25e66="" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjJweCIgaGVpZ2h0PSIyMnB4IiB2aWV3Qm94PSIwIDAgMjIgMjIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogc2tldGNodG9vbCA0MiAoMzY3ODEpIC0gaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoIC0tPgogICAgPHRpdGxlPjA1Q0I0NzU5LUIyRkQtNDcxOC04RTBDLTg0OEVCNzQ2RDAyMzwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggc2tldGNodG9vbC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xIiB4PSIyMzgiIHk9IjEyOCIgd2lkdGg9IjcwMCIgaGVpZ2h0PSI1MCIgcng9IjIiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci0yIj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd09mZnNldE91dGVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMSIgaW49InNoYWRvd09mZnNldE91dGVyMSIgcmVzdWx0PSJzaGFkb3dCbHVyT3V0ZXIxIj48L2ZlR2F1c3NpYW5CbHVyPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC4wNTAyNzE3MzkxIDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0JsdXJPdXRlcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0zIiB4PSI0IiB5PSI0IiB3aWR0aD0iMTMiIGhlaWdodD0iMTQiIHJ4PSIyIj48L3JlY3Q+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxMyIgaGVpZ2h0PSIxNCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSLpppbpobUiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSLpppbpobUyX0NvX+aZrumAmueUqOaItyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTMwNS4wMDAwMDAsIC0xNDIuMDAwMDAwKSI+CiAgICAgICAgICAgIDxnIGlkPSJDb21iaW5lZC1TaGFwZSI+CiAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItMikiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0zMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzA1LjAwMDAwMCwgMTQyLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0zIiB4PSIwIiB5PSIwIiB3aWR0aD0iMjIiIGhlaWdodD0iMjIiPjwvcmVjdD4KICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik05Ljg5NTY2MjY1LDkuMzQ2Mjc4MzIgTDYuNjY3NTA3MzEsOS4zNDYyNzgzMiBDNi4zNzA1MDcxNyw5LjM0NjI3ODMyIDYuMTI5NDQ5ODQsOS4xMDI3MDQ4MiA2LjEyOTQ0OTg0LDguODAyNTc4MzYgQzYuMTI5NDQ5ODQsOC41MDI0NzMxNyA2LjM3MDUwNzE3LDguMjU4ODk5NjggNi42Njc1MDczMSw4LjI1ODg5OTY4IEw5Ljg5NTY4MzcxLDguMjU4ODk5NjggQzEwLjE5MjYyMDcsOC4yNTg4OTk2OCAxMC40MzM2NTcsOC41MDI0NzMxNyAxMC40MzM2NTcsOC44MDI1NzgzNiBDMTAuNDMzNjM1OSw5LjEwMjcwNDgyIDEwLjE5MjU5OTYsOS4zNDYyNzgzMiA5Ljg5NTY2MjY1LDkuMzQ2Mjc4MzIgTTEzLjExMzIzNzEsMTIuNjA4NDE0MiBMNi42NjY2OTgyLDEyLjYwODQxNDIgQzYuMzcwMTQ0NjcsMTIuNjA4NDE0MiA2LjEyOTQ0OTg0LDEyLjM2NTQwNTcgNi4xMjk0NDk4NCwxMi4wNjQ3NTY4IEM2LjEyOTQ0OTg0LDExLjc2NDAyMjkgNi4zNzAxNDQ2NywxMS41MjEwMzU2IDYuNjY2Njk4MiwxMS41MjEwMzU2IEwxMy4xMTMyMzcxLDExLjUyMTAzNTYgQzEzLjQxMDI3NDEsMTEuNTIxMDM1NiAxMy42NTA0ODU0LDExLjc2NDAyMjkgMTMuNjUwNDg1NCwxMi4wNjQ3NTY4IEMxMy42NTA0ODU0LDEyLjM2NTM4NDQgMTMuNDEwMjc0MSwxMi42MDg0MTQyIDEzLjExMzIzNzEsMTIuNjA4NDE0MiIgaWQ9Imljb25mb250LWJpYW5qaSIgZmlsbD0iIzAwN0ZGRiI+PC9wYXRoPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iUmVjdGFuZ2xlIiBzdHJva2U9IiMwMDdGRkYiIG1hc2s9InVybCgjbWFzay00KSIgc3Ryb2tlLXdpZHRoPSIyIiB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" class="icon"><span data-v-5ce25e66="">å†™æ–‡ç« </span><!----></li><li data-v-5ce25e66="" class="nav-item auth"><span data-v-5ce25e66="" class="login">ç™»å½•</span><span data-v-5ce25e66="" class="register">æ³¨å†Œ</span></li></ul></nav></div></header></div><main data-v-3f216172="" class="container main-container"><div data-v-41d33d72="" data-v-3f216172="" class="view entry-public-view"><div data-v-41d33d72="" data-v-3f216172="" class="entry-public-main shadow"><!----><!----><article data-v-41d33d72="" itemscope="itemscope" itemtype="http://schema.org/Article" class="entry-content-box" data-v-3f216172=""><meta itemprop="url" content="https://juejin.im/entry/5bcba5826fb9a05d353cb019"><meta itemprop="headline" content="åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰"><meta itemprop="keywords" content="Java"><meta itemprop="datePublished" content="2018-10-20T22:00:34.634Z"><meta itemprop="image" content="https://b-gold-cdn.xitu.io/icon/icon-128.png"><div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Javaå…¬ä¼—å·_èŠ‹é“æºç _æ¯æ—¥æ›´æ–°"><meta itemprop="url" content="https://juejin.im/user/5904c637b123db3ee479d923"></div><div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"><div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://b-gold-cdn.xitu.io/icon/icon-white-180.png"><meta itemprop="width" content="180"><meta itemprop="height" content="180"></div></div><h1 data-v-41d33d72="">åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰</h1><div data-v-41d33d72="" class="entry-public-info"><div data-v-41d33d72="" class="text-muted info-item">é˜…è¯» 1781</div><div data-v-41d33d72="" class="text-muted info-item">æ”¶è— 22</div><div data-v-41d33d72="" class="text-muted info-item">2018-10-21</div></div><div data-v-41d33d72="" class="originalUrl">åŸæ–‡é“¾æ¥ï¼š<a data-v-41d33d72="" st:name="originLink" href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%3Fjuejin%262018-10-21" rel="nofollow noopener noreferrer" target="_blank">www.iocoder.cn</a></div><a data-v-41d33d72="" class="banner" href="https://cloud.tencent.com/act/special/amd?fromSource=gwzcw.1351356.1351356.1351356" rel="nofollow noopener noreferrer" target="_blank"><span data-v-41d33d72="" class="text">AMD CPUäº‘æœåŠ¡å™¨å…¨å›½é¦–æ¨</span><span data-v-41d33d72="" class="link">cloud.tencent.com</span></a><div data-v-41d33d72="" itemprop="articleBody" class="entry-content article-content"> <a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FDubbo%2Fgood-collection%2F%3Ftitle" target="_blank" rel="nofollow noopener noreferrer">è‡ªæˆ‘è¡¨æ‰¬ï¼šã€ŠDubbo å®ç°åŸç†ä¸æºç è§£æ â€”â€” ç²¾å“åˆé›†ã€‹</a> <br> <a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FEntity%2Fgood-collection%2F%3Ftitle" target="_blank" rel="nofollow noopener noreferrer">è¡¨æ‰¬è‡ªå·±ï¼šã€ŠDæ•°æ®åº“å®ä½“è®¾è®¡åˆé›†ã€‹</a>
    <p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">www.iocoder.cn/RocketMQ/meâ€¦</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p>
    <p><strong>æœ¬æ–‡ä¸»è¦åŸºäº RocketMQ 4.0.x æ­£å¼ç‰ˆ</strong> </p>
    <ul>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">1ã€æ¦‚è¿°</a></li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">2ã€Consumer</a></li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">3ã€PushConsumer ä¸€è§ˆ</a></li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">4ã€PushConsumer è®¢é˜…</a>
            <ul>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">DefaultMQPushConsumerImpl#subscribe(â€¦)</a>
                    <ul>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">FilterAPI.buildSubscriptionData(â€¦)</a></li>
                    </ul>
                </li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">DefaultMQPushConsumer#registerMessageListener(â€¦)</a></li>
            </ul>
        </li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</a>
            <ul>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RebalanceService</a></li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">MQClientInstance#doRebalance(â€¦)</a></li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">DefaultMQPushConsumerImpl#doRebalance(â€¦)</a></li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RebalanceImpl#doRebalance(â€¦)</a>
                    <ul>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RebalanceImpl#rebalanceByTopic(â€¦)</a></li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RebalanceImpl#removeUnnecessaryMessageQueue(â€¦)</a>
                            <ul>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)</a></li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(â€¦)</a></li>
                            </ul>
                        </li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RebalancePushImpl#dispatchPullRequest(â€¦)</a>
                            <ul>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">DefaultMQPushConsumerImpl#executePullRequestImmediately(â€¦)</a></li>
                            </ul>
                        </li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">AllocateMessageQueueStrategy</a>
                            <ul>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">AllocateMessageQueueAveragely</a></li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">AllocateMessageQueueByMachineRoom</a></li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">AllocateMessageQueueAveragelyByCircle</a></li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">AllocateMessageQueueByConfig</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</a>
            <ul>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RebalancePushImpl#computePullFromWhere(â€¦)</a></li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">[PullConsumer] RebalancePullImpl#computePullFromWhere(â€¦)</a></li>
            </ul>
        </li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</a>
            <ul>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">PullMessageService</a></li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">DefaultMQPushConsumerImpl#pullMessage(â€¦)</a>
                    <ul>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">PullAPIWrapper#pullKernelImpl(â€¦)</a>
                            <ul>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">PullAPIWrapper#recalculatePullFromWhichNode(â€¦)</a></li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">MQClientInstance#findBrokerAddressInSubscribe(â€¦)</a></li>
                            </ul>
                        </li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">PullAPIWrapper#processPullResult(â€¦)</a></li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ProcessQueue#putMessage(â€¦)</a></li>
                    </ul>
                </li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">æ€»ç»“</a></li>
            </ul>
        </li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</a>
            <ul>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</a>
                    <ul>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ConsumeMessageConcurrentlyService#submitConsumeRequest(â€¦)</a></li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</a></li>
                    </ul>
                </li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ConsumeRequest</a></li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)</a>
                    <ul>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ProcessQueue#removeMessage(â€¦)</a></li>
                    </ul>
                </li>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ConsumeMessageConcurrentlyService#cleanExpireMsg(â€¦)</a>
                    <ul>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">ProcessQueue#cleanExpiredMsg(â€¦)</a></li>
                    </ul>
                </li>
            </ul>
        </li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</a>
            <ul>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">DefaultMQPushConsumerImpl#sendMessageBack(â€¦)</a>
                    <ul>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">MQClientAPIImpl#consumerSendMessageBack(â€¦)</a></li>
                    </ul>
                </li>
            </ul>
        </li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">8ã€Consumer æ¶ˆè´¹è¿›åº¦</a>
            <ul>
                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">OffsetStore</a>
                    <ul>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">OffsetStore#load(â€¦)</a>
                            <ul>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">LocalFileOffsetStore#load(â€¦)</a>
                                    <ul>
                                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">OffsetSerializeWrapper</a></li>
                                    </ul>
                                </li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RemoteBrokerOffsetStore#load(â€¦)</a></li>
                            </ul>
                        </li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">OffsetStore#readOffset(â€¦)</a>
                            <ul>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">LocalFileOffsetStore#readOffset(â€¦)</a></li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RemoteBrokerOffsetStore#readOffset(â€¦)</a></li>
                            </ul>
                        </li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">OffsetStore#updateOffset(â€¦)</a></li>
                        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">OffsetStore#persistAll(â€¦)</a>
                            <ul>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">LocalFileOffsetStore#persistAll(â€¦)</a></li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">RemoteBrokerOffsetStore#persistAll(â€¦)</a></li>
                                <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">MQClientInstance#persistAllConsumerOffset(â€¦)</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li><a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-second%2F" target="_blank" rel="nofollow noopener noreferrer">9ã€ç»“å°¾</a></li>
    </ul>
    <hr>
    <p><img alt="" class="lazyload inited" data-src="https://user-gold-cdn.xitu.io/2018/10/18/166840b9b5db2e09?imageView2/0/w/1280/h/960/ignore-error/1" data-width="1280" data-height="536" src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;1280&quot; height=&quot;536&quot;&gt;&lt;/svg&gt;"></p>
    <blockquote>
        <p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š </p>
        <ol>
            <li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨ </li>
            <li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong> </li>
            <li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚ </li>
            <li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚ </li>
            <li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
        </ol>
    </blockquote>
    <hr>
    <h1 id="1ã€æ¦‚è¿°" data-id="heading-0"><a href="#1ã€æ¦‚è¿°" title="1ã€æ¦‚è¿°"></a>1ã€æ¦‚è¿°</h1>
    <p>æœ¬æ–‡æ¥ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-first%2F" target="_blank" rel="nofollow noopener noreferrer">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ã€‹</a>ã€‚</p>
    <p>ä¸»è¦è§£æ <code>Consumer</code> åœ¨ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚</p>
    <h1 id="2ã€Consumer" data-id="heading-1"><a href="#2ã€Consumer" title="2ã€Consumer"></a>2ã€Consumer</h1>
    <p>MQ æä¾›äº†ä¸¤ç±»æ¶ˆè´¹è€…ï¼š</p>
    <ul>
        <li>PushConsumerï¼š
            <ul>
                <li>åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ä½¿ç”¨ã€‚</li>
                <li>åå­—è™½ç„¶æ˜¯ <code>Push</code> å¼€å¤´ï¼Œå®é™…åœ¨å®ç°æ—¶ï¼Œä½¿ç”¨ <code>Pull</code> æ–¹å¼å®ç°ã€‚é€šè¿‡ <code>Pull</code> <strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>è½®è¯¢ <code>Broker</code> è·å–æ¶ˆæ¯ã€‚å½“ä¸å­˜åœ¨æ–°æ¶ˆæ¯æ—¶ï¼Œ<code>Broker</code> ä¼š<strong>æŒ‚èµ·è¯·æ±‚</strong>ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯äº§ç”Ÿï¼Œå–æ¶ˆæŒ‚èµ·ï¼Œè¿”å›æ–°æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒåŸºæœ¬å’Œ <code>Broker</code> ä¸»åŠ¨ <code>Push</code>                    åšåˆ°<strong>æ¥è¿‘</strong>çš„å®æ—¶æ€§ï¼ˆå½“ç„¶ï¼Œè¿˜æ˜¯æœ‰ç›¸åº”çš„å®æ—¶æ€§æŸå¤±ï¼‰ã€‚åŸç†ç±»ä¼¼ <a href="https://link.juejin.im?target=https%3A%2F%2Fwww.ibm.com%2Fdeveloperworks%2Fcn%2Fweb%2Fwa-lo-comet%2F" target="_blank" rel="nofollow noopener noreferrer">é•¿è½®è¯¢( <code>Long-Polling</code> )</a>ã€‚</li>
            </ul>
        </li>
        <li>PullConsumer</li>
    </ul>
    <p>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚<br><strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br><strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong>        </p>
    <h1 id="3ã€PushConsumer-ä¸€è§ˆ" data-id="heading-2"><a href="#3ã€PushConsumer-ä¸€è§ˆ" title="3ã€PushConsumer ä¸€è§ˆ"></a>3ã€PushConsumer ä¸€è§ˆ</h1>
    <p>å…ˆçœ‹ä¸€å¼  <code>PushConsumer</code> åŒ…å«çš„ç»„ä»¶ä»¥åŠç»„ä»¶ä¹‹é—´çš„äº¤äº’å›¾ï¼š</p>
    <p><img alt="PushConsumeræ‰‹ç»˜å›¾.png" class="lazyload inited" data-src="https://user-gold-cdn.xitu.io/2018/10/21/166937eae560d8ac?imageView2/0/w/1280/h/960/ignore-error/1" data-width="1280" data-height="1151" src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;1280&quot; height=&quot;1151&quot;&gt;&lt;/svg&gt;"></p>
    <ul>
        <li><code>RebalanceService</code>ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚å½“æœ‰æ–°çš„ <code>Consumer</code> çš„åŠ å…¥æˆ–ç§»é™¤ï¼Œéƒ½ä¼šé‡æ–°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
        <li><code>PullMessageService</code>ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li>
        <li><code>ConsumeMessageService</code>ï¼šæ¶ˆè´¹æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>
        <li><code>RemoteBrokerOffsetStore</code>ï¼š<code>Consumer</code> æ¶ˆè´¹è¿›åº¦ç®¡ç†ï¼Œè´Ÿè´£ä» <code>Broker</code> è·å–æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li>
        <li><code>ProcessQueue</code> ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚</li>
        <li><code>MQClientInstance</code> ï¼šå°è£…å¯¹ <code>Namesrv</code>ï¼Œ<code>Broker</code> çš„ APIè°ƒç”¨ï¼Œæä¾›ç»™ <code>Producer</code>ã€<code>Consumer</code> ä½¿ç”¨ã€‚</li>
    </ul>
    <h1 id="4ã€PushConsumer-è®¢é˜…" data-id="heading-3"><a href="#4ã€PushConsumer-è®¢é˜…" title="4ã€PushConsumer è®¢é˜…"></a>4ã€PushConsumer è®¢é˜…</h1>
    <h2 id="DefaultMQPushConsumerImpl-subscribe-â€¦" data-id="heading-4"><a href="#DefaultMQPushConsumerImpl-subscribe-â€¦" title="DefaultMQPushConsumerImpl#subscribe(â€¦)"></a>DefaultMQPushConsumerImpl#subscribe(â€¦)</h2>
    <pre><code> 1: public void subscribe(String topic, String subExpression) throws MQClientException {
 2:     try {
 3:         // åˆ›å»ºè®¢é˜…æ•°æ®
 4:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(this.defaultMQPushConsumer.getConsumerGroup(), //
 5:             topic, subExpression);
 6:         this.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);
 7:         // é€šè¿‡å¿ƒè·³åŒæ­¥Consumerä¿¡æ¯åˆ°Broker
 8:         if (this.mQClientFactory != null) {
 9:             this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();
10:         }
11:     } catch (Exception e) {
12:         throw new MQClientException("subscription exception", e);
13:     }
14: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šè®¢é˜… <code>Topic</code> ã€‚</li>
        <li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šåˆ›å»ºè®¢é˜…æ•°æ®ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#filterapibuildsubscriptiondata">FilterAPI.buildSubscriptionData(â€¦)</a>ã€‚</li>
        <li>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šé€šè¿‡å¿ƒè·³åŒæ­¥ <code>Consumer</code> ä¿¡æ¯åˆ° <code>Broker</code>ã€‚</li>
    </ul>
    <h3 id="FilterAPI-buildSubscriptionData-â€¦" data-id="heading-5"><a href="#FilterAPI-buildSubscriptionData-â€¦" title="FilterAPI.buildSubscriptionData(â€¦)"></a>FilterAPI.buildSubscriptionData(â€¦)</h3>
    <pre><code> 1: public static SubscriptionData buildSubscriptionData(final String consumerGroup, String topic,
 2:     String subString) throws Exception {
 3:     SubscriptionData subscriptionData = new SubscriptionData();
 4:     subscriptionData.setTopic(topic);
 5:     subscriptionData.setSubString(subString);
 6:     // å¤„ç†è®¢é˜…è¡¨è¾¾å¼
 7:     if (null == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == 0) {
 8:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);
 9:     } else {
10:         String[] tags = subString.split("\\|\\|");
11:         if (tags.length &gt; 0) {
12:             for (String tag : tags) {
13:                 if (tag.length() &gt; 0) {
14:                     String trimString = tag.trim();
15:                     if (trimString.length() &gt; 0) {
16:                         subscriptionData.getTagsSet().add(trimString);
17:                         subscriptionData.getCodeSet().add(trimString.hashCode());
18:                     }
19:                 }
20:             }
21:         } else {
22:             throw new Exception("subString split error");
23:         }
24:     }
25: 
26:     return subscriptionData;
27: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæ ¹æ® <code>Topic</code> å’Œ è®¢é˜…è¡¨è¾¾å¼ åˆ›å»ºè®¢é˜…æ•°æ®</li>
        <li>subscriptionData.subVersion = System.currentTimeMillis()ã€‚</li>
    </ul>
    <h2 id="DefaultMQPushConsumer-registerMessageListener-â€¦" data-id="heading-6"><a href="#DefaultMQPushConsumer-registerMessageListener-â€¦" title="DefaultMQPushConsumer#registerMessageListener(â€¦)"></a>DefaultMQPushConsumer#registerMessageListener(â€¦)</h2>
    <pre><code>1: public void registerMessageListener(MessageListenerConcurrently messageListener) {
2:     this.messageListener = messageListener;
3:     this.defaultMQPushConsumerImpl.registerMessageListener(messageListener);
4: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ã€‚</li>
    </ul>
    <h1 id="5ã€PushConsumer-æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…" data-id="heading-7"><a href="#5ã€PushConsumer-æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…" title="5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…"></a>5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</h1>
    <p><img alt="RebalanceService&amp;PushConsumeråˆ†é…é˜Ÿåˆ—" class="lazyload inited" data-src="https://user-gold-cdn.xitu.io/2018/10/21/166937eae59622d8?imageView2/0/w/1280/h/960/ignore-error/1" data-width="1280" data-height="940" src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;1280&quot; height=&quot;940&quot;&gt;&lt;/svg&gt;"></p>
    <h2 id="RebalanceService" data-id="heading-8"><a href="#RebalanceService" title="RebalanceService"></a>RebalanceService</h2>
    <pre><code> 1: public class RebalanceService extends ServiceThread {
 2: 
 3:     /**
 4:      * ç­‰å¾…é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’
 5:      */
 6:     private static long waitInterval =
 7:         Long.parseLong(System.getProperty(
 8:             "rocketmq.client.rebalance.waitInterval", "20000"));
 9: 
10:     private final Logger log = ClientLogger.getLog();
11:     /**
12:      * MQClientå¯¹è±¡
13:      */
14:     private final MQClientInstance mqClientFactory;
15: 
16:     public RebalanceService(MQClientInstance mqClientFactory) {
17:         this.mqClientFactory = mqClientFactory;
18:     }
19: 
20:     @Override
21:     public void run() {
22:         log.info(this.getServiceName() + " service started");
23: 
24:         while (!this.isStopped()) {
25:             this.waitForRunning(waitInterval);
26:             this.mqClientFactory.doRebalance();
27:         }
28: 
29:         log.info(this.getServiceName() + " service end");
30:     }
31: 
32:     @Override
33:     public String getServiceName() {
34:         return RebalanceService.class.getSimpleName();
35:     }
36: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚</li>
        <li>
            <p>ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>MQClientInstance#doRebalance(...)</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç›®å‰æœ‰ä¸‰ç§æƒ…å†µæƒ…å†µä¸‹è§¦å‘ï¼š</p>
            <ul>
                <li>å¦‚ <code>ç¬¬ 25 è¡Œ</code> ç­‰å¾…è¶…æ—¶ï¼Œæ¯ 20s è°ƒç”¨ä¸€æ¬¡ã€‚</li>
                <li><code>PushConsumer</code> å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li>
                <li><code>Broker</code> é€šçŸ¥ <code>Consumer</code> åŠ å…¥ æˆ– ç§»é™¤æ—¶ï¼Œ<code>Consumer</code> å“åº”é€šçŸ¥ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li>
            </ul>
            <p>è¯¦ç»†è§£æè§ï¼š<a href="#mqclientinstancedorebalance">MQClientInstance#doRebalance(â€¦)</a>ã€‚</p>
        </li>
    </ul>
    <h2 id="MQClientInstance-doRebalance-â€¦" data-id="heading-9"><a href="#MQClientInstance-doRebalance-â€¦" title="MQClientInstance#doRebalance(â€¦)"></a>MQClientInstance#doRebalance(â€¦)</h2>
    <pre><code> 1: public void doRebalance() {
 2:     for (Map.Entry&lt;String, MQConsumerInner&gt; entry : this.consumerTable.entrySet()) {
 3:         MQConsumerInner impl = entry.getValue();
 4:         if (impl != null) {
 5:             try {
 6:                 impl.doRebalance();
 7:             } catch (Throwable e) {
 8:                 log.error("doRebalance exception", e);
 9:             }
10:         }
11:     }
12: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šéå†å½“å‰ <code>Client</code> åŒ…å«çš„ <code>consumerTable</code>( <code>Consumer</code>é›†åˆ )ï¼Œæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li>
        <li><strong>ç–‘é—®</strong>ï¼šç›®å‰ä»£ç è°ƒè¯•ä¸‹æ¥ï¼Œ<code>consumerTable</code> åªåŒ…å« <code>Consumer</code> è‡ªå·±ã€‚ğŸ˜ˆæœ‰å¤§å¤§å¯¹è¿™ä¸ªç–‘é—®æœ‰è§£ç­”çš„ï¼Œçƒ¦è¯·è§£ç­”ä¸‹ã€‚</li>
        <li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>MQConsumerInner#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚<code>DefaultMQPushConsumerImpl</code>ã€<code>DefaultMQPullConsumerImpl</code> åˆ†åˆ«å¯¹è¯¥æ¥å£æ–¹æ³•è¿›è¡Œäº†å®ç°ã€‚<code>DefaultMQPushConsumerImpl#doRebalance(...)</code> è¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fdefaultmqpushconsumerimpldorebalance" target="_blank" rel="nofollow noopener noreferrer">DefaultMQPushConsumerImpl#doRebalance(â€¦)</a>ã€‚</li>
    </ul>
    <h2 id="DefaultMQPushConsumerImpl-doRebalance-â€¦" data-id="heading-10"><a href="#DefaultMQPushConsumerImpl-doRebalance-â€¦" title="DefaultMQPushConsumerImpl#doRebalance(â€¦)"></a>DefaultMQPushConsumerImpl#doRebalance(â€¦)</h2>
    <pre><code>1: public void doRebalance() {
2:     if (!this.pause) {
3:         this.rebalanceImpl.doRebalance(this.isConsumeOrderly());
4:     }
5: }
</code></pre>
    <ul>
        <li>è¯´æ˜ï¼šæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li>
        <li>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>RebalanceImpl#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimpldorebalance">RebalancePushImpl#doRebalance(â€¦)</a>ã€‚</li>
    </ul>
    <h2 id="RebalanceImpl-doRebalance-â€¦" data-id="heading-11"><a href="#RebalanceImpl-doRebalance-â€¦" title="RebalanceImpl#doRebalance(â€¦)"></a>RebalanceImpl#doRebalance(â€¦)</h2>
    <pre><code> 1: /**
 2:  * æ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—
 3:  *
 4:  * @param isOrder æ˜¯å¦é¡ºåºæ¶ˆæ¯
 5:  */
 6: public void doRebalance(final boolean isOrder) {
 7:     // åˆ†é…æ¯ä¸ª topic çš„æ¶ˆæ¯é˜Ÿåˆ—
 8:     Map&lt;String, SubscriptionData&gt; subTable = this.getSubscriptionInner();
 9:     if (subTable != null) {
10:         for (final Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) {
11:             final String topic = entry.getKey();
12:             try {
13:                 this.rebalanceByTopic(topic, isOrder);
14:             } catch (Throwable e) {
15:                 if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
16:                     log.warn("rebalanceByTopic Exception", e);
17:                 }
18:             }
19:         }
20:     }
21:     // ç§»é™¤æœªè®¢é˜…çš„topicå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—
22:     this.truncateMessageQueueNotMyTopic();
23: }
24: 
25: /**
26:  * ç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—
27:  */
28: private void truncateMessageQueueNotMyTopic() {
29:     Map&lt;String, SubscriptionData&gt; subTable = this.getSubscriptionInner();
30:     for (MessageQueue mq : this.processQueueTable.keySet()) {
31:         if (!subTable.containsKey(mq.getTopic())) {
32: 
33:             ProcessQueue pq = this.processQueueTable.remove(mq);
34:             if (pq != null) {
35:                 pq.setDropped(true);
36:                 log.info("doRebalance, {}, truncateMessageQueueNotMyTopic remove unnecessary mq, {}", consumerGroup, mq);
37:             }
38:         }
39:     }
40: }
</code></pre>
    <ul>
        <li><code>#doRebalance(...)</code> è¯´æ˜ ï¼šæ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚
            <ul>
                <li>ç¬¬ 7 è‡³ 20 è¡Œ ï¼šå¾ªç¯è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œåˆ†é…æ¯ä¸€ä¸ª <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
                <li>ç¬¬ 22 è¡Œ ï¼šç§»é™¤æœªè®¢é˜…çš„ <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
            </ul>
        </li>
        <li><code>#truncateMessageQueueNotMyTopic(...)</code> è¯´æ˜ ï¼šç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚å½“è°ƒç”¨ <code>DefaultMQPushConsumer#unsubscribe(topic)</code> æ—¶ï¼Œåªç§»é™¤è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œå¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—ç§»é™¤åœ¨è¯¥æ–¹æ³•ã€‚</li>
    </ul>
    <h3 id="RebalanceImpl-rebalanceByTopic-â€¦" data-id="heading-12"><a href="#RebalanceImpl-rebalanceByTopic-â€¦" title="RebalanceImpl#rebalanceByTopic(â€¦)"></a>RebalanceImpl#rebalanceByTopic(â€¦)</h3>
    <pre><code>  1: private void rebalanceByTopic(final String topic, final boolean isOrder) {
  2:     switch (messageModel) {
  3:         case BROADCASTING: {
  4:             Set&lt;MessageQueue&gt; mqSet = this.topicSubscribeInfoTable.get(topic);
  5:             if (mqSet != null) {
  6:                 boolean changed = this.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);
  7:                 if (changed) {
  8:                     this.messageQueueChanged(topic, mqSet, mqSet);
  9:                     log.info("messageQueueChanged {} {} {} {}", //
 10:                         consumerGroup, //
 11:                         topic, //
 12:                         mqSet, //
 13:                         mqSet);
 14:                 }
 15:             } else {
 16:                 log.warn("doRebalance, {}, but the topic[{}] not exist.", consumerGroup, topic);
 17:             }
 18:             break;
 19:         }
 20:         case CLUSTERING: {
 21:             // è·å– topic å¯¹åº”çš„ é˜Ÿåˆ— å’Œ consumerä¿¡æ¯
 22:             Set&lt;MessageQueue&gt; mqSet = this.topicSubscribeInfoTable.get(topic);
 23:             List&lt;String&gt; cidAll = this.mQClientFactory.findConsumerIdList(topic, consumerGroup);
 24:             if (null == mqSet) {
 25:                 if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
 26:                     log.warn("doRebalance, {}, but the topic[{}] not exist.", consumerGroup, topic);
 27:                 }
 28:             }
 29: 
 30:             if (null == cidAll) {
 31:                 log.warn("doRebalance, {} {}, get consumer id list failed", consumerGroup, topic);
 32:             }
 33: 
 34:             if (mqSet != null &amp;&amp; cidAll != null) {
 35:                 // æ’åº æ¶ˆæ¯é˜Ÿåˆ— å’Œ æ¶ˆè´¹è€…æ•°ç»„ã€‚å› ä¸ºæ˜¯åœ¨Clientè¿›è¡Œåˆ†é…é˜Ÿåˆ—ï¼Œæ’åºåï¼Œå„Clientçš„é¡ºåºæ‰èƒ½ä¿æŒä¸€è‡´ã€‚
 36:                 List&lt;MessageQueue&gt; mqAll = new ArrayList&lt;&gt;();
 37:                 mqAll.addAll(mqSet);
 38: 
 39:                 Collections.sort(mqAll);
 40:                 Collections.sort(cidAll);
 41: 
 42:                 AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;
 43: 
 44:                 // æ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥ åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—
 45:                 List&lt;MessageQueue&gt; allocateResult;
 46:                 try {
 47:                     allocateResult = strategy.allocate(//
 48:                         this.consumerGroup, //
 49:                         this.mQClientFactory.getClientId(), //
 50:                         mqAll, //
 51:                         cidAll);
 52:                 } catch (Throwable e) {
 53:                     log.error("AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}", strategy.getName(),
 54:                         e);
 55:                     return;
 56:                 }
 57: 
 58:                 Set&lt;MessageQueue&gt; allocateResultSet = new HashSet&lt;&gt;();
 59:                 if (allocateResult != null) {
 60:                     allocateResultSet.addAll(allocateResult);
 61:                 }
 62: 
 63:                 // æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—
 64:                 boolean changed = this.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);
 65:                 if (changed) {
 66:                     log.info(
 67:                         "rebalanced result changed. allocateMessageQueueStrategyName={}, group={}, topic={}, clientId={}, mqAllSize={}, cidAllSize={}, rebalanceResultSize={}, rebalanceResultSet={}",
 68:                         strategy.getName(), consumerGroup, topic, this.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),
 69:                         allocateResultSet.size(), allocateResultSet);
 70:                     this.messageQueueChanged(topic, mqSet, allocateResultSet);
 71:                 }
 72:             }
 73:             break;
 74:         }
 75:         default:
 76:             break;
 77:     }
 78: }
 79: 
 80: /**
 81:  * å½“è´Ÿè½½å‡è¡¡æ—¶ï¼Œæ›´æ–° æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
 82:  * - ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—
 83:  * - å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—
 84:  *
 85:  * @param topic Topic
 86:  * @param mqSet è´Ÿè½½å‡è¡¡ç»“æœåçš„æ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„
 87:  * @param isOrder æ˜¯å¦é¡ºåº
 88:  * @return æ˜¯å¦å˜æ›´
 89:  */
 90: private boolean updateProcessQueueTableInRebalance(final String topic, final Set&lt;MessageQueue&gt; mqSet, final boolean isOrder) {
 91:     boolean changed = false;
 92: 
 93:     // ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—
 94:     Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = this.processQueueTable.entrySet().iterator();
 95:     while (it.hasNext()) { // TODO å¾…è¯»ï¼š
 96:         Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();
 97:         MessageQueue mq = next.getKey();
 98:         ProcessQueue pq = next.getValue();
 99: 
100:         if (mq.getTopic().equals(topic)) {
101:             if (!mqSet.contains(mq)) { // ä¸åŒ…å«çš„é˜Ÿåˆ—
102:                 pq.setDropped(true);
103:                 if (this.removeUnnecessaryMessageQueue(mq, pq)) {
104:                     it.remove();
105:                     changed = true;
106:                     log.info("doRebalance, {}, remove unnecessary mq, {}", consumerGroup, mq);
107:                 }
108:             } else if (pq.isPullExpired()) { // é˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†
109:                 switch (this.consumeType()) {
110:                     case CONSUME_ACTIVELY:
111:                         break;
112:                     case CONSUME_PASSIVELY:
113:                         pq.setDropped(true);
114:                         if (this.removeUnnecessaryMessageQueue(mq, pq)) {
115:                             it.remove();
116:                             changed = true;
117:                             log.error("[BUG]doRebalance, {}, remove unnecessary mq, {}, because pull is pause, so try to fixed it",
118:                                 consumerGroup, mq);
119:                         }
120:                         break;
121:                     default:
122:                         break;
123:                 }
124:             }
125:         }
126:     }
127: 
128:     // å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
129:     List&lt;PullRequest&gt; pullRequestList = new ArrayList&lt;&gt;(); // æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„
130:     for (MessageQueue mq : mqSet) {
131:         if (!this.processQueueTable.containsKey(mq)) {
132:             if (isOrder &amp;&amp; !this.lock(mq)) {
133:                 log.warn("doRebalance, {}, add a new mq failed, {}, because lock failed", consumerGroup, mq);
134:                 continue;
135:             }
136: 
137:             this.removeDirtyOffset(mq);
138:             ProcessQueue pq = new ProcessQueue();
139:             long nextOffset = this.computePullFromWhere(mq);
140:             if (nextOffset &gt;= 0) {
141:                 ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq);
142:                 if (pre != null) {
143:                     log.info("doRebalance, {}, mq already exists, {}", consumerGroup, mq);
144:                 } else {
145:                     log.info("doRebalance, {}, add a new mq, {}", consumerGroup, mq);
146:                     PullRequest pullRequest = new PullRequest();
147:                     pullRequest.setConsumerGroup(consumerGroup);
148:                     pullRequest.setNextOffset(nextOffset);
149:                     pullRequest.setMessageQueue(mq);
150:                     pullRequest.setProcessQueue(pq);
151:                     pullRequestList.add(pullRequest);
152:                     changed = true;
153:                 }
154:             } else {
155:                 log.warn("doRebalance, {}, add new mq failed, {}", consumerGroup, mq);
156:             }
157:         }
158:     }
159: 
160:     // å‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚
161:     this.dispatchPullRequest(pullRequestList);
162: 
163:     return changed;
164: }
</code></pre>
    <ul>
        <li><code>#rebalanceByTopic(...)</code> è¯´æ˜ ï¼šåˆ†é… <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
            <ul>
                <li>ç¬¬ 3 è‡³ 19 è¡Œ ï¼šå¹¿æ’­æ¨¡å¼( <code>BROADCASTING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>æ‰€æœ‰</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚ </li>
                <li>ç¬¬ 20 è‡³ 74 è¡Œ ï¼šé›†ç¾¤æ¨¡å¼( <code>CLUSTERING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>éƒ¨åˆ†</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚
                    <ul>
                        <li>ç¬¬ 21 è‡³ 40 è¡Œ ï¼šè·å– <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ä»¬ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ’åºã€‚å› ä¸ºå„ <code>Consumer</code> æ˜¯åœ¨æœ¬åœ°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ’åºåæ‰èƒ½ä¿è¯å„ <code>Consumer</code> é¡ºåºä¸€è‡´ã€‚</li>
                        <li>ç¬¬ 42 è‡³ 61 è¡Œ ï¼šæ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥( <code>AllocateMessageQueueStrategy</code> ) åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#allocatemessagequeuestrategy">AllocateMessageQueueStrategy</a>ã€‚</li>
                        <li>ç¬¬ 63 è‡³ 72 è¡Œ ï¼šæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
                    </ul>
                </li>
            </ul>
        </li>
        <li><code>#updateProcessQueueTableInRebalance(...)</code> è¯´æ˜ ï¼šå½“åˆ†é…é˜Ÿåˆ—æ—¶ï¼Œæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è¿”å›æ˜¯å¦æœ‰å˜æ›´ã€‚
            <ul>
                <li>ç¬¬ 93 è‡³ 126 è¡Œ ï¼šç§»é™¤ä¸å­˜åœ¨äºåˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) çš„ æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—( <code>processQueueTable</code> )ã€‚
                    <ul>
                        <li>ç¬¬ 103 è¡Œ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimplremoveunnecessarymessagequeue">RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)</a>ã€‚</li>
                        <li>ç¬¬ 108 è‡³ 120 è¡Œ ï¼šé˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œå³ <code>å½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶é—´ &gt; 120s</code> ( 120s å¯é…ç½®)ï¼Œåˆ¤å®šå‘ç”Ÿ <strong>BUG</strong>ï¼Œè¿‡ä¹…æœªè¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç§»é™¤åï¼Œä¸‹é¢<strong>#æ–°å¢é˜Ÿåˆ—é€»è¾‘#</strong>å¯ä»¥é‡æ–°åŠ å…¥æ–°çš„è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
                    </ul>
                </li>
                <li>ç¬¬ 128 è‡³ 158 è¡Œ ï¼šå¢åŠ  åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
                    <ul>
                        <li>ç¬¬ 132 è‡³ 135 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-send-and-consume-orderly%2F" target="_blank" rel="nofollow noopener noreferrer">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>
                        <li>ç¬¬ 137 è¡Œ ï¼šç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ã€‚</li>
                        <li>ç¬¬ 139 è¡Œ ï¼šè·å–é˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimplcomputepullfromwhere">RebalancePushImpl#computePullFromWhere(â€¦)</a>ã€‚</li>
                        <li>ç¬¬ 140 è‡³ 156 è¡Œ ï¼š<strong>æ·»åŠ æ–°æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ï¼Œæ·»åŠ æ¶ˆè´¹æ‹‰å–æ¶ˆæ¯è¯·æ±‚</strong>ã€‚</li>
                    </ul>
                </li>
                <li>ç¬¬ 161 è¡Œ ï¼š<strong>å‘èµ·æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯æ‹‰å–è¯·æ±‚</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#rebalancepushimpldispatchpullrequest">RebalancePushImpl#dispatchPullRequest(â€¦)</a>ã€‚</li>
            </ul>
        </li>
    </ul>
    <h3 id="RebalanceImpl-removeUnnecessaryMessageQueue-â€¦" data-id="heading-13"><a href="#RebalanceImpl-removeUnnecessaryMessageQueue-â€¦" title="RebalanceImpl#removeUnnecessaryMessageQueue(â€¦)"></a>RebalanceImpl#removeUnnecessaryMessageQueue(â€¦)</h3>
    <h4 id="RebalancePushImpl-removeUnnecessaryMessageQueue-â€¦" data-id="heading-14"><a href="#RebalancePushImpl-removeUnnecessaryMessageQueue-â€¦" title="RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)"></a>RebalancePushImpl#removeUnnecessaryMessageQueue(â€¦)</h4>
    <pre><code> 1: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {
 2:     // åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚
 3:     this.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);
 4:     this.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);
 5:     // TODO é¡ºåºæ¶ˆè´¹
 6:     if (this.defaultMQPushConsumerImpl.isConsumeOrderly()
 7:         &amp;&amp; MessageModel.CLUSTERING.equals(this.defaultMQPushConsumerImpl.messageModel())) {
 8:         try {
 9:             if (pq.getLockConsume().tryLock(1000, TimeUnit.MILLISECONDS)) {
10:                 try {
11:                     return this.unlockDelay(mq, pq);
12:                 } finally {
13:                     pq.getLockConsume().unlock();
14:                 }
15:             } else {
16:                 log.warn("[WRONG]mq is consuming, so can not unlock it, {}. maybe hanged for a while, {}", //
17:                     mq, //
18:                     pq.getTryUnlockTimes());
19: 
20:                 pq.incTryUnlockTimes();
21:             }
22:         } catch (Exception e) {
23:             log.error("removeUnnecessaryMessageQueue Exception", e);
24:         }
25: 
26:         return false;
27:     }
28:     return true;
29: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›æ˜¯å¦ç§»é™¤æˆåŠŸã€‚</li>
        <li>ç¬¬ 2 è‡³ 4 è¡Œ ï¼š<strong>åŒæ­¥</strong>é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</li>
        <li>ç¬¬ 5 è‡³ 27 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-send-and-consume-orderly%2F" target="_blank" rel="nofollow noopener noreferrer">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>
    </ul>
    <h4 id="PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-â€¦" data-id="heading-15"><a href="#PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-â€¦" title="[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(â€¦)"></a><code>[PullConsumer]</code> RebalancePullImpl#removeUnnecessaryMessageQueue(â€¦)</h4>
    <pre><code>1: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {
2:     this.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);
3:     this.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);
4:     return true;
5: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›ç§»é™¤æˆåŠŸã€‚å’Œ<code>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</code>åŸºæœ¬ä¸€è‡´ã€‚</li>
    </ul>
    <h3 id="RebalancePushImpl-dispatchPullRequest-â€¦" data-id="heading-16"><a href="#RebalancePushImpl-dispatchPullRequest-â€¦" title="RebalancePushImpl#dispatchPullRequest(â€¦)"></a>RebalancePushImpl#dispatchPullRequest(â€¦)</h3>
    <pre><code>1: public void dispatchPullRequest(List&lt;PullRequest&gt; pullRequestList) {
2:     for (PullRequest pullRequest : pullRequestList) {
3:         this.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);
4:         log.info("doRebalance, {}, add a new pull request {}", consumerGroup, pullRequest);
5:     }
6: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šå‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚è¯¥è°ƒç”¨æ˜¯<code>PushConsumer</code>ä¸æ–­ä¸æ–­ä¸æ–­æ‹‰å–æ¶ˆæ¯çš„èµ·ç‚¹ã€‚</li>
    </ul>
    <h4 id="DefaultMQPushConsumerImpl-executePullRequestImmediately-â€¦" data-id="heading-17"><a href="#DefaultMQPushConsumerImpl-executePullRequestImmediately-â€¦" title="DefaultMQPushConsumerImpl#executePullRequestImmediately(â€¦)"></a>DefaultMQPushConsumerImpl#executePullRequestImmediately(â€¦)</h4>
    <pre><code>1: public void executePullRequestImmediately(final PullRequest pullRequest) {
2:     this.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);
3: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæäº¤æ‹‰å–è¯·æ±‚ã€‚æäº¤åï¼Œ<code>PullMessageService</code> <strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼Œ<strong>éé˜»å¡</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fpullmessageservice" target="_blank" rel="nofollow noopener noreferrer">PullMessageService</a>ã€‚</li>
    </ul>
    <h3 id="AllocateMessageQueueStrategy" data-id="heading-18"><a href="#AllocateMessageQueueStrategy" title="AllocateMessageQueueStrategy"></a>AllocateMessageQueueStrategy</h3>
    <p><img alt="AllocateMessageQueueStrategyç±»å›¾" class="lazyload inited" data-src="https://user-gold-cdn.xitu.io/2018/10/21/166937eae5b19d65?imageView2/0/w/1280/h/960/ignore-error/1" data-width="1280" data-height="786" src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;1280&quot; height=&quot;786&quot;&gt;&lt;/svg&gt;"></p>
    <h4 id="AllocateMessageQueueAveragely" data-id="heading-19"><a href="#AllocateMessageQueueAveragely" title="AllocateMessageQueueAveragely"></a>AllocateMessageQueueAveragely</h4>
    <pre><code> 1: public class AllocateMessageQueueAveragely implements AllocateMessageQueueStrategy {
 2:     private final Logger log = ClientLogger.getLog();
 3: 
 4:     @Override
 5:     public List&lt;MessageQueue&gt; allocate(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,
 6:         List&lt;String&gt; cidAll) {
 7:         // æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®
 8:         if (currentCID == null || currentCID.length() &lt; 1) {
 9:             throw new IllegalArgumentException("currentCID is empty");
10:         }
11:         if (mqAll == null || mqAll.isEmpty()) {
12:             throw new IllegalArgumentException("mqAll is null or mqAll empty");
13:         }
14:         if (cidAll == null || cidAll.isEmpty()) {
15:             throw new IllegalArgumentException("cidAll is null or cidAll empty");
16:         }
17: 
18:         List&lt;MessageQueue&gt; result = new ArrayList&lt;&gt;();
19:         if (!cidAll.contains(currentCID)) {
20:             log.info("[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}",
21:                 consumerGroup,
22:                 currentCID,
23:                 cidAll);
24:             return result;
25:         }
26:         // å¹³å‡åˆ†é…
27:         int index = cidAll.indexOf(currentCID); // ç¬¬å‡ ä¸ªconsumerã€‚
28:         int mod = mqAll.size() % cidAll.size(); // ä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚
29:         int averageSize =
30:             mqAll.size() &lt;= cidAll.size() ? 1 : (mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()
31:                 + 1 : mqAll.size() / cidAll.size());
32:         int startIndex = (mod &gt; 0 &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod; // æœ‰ä½™æ•°çš„æƒ…å†µä¸‹ï¼Œ[0, mod) å¹³åˆ†ä½™æ•°ï¼Œå³æ¯consumerå¤šåˆ†é…ä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬indexå¼€å§‹ï¼Œè·³è¿‡å‰modä½™æ•°ã€‚
33:         int range = Math.min(averageSize, mqAll.size() - startIndex); // åˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦Math.min()çš„åŸå› æ˜¯ï¼ŒmqAll.size() &lt;= cidAll.size()ï¼Œéƒ¨åˆ†consumeråˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚
34:         for (int i = 0; i &lt; range; i++) {
35:             result.add(mqAll.get((startIndex + i) % mqAll.size()));
36:         }
37:         return result;
38:     }
39: 
40:     @Override
41:     public String getName() {
42:         return "AVG";
43:     }
44: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…é˜Ÿåˆ—ç­–ç•¥ã€‚</li>
        <li>ç¬¬ 7 è‡³ 25 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li>
        <li>ç¬¬ 26 è‡³ 36 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚
            <ul>
                <li>ç¬¬ 27 è¡Œ ï¼š<code>index</code> ï¼šå½“å‰ <code>Consumer</code> åœ¨æ¶ˆè´¹é›†ç¾¤é‡Œæ˜¯ç¬¬å‡ ä¸ªã€‚è¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å¯¹ä¼ å…¥çš„ <code>cidAll</code> å‚æ•°å¿…é¡»è¿›è¡Œæ’åºçš„åŸå› ã€‚å¦‚æœä¸æ’åºï¼Œ<code>Consumer</code> åœ¨æœ¬åœ°è®¡ç®—å‡ºæ¥çš„ <code>index</code> æ— æ³•ä¸€è‡´ï¼Œå½±å“è®¡ç®—ç»“æœã€‚</li>
                <li>ç¬¬ 28 è¡Œ ï¼š<code>mod</code> ï¼šä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</li>
                <li>ç¬¬ 29 è‡³ 31 è¡Œ ï¼š<code>averageSize</code> ï¼šä»£ç å¯ä»¥ç®€åŒ–æˆ <code>(mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())</code>ã€‚
                    <ul>
                        <li><code>[ 0, mod )</code> ï¼š<code>mqAll.size() / cidAll.size() + 1</code>ã€‚å‰é¢ <code>mod</code> ä¸ª <code>Consumer</code> å¹³åˆ†ä½™æ•°ï¼Œå¤šè·å¾— 1 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
                        <li><code>[ mod, cidAll.size() )</code> ï¼š<code>mqAll.size() / cidAll.size()</code>ã€‚</li>
                    </ul>
                </li>
                <li>ç¬¬ 32 è¡Œ ï¼š<code>startIndex</code> ï¼š<code>Consumer</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹ä½ç½®ã€‚</li>
                <li>ç¬¬ 33 è¡Œ ï¼š<code>range</code> ï¼šåˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦ <code>Math#min(...)</code> çš„åŸå› ï¼šå½“ <code>mqAll.size() &lt;= cidAll.size()</code> æ—¶ï¼Œæœ€åå‡ ä¸ª <code>Consumer</code> åˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
                <li>ç¬¬ 34 è‡³ 36 è¡Œ ï¼šç”Ÿæˆåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç»“æœã€‚</li>
            </ul>
        </li>
        <li>ä¸¾ä¸ªä¾‹å­ï¼š</li>
    </ul>
    <p>å›ºå®šæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ä¸º<strong>4</strong>ã€‚</p>
    <table>
        <thead>
            <tr>
                <th></th>
                <th>Consumer <em> 2 </em>å¯ä»¥æ•´é™¤*</th>
                <th>Consumer <em> 3 </em>ä¸å¯æ•´é™¤*</th>
                <th>Consumer <em> 5 </em>æ— æ³•éƒ½åˆ†é…*</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>æ¶ˆæ¯é˜Ÿåˆ—[0]</td>
                <td>Consumer[0]</td>
                <td>Consumer[0]</td>
                <td>Consumer[0]</td>
            </tr>
            <tr>
                <td>æ¶ˆæ¯é˜Ÿåˆ—[1]</td>
                <td>Consumer[0]</td>
                <td>Consumer[0]</td>
                <td>Consumer[1]</td>
            </tr>
            <tr>
                <td>æ¶ˆæ¯é˜Ÿåˆ—[2]</td>
                <td>Consumer[1]</td>
                <td>Consumer[1]</td>
                <td>Consumer[2]</td>
            </tr>
            <tr>
                <td>æ¶ˆæ¯é˜Ÿåˆ—[3]</td>
                <td>Consumer[1]</td>
                <td>Consumer[2]</td>
                <td>Consumer[3]</td>
            </tr>
        </tbody>
    </table>
    <h4 id="AllocateMessageQueueByMachineRoom" data-id="heading-20"><a href="#AllocateMessageQueueByMachineRoom" title="AllocateMessageQueueByMachineRoom"></a>AllocateMessageQueueByMachineRoom</h4>
    <pre><code> 1: public class AllocateMessageQueueByMachineRoom implements AllocateMessageQueueStrategy {
 2:     /**
 3:      * æ¶ˆè´¹è€…æ¶ˆè´¹brokerNameé›†åˆ
 4:      */
 5:     private Set&lt;String&gt; consumeridcs;
 6: 
 7:     @Override
 8:     public List&lt;MessageQueue&gt; allocate(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,
 9:         List&lt;String&gt; cidAll) {
10:         // å‚æ•°æ ¡éªŒ
11:         List&lt;MessageQueue&gt; result = new ArrayList&lt;MessageQueue&gt;();
12:         int currentIndex = cidAll.indexOf(currentCID);
13:         if (currentIndex &lt; 0) {
14:             return result;
15:         }
16:         // è®¡ç®—ç¬¦åˆå½“å‰é…ç½®çš„æ¶ˆè´¹è€…æ•°ç»„('consumeridcs')å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—
17:         List&lt;MessageQueue&gt; premqAll = new ArrayList&lt;MessageQueue&gt;();
18:         for (MessageQueue mq : mqAll) {
19:             String[] temp = mq.getBrokerName().split("@");
20:             if (temp.length == 2 &amp;&amp; consumeridcs.contains(temp[0])) {
21:                 premqAll.add(mq);
22:             }
23:         }
24:         // å¹³å‡åˆ†é…
25:         int mod = premqAll.size() / cidAll.size();
26:         int rem = premqAll.size() % cidAll.size();
27:         int startIndex = mod * currentIndex;
28:         int endIndex = startIndex + mod;
29:         for (int i = startIndex; i &lt; endIndex; i++) {
30:             result.add(mqAll.get(i));
31:         }
32:         if (rem &gt; currentIndex) {
33:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));
34:         }
35:         return result;
36:     }
37: 
38:     @Override
39:     public String getName() {
40:         return "MACHINE_ROOM";
41:     }
42: 
43:     public Set&lt;String&gt; getConsumeridcs() {
44:         return consumeridcs;
45:     }
46: 
47:     public void setConsumeridcs(Set&lt;String&gt; consumeridcs) {
48:         this.consumeridcs = consumeridcs;
49:     }
50: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
        <li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li>
        <li>ç¬¬ 16 è‡³ 23 è¡Œ ï¼šè®¡ç®—<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
        <li>ç¬¬ 25 è‡³ 34 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¥<strong>å¹³å‡åˆ†é…</strong>æ–¹å¼å’Œ <code>AllocateMessageQueueAveragely</code> ç•¥æœ‰ä¸åŒï¼Œå…¶æ˜¯å°†å¤šä½™çš„ç»“å°¾éƒ¨åˆ†åˆ†é…ç»™å‰ <code>rem</code> ä¸ª <code>Consumer</code>ã€‚</li>
        <li>ç–‘é—®ï¼šä½¿ç”¨è¯¥åˆ†é…ç­–ç•¥æ—¶ï¼Œ<code>Consumer</code> å’Œ <code>Broker</code> åˆ†é…éœ€è¦æ€ä¹ˆé…ç½®ã€‚ğŸ˜ˆç­‰ç ”ç©¶<strong>ä¸»ä»</strong>ç›¸å…³æºç æ—¶ï¼Œä»”ç»†è€ƒè™‘ä¸‹ã€‚</li>
    </ul>
    <h4 id="AllocateMessageQueueAveragelyByCircle" data-id="heading-21"><a href="#AllocateMessageQueueAveragelyByCircle" title="AllocateMessageQueueAveragelyByCircle"></a>AllocateMessageQueueAveragelyByCircle</h4>
    <pre><code>  1: public class AllocateMessageQueueAveragelyByCircle implements AllocateMessageQueueStrategy {
 2:     private final Logger log = ClientLogger.getLog();
 3: 
 4:     @Override
 5:     public List&lt;MessageQueue&gt; allocate(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,
 6:         List&lt;String&gt; cidAll) {
 7:         // æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®
 8:         if (currentCID == null || currentCID.length() &lt; 1) {
 9:             throw new IllegalArgumentException("currentCID is empty");
10:         }
11:         if (mqAll == null || mqAll.isEmpty()) {
12:             throw new IllegalArgumentException("mqAll is null or mqAll empty");
13:         }
14:         if (cidAll == null || cidAll.isEmpty()) {
15:             throw new IllegalArgumentException("cidAll is null or cidAll empty");
16:         }
17: 
18:         List&lt;MessageQueue&gt; result = new ArrayList&lt;MessageQueue&gt;();
19:         if (!cidAll.contains(currentCID)) {
20:             log.info("[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}",
21:                 consumerGroup,
22:                 currentCID,
23:                 cidAll);
24:             return result;
25:         }
26: 
27:         // ç¯çŠ¶åˆ†é…
28:         int index = cidAll.indexOf(currentCID);
29:         for (int i = index; i &lt; mqAll.size(); i++) {
30:             if (i % cidAll.size() == index) {
31:                 result.add(mqAll.get(i));
32:             }
33:         }
34:         return result;
35:     }
36: 
37:     @Override
38:     public String getName() {
39:         return "AVG_BY_CIRCLE";
40:     }
41: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šç¯çŠ¶åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
    </ul>
    <h4 id="AllocateMessageQueueByConfig" data-id="heading-22"><a href="#AllocateMessageQueueByConfig" title="AllocateMessageQueueByConfig"></a>AllocateMessageQueueByConfig</h4>
    <pre><code> 1: public class AllocateMessageQueueByConfig implements AllocateMessageQueueStrategy {
 2:     private List&lt;MessageQueue&gt; messageQueueList;
 3: 
 4:     @Override
 5:     public List&lt;MessageQueue&gt; allocate(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,
 6:         List&lt;String&gt; cidAll) {
 7:         return this.messageQueueList;
 8:     }
 9: 
10:     @Override
11:     public String getName() {
12:         return "CONFIG";
13:     }
14: 
15:     public List&lt;MessageQueue&gt; getMessageQueueList() {
16:         return messageQueueList;
17:     }
18: 
19:     public void setMessageQueueList(List&lt;MessageQueue&gt; messageQueueList) {
20:         this.messageQueueList = messageQueueList;
21:     }
22: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šåˆ†é…<strong>é…ç½®çš„</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
        <li>ç–‘é—® ï¼š<em>è¯¥åˆ†é…ç­–ç•¥çš„ä½¿ç”¨åœºæ™¯ã€‚</em></li>
    </ul>
    <h1 id="5ã€PushConsumer-æ¶ˆè´¹è¿›åº¦è¯»å–" data-id="heading-23"><a href="#5ã€PushConsumer-æ¶ˆè´¹è¿›åº¦è¯»å–" title="5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–"></a>5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</h1>
    <h2 id="RebalancePushImpl-computePullFromWhere-â€¦" data-id="heading-24"><a href="#RebalancePushImpl-computePullFromWhere-â€¦" title="RebalancePushImpl#computePullFromWhere(â€¦)"></a>RebalancePushImpl#computePullFromWhere(â€¦)</h2>
    <pre><code> 1: public long computePullFromWhere(MessageQueue mq) {
 2:     long result = -1;
 3:     final ConsumeFromWhere consumeFromWhere = this.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();
 4:     final OffsetStore offsetStore = this.defaultMQPushConsumerImpl.getOffsetStore();
 5:     switch (consumeFromWhere) {
 6:         case CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: // åºŸå¼ƒ
 7:         case CONSUME_FROM_MIN_OFFSET: // åºŸå¼ƒ
 8:         case CONSUME_FROM_MAX_OFFSET: // åºŸå¼ƒ
 9:         case CONSUME_FROM_LAST_OFFSET: {
10:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);
11:             if (lastOffset &gt;= 0) {
12:                 result = lastOffset;
13:             }
14:             // First start,no offset
15:             else if (-1 == lastOffset) {
16:                 if (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
17:                     result = 0L;
18:                 } else {
19:                     try {
20:                         result = this.mQClientFactory.getMQAdminImpl().maxOffset(mq);
21:                     } catch (MQClientException e) {
22:                         result = -1;
23:                     }
24:                 }
25:             } else {
26:                 result = -1;
27:             }
28:             break;
29:         }
30:         case CONSUME_FROM_FIRST_OFFSET: {
31:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);
32:             if (lastOffset &gt;= 0) {
33:                 result = lastOffset;
34:             } else if (-1 == lastOffset) {
35:                 result = 0L;
36:             } else {
37:                 result = -1;
38:             }
39:             break;
40:         }
41:         case CONSUME_FROM_TIMESTAMP: {
42:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);
43:             if (lastOffset &gt;= 0) {
44:                 result = lastOffset;
45:             } else if (-1 == lastOffset) {
46:                 if (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
47:                     try {
48:                         result = this.mQClientFactory.getMQAdminImpl().maxOffset(mq);
49:                     } catch (MQClientException e) {
50:                         result = -1;
51:                     }
52:                 } else {
53:                     try {
54:                         long timestamp = UtilAll.parseDate(this.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),
55:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();
56:                         result = this.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);
57:                     } catch (MQClientException e) {
58:                         result = -1;
59:                     }
60:                 }
61:             } else {
62:                 result = -1;
63:             }
64:             break;
65:         }
66: 
67:         default:
68:             break;
69:     }
70: 
71:     return result;
72: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹æ¶ˆè´¹ä½ç½®ã€‚</li>
        <li><code>PushConsumer</code> è¯»å–æ¶ˆè´¹è¿›åº¦æœ‰ä¸‰ç§é€‰é¡¹ï¼š
            <ul>
                <li><code>CONSUME_FROM_LAST_OFFSET</code> ï¼šç¬¬ 6 è‡³ 29 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>é˜Ÿåˆ—çš„æœ€åä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>
                <li><code>CONSUME_FROM_FIRST_OFFSET</code> ï¼šç¬¬ 30 è‡³ 40 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»é˜Ÿåˆ—çš„<strong>æœ€å‰ä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>
                <li><code>CONSUME_FROM_TIMESTAMP</code> ï¼šç¬¬ 41 è‡³ 65 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>æŒ‡å®šæ—¶é—´ç‚¹</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>
            </ul>
        </li>
    </ul>
    <h2 id="PullConsumer-RebalancePullImpl-computePullFromWhere-â€¦" data-id="heading-25"><a href="#PullConsumer-RebalancePullImpl-computePullFromWhere-â€¦" title="[PullConsumer] RebalancePullImpl#computePullFromWhere(â€¦)"></a><code>[PullConsumer]</code> RebalancePullImpl#computePullFromWhere(â€¦)</h2>
    <p>æš‚æ—¶è·³è¿‡ã€‚ğŸ˜ˆ</p>
    <h1 id="6ã€PushConsumer-æ‹‰å–æ¶ˆæ¯" data-id="heading-26"><a href="#6ã€PushConsumer-æ‹‰å–æ¶ˆæ¯" title="6ã€PushConsumer æ‹‰å–æ¶ˆæ¯"></a>6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</h1>
    <p><img alt="DefaultMQPushConsumerImplæ‹‰å–æ¶ˆæ¯" class="lazyload inited" data-src="https://user-gold-cdn.xitu.io/2018/10/21/166937ec382cfa0f?imageView2/0/w/1280/h/960/ignore-error/1" data-width="1280" data-height="874" src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;1280&quot; height=&quot;874&quot;&gt;&lt;/svg&gt;"></p>
    <h2 id="PullMessageService" data-id="heading-27"><a href="#PullMessageService" title="PullMessageService"></a>PullMessageService</h2>
    <pre><code>  1: public class PullMessageService extends ServiceThread {
  2:     private final Logger log = ClientLogger.getLog();
  3:     /**
  4:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—
  5:      */
  6:     private final LinkedBlockingQueue&lt;PullRequest&gt; pullRequestQueue = new LinkedBlockingQueue&lt;&gt;();
  7:     /**
  8:      * MQClientå¯¹è±¡
  9:      */
 10:     private final MQClientInstance mQClientFactory;
 11:     /**
 12:      * å®šæ—¶å™¨ã€‚ç”¨äºå»¶è¿Ÿæäº¤æ‹‰å–è¯·æ±‚
 13:      */
 14:     private final ScheduledExecutorService scheduledExecutorService = Executors
 15:         .newSingleThreadScheduledExecutor(new ThreadFactory() {
 16:             @Override
 17:             public Thread newThread(Runnable r) {
 18:                 return new Thread(r, "PullMessageServiceScheduledThread");
 19:             }
 20:         });
 21: 
 22:     public PullMessageService(MQClientInstance mQClientFactory) {
 23:         this.mQClientFactory = mQClientFactory;
 24:     }
 25: 
 26:     /**
 27:      * æ‰§è¡Œå»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚
 28:      *
 29:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚
 30:      * @param timeDelay å»¶è¿Ÿæ—¶é•¿
 31:      */
 32:     public void executePullRequestLater(final PullRequest pullRequest, final long timeDelay) {
 33:         this.scheduledExecutorService.schedule(new Runnable() {
 34: 
 35:             @Override
 36:             public void run() {
 37:                 PullMessageService.this.executePullRequestImmediately(pullRequest);
 38:             }
 39:         }, timeDelay, TimeUnit.MILLISECONDS);
 40:     }
 41: 
 42:     /**
 43:      * æ‰§è¡Œç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚
 44:      *
 45:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚
 46:      */
 47:     public void executePullRequestImmediately(final PullRequest pullRequest) {
 48:         try {
 49:             this.pullRequestQueue.put(pullRequest);
 50:         } catch (InterruptedException e) {
 51:             log.error("executePullRequestImmediately pullRequestQueue.put", e);
 52:         }
 53:     }
 54: 
 55:     /**
 56:      * æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡
 57:      *
 58:      * @param r ä»»åŠ¡
 59:      * @param timeDelay å»¶è¿Ÿæ—¶é•¿
 60:      */
 61:     public void executeTaskLater(final Runnable r, final long timeDelay) {
 62:         this.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);
 63:     }
 64: 
 65:     public ScheduledExecutorService getScheduledExecutorService() {
 66:         return scheduledExecutorService;
 67:     }
 68: 
 69:     /**
 70:      * æ‹‰å–æ¶ˆæ¯
 71:      *
 72:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚
 73:      */
 74:     private void pullMessage(final PullRequest pullRequest) {
 75:         final MQConsumerInner consumer = this.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());
 76:         if (consumer != null) {
 77:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;
 78:             impl.pullMessage(pullRequest);
 79:         } else {
 80:             log.warn("No matched consumer for the PullRequest {}, drop it", pullRequest);
 81:         }
 82:     }
 83: 
 84:     @Override
 85:     public void run() {
 86:         log.info(this.getServiceName() + " service started");
 87: 
 88:         while (!this.isStopped()) {
 89:             try {
 90:                 PullRequest pullRequest = this.pullRequestQueue.take();
 91:                 if (pullRequest != null) {
 92:                     this.pullMessage(pullRequest);
 93:                 }
 94:             } catch (InterruptedException e) {
 95:             } catch (Exception e) {
 96:                 log.error("Pull Message Service Run Method exception", e);
 97:             }
 98:         }
 99: 
100:         log.info(this.getServiceName() + " service end");
101:     }
102: 
103:     @Override
104:     public String getServiceName() {
105:         return PullMessageService.class.getSimpleName();
106:     }
107: 
108: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œä¸æ–­ä¸æ–­ä¸æ–­ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li>
        <li><code>#executePullRequestLater(...)</code> ï¼šç¬¬ 26 è‡³ 40 è¡Œ ï¼š æäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
        <li><code>#executePullRequestImmediately(...)</code> ï¼šç¬¬ 42 è‡³ 53 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
        <li><code>#executeTaskLater(...)</code> ï¼šç¬¬ 55 è‡³ 63 è¡Œ ï¼šæäº¤<strong>å»¶è¿Ÿä»»åŠ¡</strong>ã€‚</li>
        <li><code>#pullMessage(...)</code> ï¼šç¬¬ 69 è‡³ 82 è¡Œ ï¼šæ‰§è¡Œæ‹‰å–æ¶ˆæ¯é€»è¾‘ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#defaultmqpushconsumerimplpullmessage">DefaultMQPushConsumerImpl#pullMessage(â€¦)</a>ã€‚</li>
        <li><code>#run(...)</code> ï¼šç¬¬ 84 è‡³ 101 è¡Œ ï¼šå¾ªç¯æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—( <code>pullRequestQueue</code> )ï¼Œè¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li>
    </ul>
    <h2 id="DefaultMQPushConsumerImpl-pullMessage-â€¦" data-id="heading-28"><a href="#DefaultMQPushConsumerImpl-pullMessage-â€¦" title="DefaultMQPushConsumerImpl#pullMessage(â€¦)"></a>DefaultMQPushConsumerImpl#pullMessage(â€¦)</h2>
    <pre><code>  1: public void pullMessage(final PullRequest pullRequest) {
  2:     final ProcessQueue processQueue = pullRequest.getProcessQueue();
  3:     if (processQueue.isDropped()) {
  4:         log.info("the pull request[{}] is dropped.", pullRequest.toString());
  5:         return;
  6:     }
  7: 
  8:     // è®¾ç½®é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´
  9:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());
 10: 
 11:     // åˆ¤æ–­consumerçŠ¶æ€æ˜¯å¦è¿è¡Œä¸­ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯ã€‚
 12:     try {
 13:         this.makeSureStateOK();
 14:     } catch (MQClientException e) {
 15:         log.warn("pullMessage exception, consumer state not ok", e);
 16:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);
 17:         return;
 18:     }
 19: 
 20:     // åˆ¤æ–­æ˜¯å¦æš‚åœä¸­ã€‚
 21:     if (this.isPause()) {
 22:         log.warn("consumer was paused, execute pull request later. instanceName={}, group={}", this.defaultMQPushConsumer.getInstanceName(), this.defaultMQPushConsumer.getConsumerGroup());
 23:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);
 24:         return;
 25:     }
 26: 
 27:     // åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æŒæœ‰æ¶ˆæ¯æ•°é‡ã€‚é»˜è®¤æœ€å¤§å€¼ä¸º1000ã€‚
 28:     long size = processQueue.getMsgCount().get();
 29:     if (size &gt; this.defaultMQPushConsumer.getPullThresholdForQueue()) {
 30:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); // æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚
 31:         if ((flowControlTimes1++ % 1000) == 0) {
 32:             log.warn(
 33:                 "the consumer message buffer is full, so do flow control, minOffset={}, maxOffset={}, size={}, pullRequest={}, flowControlTimes={}",
 34:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);
 35:         }
 36:         return;
 37:     }
 38: 
 39:     if (!this.consumeOrderly) { // åˆ¤æ–­æ¶ˆæ¯è·¨åº¦æ˜¯å¦è¿‡å¤§ã€‚
 40:         if (processQueue.getMaxSpan() &gt; this.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) {
 41:             this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); // æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚
 42:             if ((flowControlTimes2++ % 1000) == 0) {
 43:                 log.warn(
 44:                     "the queue's messages, span too long, so do flow control, minOffset={}, maxOffset={}, maxSpan={}, pullRequest={}, flowControlTimes={}",
 45:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),
 46:                     pullRequest, flowControlTimes2);
 47:             }
 48:             return;
 49:         }
 50:     } else { // TODO é¡ºåºæ¶ˆè´¹
 51:         if (processQueue.isLocked()) {
 52:             if (!pullRequest.isLockedFirst()) {
 53:                 final long offset = this.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());
 54:                 boolean brokerBusy = offset &lt; pullRequest.getNextOffset();
 55:                 log.info("the first time to pull message, so fix offset from broker. pullRequest: {} NewOffset: {} brokerBusy: {}",
 56:                     pullRequest, offset, brokerBusy);
 57:                 if (brokerBusy) {
 58:                     log.info("[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: {} NewOffset: {}",
 59:                         pullRequest, offset);
 60:                 }
 61: 
 62:                 pullRequest.setLockedFirst(true);
 63:                 pullRequest.setNextOffset(offset);
 64:             }
 65:         } else {
 66:             this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);
 67:             log.info("pull message later because not locked in broker, {}", pullRequest);
 68:             return;
 69:         }
 70:     }
 71: 
 72:     // è·å–Topic å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯
 73:     final SubscriptionData subscriptionData = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());
 74:     if (null == subscriptionData) {
 75:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);
 76:         log.warn("find the consumer's subscription failed, {}", pullRequest);
 77:         return;
 78:     }
 79: 
 80:     final long beginTimestamp = System.currentTimeMillis();
 81: 
 82:     PullCallback pullCallback = new PullCallback() {
 83:         @Override
 84:         public void onSuccess(PullResult pullResult) {
 85:             if (pullResult != null) {
 86:                 pullResult = DefaultMQPushConsumerImpl.this.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,
 87:                     subscriptionData);
 88: 
 89:                 switch (pullResult.getPullStatus()) {
 90:                     case FOUND:
 91:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®
 92:                         long prevRequestOffset = pullRequest.getNextOffset();
 93:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());
 94: 
 95:                         // ç»Ÿè®¡
 96:                         long pullRT = System.currentTimeMillis() - beginTimestamp;
 97:                         DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),
 98:                             pullRequest.getMessageQueue().getTopic(), pullRT);
 99: 
100:                         long firstMsgOffset = Long.MAX_VALUE;
101:                         if (pullResult.getMsgFoundList() == null || pullResult.getMsgFoundList().isEmpty()) {
102:                             DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
103:                         } else {
104:                             firstMsgOffset = pullResult.getMsgFoundList().get(0).getQueueOffset();
105: 
106:                             // ç»Ÿè®¡
107:                             DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),
108:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());
109: 
110:                             // æäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
111:                             boolean dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());
112: 
113:                             // æäº¤æ¶ˆè´¹è¯·æ±‚
114:                             DefaultMQPushConsumerImpl.this.consumeMessageService.submitConsumeRequest(//
115:                                 pullResult.getMsgFoundList(), //
116:                                 processQueue, //
117:                                 pullRequest.getMessageQueue(), //
118:                                 dispathToConsume);
119: 
120:                             // æäº¤ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯è¯·æ±‚
121:                             if (DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval() &gt; 0) {
122:                                 DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest,
123:                                     DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval());
124:                             } else {
125:                                 DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
126:                             }
127:                         }
128: 
129:                         // ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸ºBUGï¼Œè¾“å‡ºlog
130:                         if (pullResult.getNextBeginOffset() &lt; prevRequestOffset//
131:                             || firstMsgOffset &lt; prevRequestOffset) {
132:                             log.warn(
133:                                 "[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}", //
134:                                 pullResult.getNextBeginOffset(), //
135:                                 firstMsgOffset, //
136:                                 prevRequestOffset);
137:                         }
138: 
139:                         break;
140:                     case NO_NEW_MSG:
141:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®
142:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());
143: 
144:                         // æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦
145:                         DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);
146: 
147:                         // ç«‹å³æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚
148:                         DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
149:                         break;
150:                     case NO_MATCHED_MSG:
151:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®
152:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());
153: 
154:                         // æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦
155:                         DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);
156: 
157:                         // æäº¤ç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚
158:                         DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
159:                         break;
160:                     case OFFSET_ILLEGAL:
161:                         log.warn("the pull request offset illegal, {} {}", //
162:                             pullRequest.toString(), pullResult.toString());
163:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®
164:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());
165: 
166:                         // è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸ºdropped
167:                         pullRequest.getProcessQueue().setDropped(true);
168: 
169:                         // æäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ç§»é™¤ã€‚ä¸ç«‹å³ç§»é™¤çš„åŸå› ï¼šå¯èƒ½æœ‰åœ°æ–¹æ­£åœ¨ä½¿ç”¨ï¼Œé¿å…å—åˆ°å½±å“ã€‚
170:                         DefaultMQPushConsumerImpl.this.executeTaskLater(new Runnable() {
171: 
172:                             @Override
173:                             public void run() {
174:                                 try {
175:                                     // æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ°Broker
176:                                     DefaultMQPushConsumerImpl.this.offsetStore.updateOffset(pullRequest.getMessageQueue(),
177:                                         pullRequest.getNextOffset(), false);
178:                                     DefaultMQPushConsumerImpl.this.offsetStore.persist(pullRequest.getMessageQueue());
179: 
180:                                     // ç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—
181:                                     DefaultMQPushConsumerImpl.this.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());
182: 
183:                                     log.warn("fix the pull request offset, {}", pullRequest);
184:                                 } catch (Throwable e) {
185:                                     log.error("executeTaskLater Exception", e);
186:                                 }
187:                             }
188:                         }, 10000);
189:                         break;
190:                     default:
191:                         break;
192:                 }
193:             }
194:         }
195: 
196:         @Override
197:         public void onException(Throwable e) {
198:             if (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
199:                 log.warn("execute the pull request exception", e);
200:             }
201: 
202:             // æäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚
203:             DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);
204:         }
205:     };
206: 
207:     // é›†ç¾¤æ¶ˆæ¯æ¨¡å‹ä¸‹ï¼Œè®¡ç®—æäº¤çš„æ¶ˆè´¹è¿›åº¦ã€‚
208:     boolean commitOffsetEnable = false;
209:     long commitOffsetValue = 0L;
210:     if (MessageModel.CLUSTERING == this.defaultMQPushConsumer.getMessageModel()) {
211:         commitOffsetValue = this.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);
212:         if (commitOffsetValue &gt; 0) {
213:             commitOffsetEnable = true;
214:         }
215:     }
216: 
217:     // è®¡ç®—è¯·æ±‚çš„ è®¢é˜…è¡¨è¾¾å¼ å’Œ æ˜¯å¦è¿›è¡Œfiltersrvè¿‡æ»¤æ¶ˆæ¯
218:     String subExpression = null;
219:     boolean classFilter = false;
220:     SubscriptionData sd = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());
221:     if (sd != null) {
222:         if (this.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) {
223:             subExpression = sd.getSubString();
224:         }
225: 
226:         classFilter = sd.isClassFilterMode();
227:     }
228: 
229:     // è®¡ç®—æ‹‰å–æ¶ˆæ¯ç³»ç»Ÿæ ‡è¯†
230:     int sysFlag = PullSysFlag.buildSysFlag(//
231:         commitOffsetEnable, // commitOffset
232:         true, // suspend
233:         subExpression != null, // subscription
234:         classFilter // class filter
235:     );
236: 
237:     // æ‰§è¡Œæ‹‰å–ã€‚å¦‚æœæ‹‰å–è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚
238:     try {
239:         this.pullAPIWrapper.pullKernelImpl(//
240:             pullRequest.getMessageQueue(), // 1
241:             subExpression, // 2
242:             subscriptionData.getSubVersion(), // 3
243:             pullRequest.getNextOffset(), // 4
244:             this.defaultMQPushConsumer.getPullBatchSize(), // 5
245:             sysFlag, // 6
246:             commitOffsetValue, // 7
247:             BROKER_SUSPEND_MAX_TIME_MILLIS, // 8
248:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, // 9
249:             CommunicationMode.ASYNC, // 10
250:             pullCallback// 11
251:         );
252:     } catch (Exception e) {
253:         log.error("pullKernelImpl exception", e);
254:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);
255:     }
256: }
257: 
258: private void correctTagsOffset(final PullRequest pullRequest) {
259:     if (0L == pullRequest.getProcessQueue().getMsgCount().get()) {
260:         this.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), true);
261:     }
262: }
</code></pre>
    <ul>
        <li><code>#pullMessage(...)</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯ã€‚
            <ul>
                <li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å·²ç»ç»ˆæ­¢ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li>
                <li>ç¬¬ 9 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´ã€‚</li>
                <li>ç¬¬ 11 è‡³ 18 è¡Œ ï¼š<code>Consumer</code> æœªå¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
                <li>ç¬¬ 20 è‡³ 25 è¡Œ ï¼š <code>Consumer</code> å¤„äºæš‚åœä¸­ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
                <li>ç¬¬ 27 è‡³ 37 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è¶…è¿‡æœ€å¤§å…è®¸å€¼ï¼ˆé»˜è®¤ï¼š1000æ¡ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
                <li>ç¬¬ 39 è‡³ 49 è¡Œ ï¼š<code>Consumer</code> ä¸º<strong>å¹¶å‘æ¶ˆè´¹</strong> å¹¶ä¸” æ¶ˆæ¯é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è·¨åº¦è¿‡å¤§ï¼ˆæ¶ˆæ¯è·¨åº¦ = æŒæœ‰æ¶ˆæ¯æœ€åä¸€æ¡å’Œç¬¬ä¸€æ¡çš„æ¶ˆæ¯ä½ç½®å·®ï¼Œé»˜è®¤ï¼š2000ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
                <li>ç¬¬ 50 è‡³ 70 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-send-and-consume-orderly%2F" target="_blank" rel="nofollow noopener noreferrer">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>
                <li>ç¬¬ 72 è‡³ 78 è¡Œ ï¼š<code>Topic</code> å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
                <li>ç¬¬ 222 è‡³ 224 è¡Œ ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä½¿ç”¨ <code>Consumer</code> <strong>æœ¬åœ°</strong>çš„è®¢é˜…ä¿¡æ¯( <code>SubscriptionData</code> )ï¼Œè€Œä¸ä½¿ç”¨ <code>Broker</code> é‡Œçš„è®¢é˜…ä¿¡æ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-first%2F%23PullMessageProcessor-processRequest-%E2%80%A6" target="_blank" rel="nofollow noopener noreferrer">PullMessageProcessor#processRequest(â€¦) ç¬¬ 64 è‡³ 110 è¡Œä»£ç </a>ã€‚</li>
                <li>ç¬¬ 226 è¡Œ ï¼šæ˜¯å¦å¼€å¯è¿‡æ»¤ç±»è¿‡æ»¤æ¨¡å¼ã€‚è¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Ffiltersrv%2F" target="_blank" rel="nofollow noopener noreferrer">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Filtersrvã€‹</a>ã€‚</li>
                <li>ç¬¬ 229 è‡³ 235 è¡Œ ï¼šè®¡ç®—æ‹‰å–æ¶ˆæ¯è¯·æ±‚ç³»ç»Ÿæ ‡è¯†ã€‚è¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-first%2F%23PullMessageRequestHeader" target="_blank" rel="nofollow noopener noreferrer">PullMessageRequestHeader.sysFlag</a>ã€‚</li>
                <li>ç¬¬ 237 è‡³ 255 è¡Œ ï¼š
                    <ul>
                        <li>æ‰§è¡Œæ¶ˆæ¯æ‹‰å–<strong>å¼‚æ­¥</strong>è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#pullapiwrapperpullkernelimpl">PullAPIWrapper#pullKernelImpl(â€¦)</a>ã€‚</li>
                        <li>å½“å‘èµ·è¯·æ±‚äº§ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚å¯¹åº” <code>Broker</code> å¤„ç†æ‹‰å–æ¶ˆæ¯é€»è¾‘è§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage-pull-and-consume-first%2F%23PullMessageProcessor-processRequest-%E2%80%A6" target="_blank" rel="nofollow noopener noreferrer">PullMessageProcessor#processRequest(â€¦)</a>ã€‚</li>
                    </ul>
                </li>
            </ul>
        </li>
        <li><code>PullCallback</code> ï¼šæ‹‰å–æ¶ˆæ¯å›è°ƒï¼š
            <ul>
                <li>ç¬¬ 86 è¡Œ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚è¯¦ç»†é€»è¾‘è§ï¼š<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(â€¦)</a>ã€‚</li>
                <li>ç¬¬ 89 è‡³ 192 è¡Œ ï¼šå¤„ç†æ‹‰å–çŠ¶æ€ç»“æœï¼š
                    <ul>
                        <li>ç¬¬ 90 è‡³ 139 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯( <code>FOUND</code> ) ï¼š
                            <ul>
                                <li>ç¬¬ 91 è‡³ 93 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>
                                <li>ç¬¬ 95 è‡³ 97 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>
                                <li>ç¬¬ 101 è‡³ 102 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯çš„æ¶ˆæ¯åˆ—è¡¨ä¸ºç©ºï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆæ¯ç»“æœæœªç©ºå‘¢ï¼ŸåŸå› è§ï¼š<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(â€¦)</a>ã€‚</li>
                                <li>ç¬¬ 106 è‡³ 108 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>
                                <li>ç¬¬ 111 è¡Œ ï¼šæäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#processqueueputmessage">ProcessQueue#putMessage(â€¦)</a>ã€‚</li>
                                <li>ç¬¬ 113 è‡³ 118 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚åˆ° <code>ConsumeMessageService</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#consumemessageconcurrentlyservice">ConsumeMessageConcurrentlyService</a>ã€‚</li>
                                <li>ç¬¬ 120 è‡³ 126 è¡Œ ï¼šæ ¹æ®æ‹‰å–é¢‘ç‡( <code>pullInterval</code> )ï¼Œæäº¤<strong>ç«‹å³æˆ–è€…å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚é»˜è®¤æ‹‰å–é¢‘ç‡ä¸º 0ms ï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
                                <li>ç¬¬ 129 è‡³ 137 è¡Œ ï¼šä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸º<strong>BUG</strong>ï¼Œè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚
                                    <ul>
                                        <li>ç¬¬ 140 è‡³ 149 è¡Œ ï¼šæ²¡æœ‰æ–°æ¶ˆæ¯( <code>NO_NEW_MSG</code> ) ï¼š</li>
                                    </ul>
                                </li>
                                <li>ç¬¬ 142 è¡Œ ï¼š è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>
                                <li>ç¬¬ 145 è¡Œ ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<code>#correctTagsOffset(...)</code>ã€‚</li>
                                <li>ç¬¬ 148 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚
                                    <ul>
                                        <li>ç¬¬ 150 è‡³ 159 è¡Œ ï¼šæœ‰æ–°æ¶ˆæ¯ä½†æ˜¯ä¸åŒ¹é…( <code>NO_MATCHED_MSG</code> )ã€‚é€»è¾‘åŒ <code>NO_NEW_MSG</code> ã€‚</li>
                                        <li>ç¬¬ 160 è‡³ 189 è¡Œ ï¼šæ‹‰å–è¯·æ±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ä¸åˆæ³• (<code>OFFSET_ILLEGAL</code>)ã€‚</li>
                                    </ul>
                                </li>
                                <li>ç¬¬ 164 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>
                                <li>ç¬¬ 167 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸º <code>dropped</code>ã€‚</li>
                                <li>ç¬¬ 169 è‡³ 188 è¡Œ ï¼šæäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œé˜Ÿåˆ—ç§»é™¤ã€‚
                                    <ul>
                                        <li>ç¬¬ 175 è‡³ 178 è¡Œ ï¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li>
                                        <li>ç¬¬ 181 è¡Œ ï¼šç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ã€‚
                                            <ul>
                                                <li>ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ç«‹å³ç§»é™¤ï¼Ÿï¼Ÿï¼Ÿ
                                                    <ul>
                                                        <li>ç¬¬ 196 è‡³ 204 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li><code>#correctTagsOffset(...)</code> ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚
            <ul>
                <li>ç¬¬ 258 è‡³ 261 è¡Œ ï¼š å½“æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯æ•°é‡ä¸º <strong>0</strong> æ—¶ï¼Œæ›´æ–°æ¶ˆè´¹è¿›åº¦ä¸ºæ‹‰å–è¯·æ±‚çš„æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>
            </ul>
        </li>
    </ul>
    <h3 id="PullAPIWrapper-pullKernelImpl-â€¦" data-id="heading-29"><a href="#PullAPIWrapper-pullKernelImpl-â€¦" title="PullAPIWrapper#pullKernelImpl(â€¦)"></a>PullAPIWrapper#pullKernelImpl(â€¦)</h3>
    <pre><code> 1: /**
 2:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•
 3:  *
 4:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—
 5:  * @param subExpression è®¢é˜…è¡¨è¾¾å¼
 6:  * @param subVersion è®¢é˜…ç‰ˆæœ¬å·
 7:  * @param offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®
 8:  * @param maxNums æ‹‰å–æ¶ˆæ¯æ•°é‡
 9:  * @param sysFlag æ‹‰å–è¯·æ±‚ç³»ç»Ÿæ ‡è¯†
10:  * @param commitOffset æäº¤æ¶ˆè´¹è¿›åº¦
11:  * @param brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´
12:  * @param timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é•¿
13:  * @param communicationMode é€šè®¯æ¨¡å¼
14:  * @param pullCallback æ‹‰å–å›è°ƒ
15:  * @return æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚
16:  * @throws MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸
17:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶
18:  * @throws MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚
19:  * @throws InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶
20:  */
21: protected PullResult pullKernelImpl(
22:     final MessageQueue mq,
23:     final String subExpression,
24:     final long subVersion,
25:     final long offset,
26:     final int maxNums,
27:     final int sysFlag,
28:     final long commitOffset,
29:     final long brokerSuspendMaxTimeMillis,
30:     final long timeoutMillis,
31:     final CommunicationMode communicationMode,
32:     final PullCallback pullCallback
33: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
34:     // è·å–Brokerä¿¡æ¯
35:     FindBrokerResult findBrokerResult =
36:         this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),
37:             this.recalculatePullFromWhichNode(mq), false);
38:     if (null == findBrokerResult) {
39:         this.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());
40:         findBrokerResult =
41:             this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),
42:                 this.recalculatePullFromWhichNode(mq), false);
43:     }
44: 
45:     // è¯·æ±‚æ‹‰å–æ¶ˆæ¯
46:     if (findBrokerResult != null) {
47:         int sysFlagInner = sysFlag;
48: 
49:         if (findBrokerResult.isSlave()) {
50:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);
51:         }
52: 
53:         PullMessageRequestHeader requestHeader = new PullMessageRequestHeader();
54:         requestHeader.setConsumerGroup(this.consumerGroup);
55:         requestHeader.setTopic(mq.getTopic());
56:         requestHeader.setQueueId(mq.getQueueId());
57:         requestHeader.setQueueOffset(offset);
58:         requestHeader.setMaxMsgNums(maxNums);
59:         requestHeader.setSysFlag(sysFlagInner);
60:         requestHeader.setCommitOffset(commitOffset);
61:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);
62:         requestHeader.setSubscription(subExpression);
63:         requestHeader.setSubVersion(subVersion);
64: 
65:         String brokerAddr = findBrokerResult.getBrokerAddr();
66:         if (PullSysFlag.hasClassFilterFlag(sysFlagInner)) { // TODO filtersrv
67:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);
68:         }
69: 
70:         PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage(
71:             brokerAddr,
72:             requestHeader,
73:             timeoutMillis,
74:             communicationMode,
75:             pullCallback);
76: 
77:         return pullResult;
78:     }
79: 
80:     // Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
81:     throw new MQClientException("The broker[" + mq.getBrokerName() + "] not exist", null);
82: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚<strong>è¯¥æ–¹æ³•å‚æ•°è¾ƒå¤šï¼Œå¯ä»¥çœ‹ä¸‹ä»£ç æ³¨é‡Šä¸Šæ¯ä¸ªå‚æ•°çš„è¯´æ˜</strong>ğŸ˜ˆã€‚</li>
        <li>ç¬¬ 34 è‡³ 43 è¡Œ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚
            <ul>
                <li><a href="#pullapiwrapperrecalculatepullfromwhichnode">#recalculatePullFromWhichNode(â€¦)</a></li>
                <li><a href="#mqclientinstancefindbrokeraddressinsubscribe">#MQClientInstance#findBrokerAddressInSubscribe(â€¦)</a></li>
            </ul>
        </li>
        <li>ç¬¬ 45 è‡³ 78 è¡Œ ï¼š<strong>è¯·æ±‚æ‹‰å–æ¶ˆæ¯</strong>ã€‚</li>
        <li>ç¬¬ 81 è¡Œ ï¼šå½“ <code>Broker</code> ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
    </ul>
    <h4 id="PullAPIWrapper-recalculatePullFromWhichNode-â€¦" data-id="heading-30"><a href="#PullAPIWrapper-recalculatePullFromWhichNode-â€¦" title="PullAPIWrapper#recalculatePullFromWhichNode(â€¦)"></a>PullAPIWrapper#recalculatePullFromWhichNode(â€¦)</h4>
    <pre><code> 1: /**
 2:  * æ¶ˆæ¯é˜Ÿåˆ— ä¸ æ‹‰å–Broker çš„æ˜ å°„
 3:  * å½“æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œä¼šé€šè¿‡è¯¥æ˜ å°„è·å–æ‹‰å–è¯·æ±‚å¯¹åº”çš„Broker
 4:  */
 5: private ConcurrentHashMap&lt;MessageQueue, AtomicLong/* brokerId */&gt; pullFromWhichNodeTable =
 6:     new ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt;(32);
 7: /**
 8:  * æ˜¯å¦ä½¿ç”¨é»˜è®¤Broker
 9:  */
10: private volatile boolean connectBrokerByUser = false;
11: /**
12:  * é»˜è®¤Brokerç¼–å·
13:  */
14: private volatile long defaultBrokerId = MixAll.MASTER_ID;
15: 
16: /**
17:  * è®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„Brokerç¼–å·
18:  *
19:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—
20:  * @return Brokerç¼–å·
21:  */
22: public long recalculatePullFromWhichNode(final MessageQueue mq) {
23:     // è‹¥å¼€å¯é»˜è®¤Brokerå¼€å…³ï¼Œåˆ™è¿”å›é»˜è®¤Brokerç¼–å·
24:     if (this.isConnectBrokerByUser()) {
25:         return this.defaultBrokerId;
26:     }
27: 
28:     // è‹¥æ¶ˆæ¯é˜Ÿåˆ—æ˜ å°„æ‹‰å–Brokerå­˜åœ¨ï¼Œåˆ™è¿”å›æ˜ å°„Brokerç¼–å·
29:     AtomicLong suggest = this.pullFromWhichNodeTable.get(mq);
30:     if (suggest != null) {
31:         return suggest.get();
32:     }
33: 
34:     // è¿”å›Brokerä¸»èŠ‚ç‚¹ç¼–å·
35:     return MixAll.MASTER_ID;
36: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„ <code>Broker</code> ç¼–å·ã€‚</li>
    </ul>
    <h4 id="MQClientInstance-findBrokerAddressInSubscribe-â€¦" data-id="heading-31"><a href="#MQClientInstance-findBrokerAddressInSubscribe-â€¦" title="MQClientInstance#findBrokerAddressInSubscribe(â€¦)"></a>MQClientInstance#findBrokerAddressInSubscribe(â€¦)</h4>
    <pre><code> 1: /**
 2:  * Brokeråå­— å’Œ Brokeråœ°å€ç›¸å…³ Map
 3:  */
 4: private final ConcurrentHashMap&lt;String/* Broker Name */, HashMap&lt;Long/* brokerId */, String/* address */&gt;&gt; brokerAddrTable =
 5:         new ConcurrentHashMap&lt;&gt;();
 6: 
 7: /**
 8:  * è·å¾—Brokerä¿¡æ¯
 9:  *
10:  * @param brokerName brokeråå­—
11:  * @param brokerId brokerç¼–å·
12:  * @param onlyThisBroker æ˜¯å¦å¿…é¡»æ˜¯è¯¥broker
13:  * @return Brokerä¿¡æ¯
14:  */
15: public FindBrokerResult findBrokerAddressInSubscribe(//
16:     final String brokerName, //
17:     final long brokerId, //
18:     final boolean onlyThisBroker//
19: ) {
20:     String brokerAddr = null; // brokeråœ°å€
21:     boolean slave = false; // æ˜¯å¦ä¸ºä»èŠ‚ç‚¹
22:     boolean found = false; // æ˜¯å¦æ‰¾åˆ°
23: 
24:     // è·å¾—Brokerä¿¡æ¯
25:     HashMap&lt;Long/* brokerId */, String/* address */&gt; map = this.brokerAddrTable.get(brokerName);
26:     if (map != null &amp;&amp; !map.isEmpty()) {
27:         brokerAddr = map.get(brokerId);
28:         slave = brokerId != MixAll.MASTER_ID;
29:         found = brokerAddr != null;
30: 
31:         // å¦‚æœä¸å¼ºåˆ¶è·å¾—ï¼Œé€‰æ‹©ä¸€ä¸ªBroker
32:         if (!found &amp;&amp; !onlyThisBroker) {
33:             Entry&lt;Long, String&gt; entry = map.entrySet().iterator().next();
34:             brokerAddr = entry.getValue();
35:             slave = entry.getKey() != MixAll.MASTER_ID;
36:             found = true;
37:         }
38:     }
39: 
40:     // æ‰¾åˆ°brokerï¼Œåˆ™è¿”å›ä¿¡æ¯
41:     if (found) {
42:         return new FindBrokerResult(brokerAddr, slave);
43:     }
44: 
45:     // æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å›ç©º
46:     return null;
47: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚</li>
    </ul>
    <h3 id="PullAPIWrapper-processPullResult-â€¦" data-id="heading-32"><a href="#PullAPIWrapper-processPullResult-â€¦" title="PullAPIWrapper#processPullResult(â€¦)"></a>PullAPIWrapper#processPullResult(â€¦)</h3>
    <pre><code> 1: /**
 2:  * å¤„ç†æ‹‰å–ç»“æœ
 3:  * 1. æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„
 4:  * 2. è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯
 5:  *
 6:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—
 7:  * @param pullResult æ‹‰å–ç»“æœ
 8:  * @param subscriptionData è®¢é˜…ä¿¡æ¯
 9:  * @return æ‹‰å–ç»“æœ
10:  */
11: public PullResult processPullResult(final MessageQueue mq, final PullResult pullResult,
12:     final SubscriptionData subscriptionData) {
13:     PullResultExt pullResultExt = (PullResultExt) pullResult;
14: 
15:     // æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„
16:     this.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());
17: 
18:     // è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯
19:     if (PullStatus.FOUND == pullResult.getPullStatus()) {
20:         // è§£ææ¶ˆæ¯
21:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());
22:         List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);
23: 
24:         // æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯
25:         List&lt;MessageExt&gt; msgListFilterAgain = msgList;
26:         if (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) {
27:             msgListFilterAgain = new ArrayList&lt;&gt;(msgList.size());
28:             for (MessageExt msg : msgList) {
29:                 if (msg.getTags() != null) {
30:                     if (subscriptionData.getTagsSet().contains(msg.getTags())) {
31:                         msgListFilterAgain.add(msg);
32:                     }
33:                 }
34:             }
35:         }
36: 
37:         // Hook
38:         if (this.hasHook()) {
39:             FilterMessageContext filterMessageContext = new FilterMessageContext();
40:             filterMessageContext.setUnitMode(unitMode);
41:             filterMessageContext.setMsgList(msgListFilterAgain);
42:             this.executeHook(filterMessageContext);
43:         }
44: 
45:         // è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µ
46:         for (MessageExt msg : msgListFilterAgain) {
47:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,
48:                 Long.toString(pullResult.getMinOffset()));
49:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,
50:                 Long.toString(pullResult.getMaxOffset()));
51:         }
52: 
53:         // è®¾ç½®æ¶ˆæ¯åˆ—è¡¨
54:         pullResultExt.setMsgFoundList(msgListFilterAgain);
55:     }
56: 
57:     // æ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„
58:     pullResultExt.setMessageBinary(null);
59: 
60:     return pullResult;
61: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚
            <ul>
                <li>æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚</li>
                <li>è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code>åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚</li>
            </ul>
        </li>
        <li>ç¬¬ 16 è¡Œ ï¼šæ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæœªè®¾ç½®é»˜è®¤æ‹‰å–çš„ <code>Broker</code> ç¼–å·ï¼Œä¼šä½¿ç”¨æ›´æ–°åçš„ <code>Broker</code> ç¼–å·ã€‚</li>
        <li>ç¬¬ 18 è‡³ 55 è¡Œ ï¼šè§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code> åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚
            <ul>
                <li>ç¬¬ 20 è‡³ 22 è¡Œ ï¼šè§£ææ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.iocoder.cn%2FRocketMQ%2Fmessage%2F" target="_blank" rel="nofollow noopener noreferrer">ã€ŠRocketMQ æºç åˆ†æ â€”â€” MessageåŸºç¡€ã€‹</a> ã€‚</li>
                <li>ç¬¬ 24 è‡³ 35 è¡Œ ï¼šæ ¹æ®è®¢é˜…ä¿¡æ¯<code>tagCode</code> åŒ¹é…æ¶ˆæ¯ã€‚</li>
                <li>ç¬¬ 37 è‡³ 43 è¡Œ ï¼š<code>Hook</code>ã€‚</li>
                <li>ç¬¬ 45 è‡³ 51 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µã€‚</li>
                <li>ç¬¬ 54 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
            </ul>
        </li>
        <li>ç¬¬ 58 è¡Œ ï¼šæ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„ã€‚</li>
    </ul>
    <h3 id="ProcessQueue-putMessage-â€¦" data-id="heading-33"><a href="#ProcessQueue-putMessage-â€¦" title="ProcessQueue#putMessage(â€¦)"></a>ProcessQueue#putMessage(â€¦)</h3>
    <pre><code> 1:  /**
 2:  * æ¶ˆæ¯æ˜ å°„è¯»å†™é”
 3:  */
 4: private final ReadWriteLock lockTreeMap = new ReentrantReadWriteLock();
 5: /**
 6:  * æ¶ˆæ¯æ˜ å°„
 7:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®
 8:  */
 9: private final TreeMap&lt;Long, MessageExt&gt; msgTreeMap = new TreeMap&lt;&gt;();
10: /**
11:  * æ¶ˆæ¯æ•°
12:  */
13: private final AtomicLong msgCount = new AtomicLong();
14: /**
15:  * æ·»åŠ æ¶ˆæ¯æœ€å¤§é˜Ÿåˆ—ä½ç½®
16:  */
17: private volatile long queueOffsetMax = 0L;
18: /**
19:  * æ˜¯å¦æ­£åœ¨æ¶ˆè´¹
20:  */
21: private volatile boolean consuming = false;
22: /**
23:  * Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡
24:  * è®¡ç®—å…¬å¼ = queueMaxOffset - æ–°æ·»åŠ æ¶ˆæ¯æ•°ç»„[n - 1].queueOffset
25:  * Acc = Accumulation
26:  * cnt = ï¼ˆçŒœæµ‹ï¼‰å¯¹æ¯”åº¦
27:  */
28: private volatile long msgAccCnt = 0;
29: 
30: /**
31:  * æ·»åŠ æ¶ˆæ¯ï¼Œå¹¶è¿”å›æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…
32:  * è¿”å›trueï¼Œå½“æœ‰æ–°æ¶ˆæ¯æ·»åŠ æˆåŠŸæ—¶ï¼Œ
33:  *
34:  * @param msgs æ¶ˆæ¯
35:  * @return æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…
36:  */
37: public boolean putMessage(final List&lt;MessageExt&gt; msgs) {
38:     boolean dispatchToConsume = false;
39:     try {
40:         this.lockTreeMap.writeLock().lockInterruptibly();
41:         try {
42:             // æ·»åŠ æ¶ˆæ¯
43:             int validMsgCnt = 0;
44:             for (MessageExt msg : msgs) {
45:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);
46:                 if (null == old) {
47:                     validMsgCnt++;
48:                     this.queueOffsetMax = msg.getQueueOffset();
49:                 }
50:             }
51:             msgCount.addAndGet(validMsgCnt);
52: 
53:             // è®¡ç®—æ˜¯å¦æ­£åœ¨æ¶ˆè´¹
54:             if (!msgTreeMap.isEmpty() &amp;&amp; !this.consuming) {
55:                 dispatchToConsume = true;
56:                 this.consuming = true;
57:             }
58: 
59:             // Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡
60:             if (!msgs.isEmpty()) {
61:                 MessageExt messageExt = msgs.get(msgs.size() - 1);
62:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);
63:                 if (property != null) {
64:                     long accTotal = Long.parseLong(property) - messageExt.getQueueOffset();
65:                     if (accTotal &gt; 0) {
66:                         this.msgAccCnt = accTotal;
67:                     }
68:                 }
69:             }
70:         } finally {
71:             this.lockTreeMap.writeLock().unlock();
72:         }
73:     } catch (InterruptedException e) {
74:         log.error("putMessage exception", e);
75:     }
76: 
77:     return dispatchToConsume;
78: }
</code></pre>
    <h2 id="æ€»ç»“" data-id="heading-34"><a href="#æ€»ç»“" title="æ€»ç»“"></a>æ€»ç»“</h2>
    <p>å¦‚æœç”¨æœ€ç®€å•ç²—æš´çš„æ–¹å¼æè¿° <code>PullConsumer</code> æ‹‰å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œé‚£å°±æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š</p>
    <pre><code>while (true) {
    if (ä¸æ»¡è¶³æ‹‰å–æ¶ˆæ¯) {
        Thread.sleep(é—´éš”);
        continue;
    }
    ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯();
}
</code></pre>
    <h1 id="6ã€PushConsumer-æ¶ˆè´¹æ¶ˆæ¯" data-id="heading-35"><a href="#6ã€PushConsumer-æ¶ˆè´¹æ¶ˆæ¯" title="6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯"></a>6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</h1>
    <p><img alt="DefaultMQPushConsumerImplæ¶ˆè´¹æ¶ˆæ¯" class="lazyload inited" data-src="https://user-gold-cdn.xitu.io/2018/10/21/166937eb32b5a834?imageView2/0/w/1280/h/960/ignore-error/1" data-width="1280" data-height="680" src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;1280&quot; height=&quot;680&quot;&gt;&lt;/svg&gt;"></p>
    <h2 id="ConsumeMessageConcurrentlyService-æäº¤æ¶ˆè´¹è¯·æ±‚" data-id="heading-36"><a href="#ConsumeMessageConcurrentlyService-æäº¤æ¶ˆè´¹è¯·æ±‚" title="ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚"></a>ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</h2>
    <h3 id="ConsumeMessageConcurrentlyService-submitConsumeRequest-â€¦" data-id="heading-37"><a href="#ConsumeMessageConcurrentlyService-submitConsumeRequest-â€¦" title="ConsumeMessageConcurrentlyService#submitConsumeRequest(â€¦)"></a>ConsumeMessageConcurrentlyService#submitConsumeRequest(â€¦)</h3>
    <pre><code> 1: /**
 2:  * æ¶ˆè´¹çº¿ç¨‹æ± é˜Ÿåˆ—
 3:  */
 4: private final BlockingQueue&lt;Runnable&gt; consumeRequestQueue;
 5: /**
 6:  * æ¶ˆè´¹çº¿ç¨‹æ± 
 7:  */
 8: private final ThreadPoolExecutor consumeExecutor;
 9: 
10: public void submitConsumeRequest(//
11:     final List&lt;MessageExt&gt; msgs, //
12:     final ProcessQueue processQueue, //
13:     final MessageQueue messageQueue, //
14:     final boolean dispatchToConsume) {
15:     final int consumeBatchSize = this.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();
16:     if (msgs.size() &lt;= consumeBatchSize) { // æäº¤æ¶ˆæ¯å°äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚
17:         ConsumeRequest consumeRequest = new ConsumeRequest(msgs, processQueue, messageQueue);
18:         try {
19:             this.consumeExecutor.submit(consumeRequest);
20:         } catch (RejectedExecutionException e) {
21:             this.submitConsumeRequestLater(consumeRequest);
22:         }
23:     } else { // æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªæ¶ˆè´¹è¯·æ±‚
24:         for (int total = 0; total &lt; msgs.size(); ) {
25:             // è®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯
26:             List&lt;MessageExt&gt; msgThis = new ArrayList&lt;&gt;(consumeBatchSize);
27:             for (int i = 0; i &lt; consumeBatchSize; i++, total++) {
28:                 if (total &lt; msgs.size()) {
29:                     msgThis.add(msgs.get(total));
30:                 } else {
31:                     break;
32:                 }
33:             }
34: 
35:             // æäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚
36:             ConsumeRequest consumeRequest = new ConsumeRequest(msgThis, processQueue, messageQueue);
37:             try {
38:                 this.consumeExecutor.submit(consumeRequest);
39:             } catch (RejectedExecutionException e) {
40:                 // å¦‚æœè¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯+å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚
41:                 for (; total &lt; msgs.size(); total++) {
42:                     msgThis.add(msgs.get(total));
43:                 }
44:                 this.submitConsumeRequestLater(consumeRequest);
45:             }
46:         }
47:     }
48: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæäº¤<strong>ç«‹å³</strong>æ¶ˆè´¹è¯·æ±‚ã€‚</li>
        <li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šæäº¤æ¶ˆæ¯å°äºç­‰äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚ã€‚</li>
        <li>ç¬¬ 23 è‡³ 47 è¡Œ ï¼šå½“æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªè¯·æ±‚ã€‚
            <ul>
                <li>ç¬¬ 25 è‡³ 33 è¡Œ ï¼šè®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯ã€‚</li>
                <li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šæäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚ã€‚</li>
                <li>ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæäº¤è¯·æ±‚è¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯ + å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ï¼Œç»“æŸæ‹†åˆ†å¾ªç¯ã€‚</li>
            </ul>
        </li>
    </ul>
    <h3 id="ConsumeMessageConcurrentlyService-submitConsumeRequestLater" data-id="heading-38"><a href="#ConsumeMessageConcurrentlyService-submitConsumeRequestLater" title="ConsumeMessageConcurrentlyService#submitConsumeRequestLater"></a>ConsumeMessageConcurrentlyService#submitConsumeRequestLater</h3>
    <pre><code>  1: /**
 2:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚
 3:  *
 4:  * @param msgs æ¶ˆæ¯åˆ—è¡¨
 5:  * @param processQueue æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
 6:  * @param messageQueue æ¶ˆæ¯é˜Ÿåˆ—
 7:  */
 8: private void submitConsumeRequestLater(//
 9:     final List&lt;MessageExt&gt; msgs, //
10:     final ProcessQueue processQueue, //
11:     final MessageQueue messageQueue//
12: ) {
13: 
14:     this.scheduledExecutorService.schedule(new Runnable() {
15: 
16:         @Override
17:         public void run() {
18:             ConsumeMessageConcurrentlyService.this.submitConsumeRequest(msgs, processQueue, messageQueue, true);
19:         }
20:     }, 5000, TimeUnit.MILLISECONDS);
21: }
22: 
23: /**
24:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚
25:  * @param consumeRequest æ¶ˆè´¹è¯·æ±‚
26:  */
27: private void submitConsumeRequestLater(final ConsumeRequest consumeRequest//
28: ) {
29: 
30:     this.scheduledExecutorService.schedule(new Runnable() {
31: 
32:         @Override
33:         public void run() {
34:             ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest); // TODO BUG ?
35:         }
36:     }, 5000, TimeUnit.MILLISECONDS);
37: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</li>
        <li>ç¬¬ 34 è¡Œ ï¼šç›´æ¥è°ƒç”¨ <code>ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);</code>ã€‚å¦‚æœæ¶ˆæ¯æ•°è¶…è¿‡æ‰¹é‡æ¶ˆè´¹ä¸Šé™ï¼Œä¼šä¸ä¼šæ˜¯<strong>BUG</strong>ã€‚</li>
    </ul>
    <h2 id="ConsumeRequest" data-id="heading-39"><a href="#ConsumeRequest" title="ConsumeRequest"></a>ConsumeRequest</h2>
    <pre><code>  1: class ConsumeRequest implements Runnable {
  2: 
  3:     /**
  4:      * æ¶ˆè´¹æ¶ˆæ¯åˆ—è¡¨
  5:      */
  6:     private final List&lt;MessageExt&gt; msgs;
  7:     /**
  8:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
  9:      */
 10:     private final ProcessQueue processQueue;
 11:     /**
 12:      * æ¶ˆæ¯é˜Ÿåˆ—
 13:      */
 14:     private final MessageQueue messageQueue;
 15: 
 16:     public ConsumeRequest(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue) {
 17:         this.msgs = msgs;
 18:         this.processQueue = processQueue;
 19:         this.messageQueue = messageQueue;
 20:     }
 21: 
 22:     @Override
 23:     public void run() {
 24:         // åºŸå¼ƒé˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹
 25:         if (this.processQueue.isDropped()) {
 26:             log.info("the message queue not be able to consume, because it's dropped. group={} {}", ConsumeMessageConcurrentlyService.this.consumerGroup, this.messageQueue);
 27:             return;
 28:         }
 29: 
 30:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.this.messageListener; // ç›‘å¬å™¨
 31:         ConsumeConcurrentlyContext context = new ConsumeConcurrentlyContext(messageQueue); // æ¶ˆè´¹Context
 32:         ConsumeConcurrentlyStatus status = null; // æ¶ˆè´¹ç»“æœçŠ¶æ€
 33: 
 34:         // Hook
 35:         ConsumeMessageContext consumeMessageContext = null;
 36:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {
 37:             consumeMessageContext = new ConsumeMessageContext();
 38:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());
 39:             consumeMessageContext.setProps(new HashMap&lt;String, String&gt;());
 40:             consumeMessageContext.setMq(messageQueue);
 41:             consumeMessageContext.setMsgList(msgs);
 42:             consumeMessageContext.setSuccess(false);
 43:             ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);
 44:         }
 45: 
 46:         long beginTimestamp = System.currentTimeMillis();
 47:         boolean hasException = false;
 48:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; // æ¶ˆè´¹è¿”å›ç»“æœç±»å‹
 49:         try {
 50:             // å½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½®Topicä¸ºåŸå§‹Topic
 51:             ConsumeMessageConcurrentlyService.this.resetRetryTopic(msgs);
 52: 
 53:             // è®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´
 54:             if (msgs != null &amp;&amp; !msgs.isEmpty()) {
 55:                 for (MessageExt msg : msgs) {
 56:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));
 57:                 }
 58:             }
 59: 
 60:             // è¿›è¡Œæ¶ˆè´¹
 61:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);
 62:         } catch (Throwable e) {
 63:             log.warn("consumeMessage exception: {} Group: {} Msgs: {} MQ: {}",
 64:                 RemotingHelper.exceptionSimpleDesc(e), //
 65:                 ConsumeMessageConcurrentlyService.this.consumerGroup,
 66:                 msgs,
 67:                 messageQueue);
 68:             hasException = true;
 69:         }
 70: 
 71:         // è§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹
 72:         long consumeRT = System.currentTimeMillis() - beginTimestamp;
 73:         if (null == status) {
 74:             if (hasException) {
 75:                 returnType = ConsumeReturnType.EXCEPTION;
 76:             } else {
 77:                 returnType = ConsumeReturnType.RETURNNULL;
 78:             }
 79:         } else if (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * 60 * 1000) {
 80:             returnType = ConsumeReturnType.TIME_OUT;
 81:         } else if (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) {
 82:             returnType = ConsumeReturnType.FAILED;
 83:         } else if (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) {
 84:             returnType = ConsumeReturnType.SUCCESS;
 85:         }
 86: 
 87:         // Hook
 88:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {
 89:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());
 90:         }
 91: 
 92:         // æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç©ºæ—¶ï¼Œåˆ™è®¾ç½®ä¸ºç¨åé‡æ–°æ¶ˆè´¹
 93:         if (null == status) {
 94:             log.warn("consumeMessage return null, Group: {} Msgs: {} MQ: {}",
 95:                 ConsumeMessageConcurrentlyService.this.consumerGroup,
 96:                 msgs,
 97:                 messageQueue);
 98:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;
 99:         }
100: 
101:         // Hook
102:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {
103:             consumeMessageContext.setStatus(status.toString());
104:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);
105:             ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);
106:         }
107: 
108:         // ç»Ÿè®¡
109:         ConsumeMessageConcurrentlyService.this.getConsumerStatsManager()
110:             .incConsumeRT(ConsumeMessageConcurrentlyService.this.consumerGroup, messageQueue.getTopic(), consumeRT);
111: 
112:         // å¤„ç†æ¶ˆè´¹ç»“æœ
113:         if (!processQueue.isDropped()) {
114:             ConsumeMessageConcurrentlyService.this.processConsumeResult(status, context, this);
115:         } else {
116:             log.warn("processQueue is dropped without process consume result. messageQueue={}, msgs={}", messageQueue, msgs);
117:         }
118:     }
119: 
120: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæ¶ˆè´¹è¯·æ±‚ã€‚æäº¤è¯·æ±‚æ‰§è¡Œæ¶ˆè´¹ã€‚</li>
        <li>ç¬¬ 24 è‡³ 28 è¡Œ ï¼šåºŸå¼ƒå¤„ç†é˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹ã€‚</li>
        <li>ç¬¬ 34 è‡³ 44 è¡Œ ï¼šHookã€‚</li>
        <li>ç¬¬ 51 è¡Œ ï¼šå½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½® <code>Topic</code>ä¸ºåŸå§‹ <code>Topic</code>ã€‚ä¾‹å¦‚ï¼šåŸå§‹ <code>Topic</code> ä¸º <code>TopicTest</code>ï¼Œé‡è¯•æ—¶ <code>Topic</code> ä¸º <code>%RETRY%please_rename_unique_group_name_4</code>ï¼Œç»è¿‡è¯¥æ–¹æ³•ï¼Œ<code>Topic</code> è®¾ç½®å› <code>TopicTest</code>ã€‚</li>
        <li>ç¬¬ 53 è‡³ 58 è¡Œ ï¼šè®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´ã€‚</li>
        <li>ç¬¬ 61 è¡Œ ï¼š<strong>è¿›è¡Œæ¶ˆè´¹</strong>ã€‚</li>
        <li>ç¬¬ 71 è‡³ 85 è¡Œ ï¼šè§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</li>
        <li>ç¬¬ 87 è‡³ 90 è¡Œ ï¼š<code>Hook</code>ã€‚</li>
        <li>ç¬¬ 92 è‡³ 99 è¡Œ ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€æœªç©ºæ—¶ï¼Œåˆ™è®¾ç½®æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç¨åæ¶ˆè´¹ã€‚</li>
        <li>ç¬¬ 101 è‡³ 106 è¡Œ ï¼š<code>Hook</code>ã€‚</li>
        <li>ç¬¬ 108 è‡³ 110 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>
        <li>ç¬¬ 112 è‡³ 117 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚<strong>å¦‚æœæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—è¢«ç§»é™¤ï¼Œæ°å¥½æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#consumemessageconcurrentlyserviceprocessconsumeresult">ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)</a>ã€‚</li>
    </ul>
    <h2 id="ConsumeMessageConcurrentlyService-processConsumeResult-â€¦" data-id="heading-40"><a href="#ConsumeMessageConcurrentlyService-processConsumeResult-â€¦" title="ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)"></a>ConsumeMessageConcurrentlyService#processConsumeResult(â€¦)</h2>
    <pre><code> 1: public void processConsumeResult(//
 2:     final ConsumeConcurrentlyStatus status, //
 3:     final ConsumeConcurrentlyContext context, //
 4:     final ConsumeRequest consumeRequest//
 5: ) {
 6:     int ackIndex = context.getAckIndex();
 7: 
 8:     // æ¶ˆæ¯ä¸ºç©ºï¼Œç›´æ¥è¿”å›
 9:     if (consumeRequest.getMsgs().isEmpty())
10:         return;
11: 
12:     // è®¡ç®—ä»consumeRequest.msgs[0]åˆ°consumeRequest.msgs[ackIndex]çš„æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ
13:     switch (status) {
14:         case CONSUME_SUCCESS:
15:             if (ackIndex &gt;= consumeRequest.getMsgs().size()) {
16:                 ackIndex = consumeRequest.getMsgs().size() - 1;
17:             }
18:             // ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡
19:             int ok = ackIndex + 1;
20:             int failed = consumeRequest.getMsgs().size() - ok;
21:             this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);
22:             this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);
23:             break;
24:         case RECONSUME_LATER:
25:             ackIndex = -1;
26:             // ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡
27:             this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),
28:                 consumeRequest.getMsgs().size());
29:             break;
30:         default:
31:             break;
32:     }
33: 
34:     // å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯
35:     switch (this.defaultMQPushConsumer.getMessageModel()) {
36:         case BROADCASTING: // å¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ°Brokerï¼Œåªæ‰“å°Log
37:             for (int i = ackIndex + 1; i &lt; consumeRequest.getMsgs().size(); i++) {
38:                 MessageExt msg = consumeRequest.getMsgs().get(i);
39:                 log.warn("BROADCASTING, the message consume failed, drop it, {}", msg.toString());
40:             }
41:             break;
42:         case CLUSTERING:
43:             // å‘å›æ¶ˆæ¯å¤±è´¥åˆ°Brokerã€‚
44:             List&lt;MessageExt&gt; msgBackFailed = new ArrayList&lt;&gt;(consumeRequest.getMsgs().size());
45:             for (int i = ackIndex + 1; i &lt; consumeRequest.getMsgs().size(); i++) {
46:                 MessageExt msg = consumeRequest.getMsgs().get(i);
47:                 boolean result = this.sendMessageBack(msg, context);
48:                 if (!result) {
49:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);
50:                     msgBackFailed.add(msg);
51:                 }
52:             }
53: 
54:             // å‘å›Brokerå¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹
55:             if (!msgBackFailed.isEmpty()) {
56:                 consumeRequest.getMsgs().removeAll(msgBackFailed);
57: 
58:                 this.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());
59:             }
60:             break;
61:         default:
62:             break;
63:     }
64: 
65:     // ç§»é™¤æ¶ˆè´¹æˆåŠŸæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦
66:     long offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());
67:     if (offset &gt;= 0 &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) {
68:         this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, true);
69:     }
70: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>
        <li>ç¬¬ 8 è‡³ 10 è¡Œ ï¼šæ¶ˆè´¹è¯·æ±‚æ¶ˆæ¯æœªç©ºæ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li>
        <li>ç¬¬ 12 è‡³ 32 è¡Œ ï¼šè®¡ç®— <code>ackIndex</code> å€¼ã€‚<code>consumeRequest.msgs[0 - ackIndex]</code>ä¸ºæ¶ˆè´¹æˆåŠŸï¼Œéœ€è¦è¿›è¡Œ <code>ack</code> ç¡®è®¤ã€‚
            <ul>
                <li>ç¬¬ 14 è‡³ 23 è¡Œ ï¼š<code>CONSUME_SUCCESS</code> ï¼š<code>ackIndex = context.getAckIndex()</code>ã€‚</li>
                <li>ç¬¬ 24 è‡³ 29 è¡Œ ï¼š<code>RECONSUME_LATER</code> ï¼š<code>ackIndex = -1</code>ã€‚</li>
            </ul>
        </li>
        <li>ç¬¬34 è‡³ 63 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ã€‚
            <ul>
                <li>ç¬¬ 36 è‡³ 41 è¡Œ ï¼š<code>BROADCASTING</code> ï¼šå¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ° <code>Broker</code>ï¼Œåªæ‰“å°æ—¥å¿—ã€‚</li>
                <li>ç¬¬ 42 è‡³ 60 è¡Œ ï¼š<code>CLUSTERING</code> ï¼šé›†ç¾¤æ¨¡å¼ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code>ã€‚
                    <ul>
                        <li>ç¬¬ 43 è‡³ 52 è¡Œ ï¼šå‘å›æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯åˆ° <code>Broker</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#defaultmqpushconsumerimplsendmessageback">DefaultMQPushConsumerImpl#sendMessageBack(â€¦)</a>ã€‚</li>
                        <li>ç¬¬ 54 è‡³ 59 è¡Œ ï¼šå‘å› <code>Broker</code> å¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹ã€‚</li>
                        <li>å¦‚æœå‘å› <code>Broker</code> æˆåŠŸï¼Œç»“æœå› ä¸ºä¾‹å¦‚ç½‘ç»œå¼‚å¸¸ï¼Œå¯¼è‡´ <code>Consumer</code>ä»¥ä¸ºå‘å›å¤±è´¥ï¼Œåˆ¤å®šæ¶ˆè´¹å‘å›å¤±è´¥ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§ã€‚</li>
                    </ul>
                </li>
            </ul>
        </li>
        <li>ç¬¬ 65 è‡³ 69 è¡Œ ï¼šç§»é™¤<strong>ã€æ¶ˆè´¹æˆåŠŸã€‘</strong>å’Œã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘çš„æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦ã€‚
            <ul>
                <li>ä¸ºä»€ä¹ˆä¼šæœ‰<strong>ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘</strong>çš„æ¶ˆæ¯ï¼Ÿè§<strong>ç¬¬ 56 è¡Œ</strong>ã€‚</li>
                <li><a href="#processqueueremovemessage">ProcessQueue#removeMessage(â€¦)</a></li>
            </ul>
        </li>
    </ul>
    <h3 id="ProcessQueue-removeMessage-â€¦" data-id="heading-41"><a href="#ProcessQueue-removeMessage-â€¦" title="ProcessQueue#removeMessage(â€¦)"></a>ProcessQueue#removeMessage(â€¦)</h3>
    <pre><code> 1: /**
 2:  * ç§»é™¤æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç¬¬ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®
 3:  *
 4:  * @param msgs æ¶ˆæ¯
 5:  * @return æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®
 6:  */
 7: public long removeMessage(final List&lt;MessageExt&gt; msgs) {
 8:     long result = -1;
 9:     final long now = System.currentTimeMillis();
10:     try {
11:         this.lockTreeMap.writeLock().lockInterruptibly();
12:         this.lastConsumeTimestamp = now;
13:         try {
14:             if (!msgTreeMap.isEmpty()) {
15:                 result = this.queueOffsetMax + 1; // è¿™é‡Œ+1çš„åŸå› æ˜¯ï¼šå¦‚æœmsgTreeMapä¸ºç©ºæ—¶ï¼Œä¸‹ä¸€æ¡è·å¾—çš„æ¶ˆæ¯ä½ç½®ä¸ºqueueOffsetMax+1
16: 
17:                 // ç§»é™¤æ¶ˆæ¯
18:                 int removedCnt = 0;
19:                 for (MessageExt msg : msgs) {
20:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());
21:                     if (prev != null) {
22:                         removedCnt--;
23:                     }
24:                 }
25:                 msgCount.addAndGet(removedCnt);
26: 
27:                 if (!msgTreeMap.isEmpty()) {
28:                     result = msgTreeMap.firstKey();
29:                 }
30:             }
31:         } finally {
32:             this.lockTreeMap.writeLock().unlock();
33:         }
34:     } catch (Throwable t) {
35:         log.error("removeMessage exception", t);
36:     }
37: 
38:     return result;
39: }
</code></pre>
    <h2 id="ConsumeMessageConcurrentlyService-cleanExpireMsg-â€¦" data-id="heading-42"><a href="#ConsumeMessageConcurrentlyService-cleanExpireMsg-â€¦" title="ConsumeMessageConcurrentlyService#cleanExpireMsg(â€¦)"></a>ConsumeMessageConcurrentlyService#cleanExpireMsg(â€¦)</h2>
    <pre><code> 1: public void start() {
 2:     this.cleanExpireMsgExecutors.scheduleAtFixedRate(new Runnable() {
 3: 
 4:         @Override
 5:         public void run() {
 6:             cleanExpireMsg();
 7:         }
 8: 
 9:     }, this.defaultMQPushConsumer.getConsumeTimeout(), this.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);
10: }
11: 
12: /**
13:  * æ¸…ç†è¿‡æœŸæ¶ˆæ¯
14:  */
15: private void cleanExpireMsg() {
16:     Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it =
17:         this.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();
18:     while (it.hasNext()) {
19:         Map.Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();
20:         ProcessQueue pq = next.getValue();
21:         pq.cleanExpiredMsg(this.defaultMQPushConsumer);
22:     }
23: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šå®šæ—¶æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼Œé»˜è®¤å‘¨æœŸï¼š15minã€‚</li>
    </ul>
    <h3 id="ProcessQueue-cleanExpiredMsg-â€¦" data-id="heading-43"><a href="#ProcessQueue-cleanExpiredMsg-â€¦" title="ProcessQueue#cleanExpiredMsg(â€¦)"></a>ProcessQueue#cleanExpiredMsg(â€¦)</h3>
    <pre><code> 1: public void cleanExpiredMsg(DefaultMQPushConsumer pushConsumer) {
 2:     // é¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›
 3:     if (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) {
 4:         return;
 5:     }
 6: 
 7:     // å¾ªç¯ç§»é™¤æ¶ˆæ¯
 8:     int loop = msgTreeMap.size() &lt; 16 ? msgTreeMap.size() : 16; // æ¯æ¬¡å¾ªç¯æœ€å¤šç§»é™¤16æ¡
 9:     for (int i = 0; i &lt; loop; i++) {
10:         // è·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯
11:         MessageExt msg = null;
12:         try {
13:             this.lockTreeMap.readLock().lockInterruptibly();
14:             try {
15:                 if (!msgTreeMap.isEmpty() &amp;&amp; System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) &gt; pushConsumer.getConsumeTimeout() * 60 * 1000) {
16:                     msg = msgTreeMap.firstEntry().getValue();
17:                 } else {
18:                     break;
19:                 }
20:             } finally {
21:                 this.lockTreeMap.readLock().unlock();
22:             }
23:         } catch (InterruptedException e) {
24:             log.error("getExpiredMsg exception", e);
25:         }
26: 
27:         try {
28:             // å‘å›è¶…æ—¶æ¶ˆæ¯
29:             pushConsumer.sendMessageBack(msg, 3);
30:             log.info("send expire msg back. topic={}, msgId={}, storeHost={}, queueId={}, queueOffset={}", msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());
31: 
32:             // åˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤
33:             try {
34:                 this.lockTreeMap.writeLock().lockInterruptibly();
35:                 try {
36:                     if (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey()) {
37:                         try {
38:                             msgTreeMap.remove(msgTreeMap.firstKey());
39:                         } catch (Exception e) {
40:                             log.error("send expired msg exception", e);
41:                         }
42:                     }
43:                 } finally {
44:                     this.lockTreeMap.writeLock().unlock();
45:                 }
46:             } catch (InterruptedException e) {
47:                 log.error("getExpiredMsg exception", e);
48:             }
49:         } catch (Exception e) {
50:             log.error("send expired msg exception", e);
51:         }
52:     }
53: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šç§»é™¤è¿‡æœŸæ¶ˆæ¯ã€‚</li>
        <li>ç¬¬ 2 è‡³ 5 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li>
        <li>ç¬¬ 7 è‡³ 9 è¡Œ ï¼šå¾ªç¯ç§»é™¤æ¶ˆæ¯ã€‚é»˜è®¤æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼š16æ¬¡ã€‚</li>
        <li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šè·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚</li>
        <li>ç¬¬ 29 è¡Œ ï¼šå‘å›è¶…æ—¶æ¶ˆæ¯åˆ°<code>Broker</code>ã€‚</li>
        <li>ç¬¬ 32 è‡³ 48 è¡Œ ï¼šåˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤ã€‚</li>
    </ul>
    <h1 id="7ã€PushConsumer-å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯" data-id="heading-44"><a href="#7ã€PushConsumer-å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯" title="7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯"></a>7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</h1>
    <h2 id="DefaultMQPushConsumerImpl-sendMessageBack-â€¦" data-id="heading-45"><a href="#DefaultMQPushConsumerImpl-sendMessageBack-â€¦" title="DefaultMQPushConsumerImpl#sendMessageBack(â€¦)"></a>DefaultMQPushConsumerImpl#sendMessageBack(â€¦)</h2>
    <pre><code> 1: public void sendMessageBack(MessageExt msg, int delayLevel, final String brokerName)
 2:     throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
 3:     try {
 4:         // Consumerå‘å›æ¶ˆæ¯
 5:         String brokerAddr = (null != brokerName) ? this.mQClientFactory.findBrokerAddressInPublish(brokerName)
 6:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());
 7:         this.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,
 8:             this.defaultMQPushConsumer.getConsumerGroup(), delayLevel, 5000, getMaxReconsumeTimes());
 9:     } catch (Exception e) { // TODO ç–‘é—®ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸
10:         // å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨Clientå†…ç½®Producerå‘å›æ¶ˆæ¯
11:         log.error("sendMessageBack Exception, " + this.defaultMQPushConsumer.getConsumerGroup(), e);
12: 
13:         Message newMsg = new Message(MixAll.getRetryTopic(this.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());
14: 
15:         String originMsgId = MessageAccessor.getOriginMessageId(msg);
16:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);
17: 
18:         newMsg.setFlag(msg.getFlag());
19:         MessageAccessor.setProperties(newMsg, msg.getProperties());
20:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());
21:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + 1));
22:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));
23:         newMsg.setDelayTimeLevel(3 + msg.getReconsumeTimes());
24: 
25:         this.mQClientFactory.getDefaultMQProducer().send(newMsg);
26:     }
27: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šå‘å›æ¶ˆæ¯ã€‚</li>
        <li>ç¬¬ 4 è‡³ 8 è¡Œ ï¼š<code>Consumer</code> å‘å›æ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href="#mqclientapiimplconsumersendmessageback">MQClientAPIImpl#consumerSendMessageBack(â€¦)</a>ã€‚</li>
        <li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ<code>Consumer</code> å†…ç½®é»˜è®¤ <code>Producer</code> å‘é€æ¶ˆæ¯ã€‚
            <ul>
                <li>ğŸ˜ˆç–‘é—®ï¼šä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸å‘¢ï¼Ÿ</li>
            </ul>
        </li>
    </ul>
    <h3 id="MQClientAPIImpl-consumerSendMessageBack-â€¦" data-id="heading-46"><a href="#MQClientAPIImpl-consumerSendMessageBack-â€¦" title="MQClientAPIImpl#consumerSendMessageBack(â€¦)"></a>MQClientAPIImpl#consumerSendMessageBack(â€¦)</h3>
    <pre><code> 1: /**
 2:  * Consumerå‘å›æ¶ˆæ¯
 3:  * @param addr Brokeråœ°å€
 4:  * @param msg æ¶ˆæ¯
 5:  * @param consumerGroup æ¶ˆè´¹åˆ†ç»„
 6:  * @param delayLevel å»¶è¿Ÿçº§åˆ«
 7:  * @param timeoutMillis è¶…æ—¶
 8:  * @param maxConsumeRetryTimes æ¶ˆè´¹æœ€å¤§é‡è¯•æ¬¡æ•°
 9:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶
10:  * @throws MQBrokerException å½“Brokerå‘ç”Ÿå¼‚å¸¸æ—¶
11:  * @throws InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶
12:  */
13: public void consumerSendMessageBack(
14:     final String addr,
15:     final MessageExt msg,
16:     final String consumerGroup,
17:     final int delayLevel,
18:     final long timeoutMillis,
19:     final int maxConsumeRetryTimes
20: ) throws RemotingException, MQBrokerException, InterruptedException {
21:     ConsumerSendMsgBackRequestHeader requestHeader = new ConsumerSendMsgBackRequestHeader();
22:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);
23: 
24:     requestHeader.setGroup(consumerGroup);
25:     requestHeader.setOriginTopic(msg.getTopic());
26:     requestHeader.setOffset(msg.getCommitLogOffset());
27:     requestHeader.setDelayLevel(delayLevel);
28:     requestHeader.setOriginMsgId(msg.getMsgId());
29:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);
30: 
31:     RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),
32:         request, timeoutMillis);
33:     assert response != null;
34:     switch (response.getCode()) {
35:         case ResponseCode.SUCCESS: {
36:             return;
37:         }
38:         default:
39:             break;
40:     }
41: 
42:     throw new MQBrokerException(response.getCode(), response.getRemark());
43: }
</code></pre>
    <h1 id="8ã€Consumer-æ¶ˆè´¹è¿›åº¦" data-id="heading-47"><a href="#8ã€Consumer-æ¶ˆè´¹è¿›åº¦" title="8ã€Consumer æ¶ˆè´¹è¿›åº¦"></a>8ã€Consumer æ¶ˆè´¹è¿›åº¦</h1>
    <h2 id="OffsetStore" data-id="heading-48"><a href="#OffsetStore" title="OffsetStore"></a>OffsetStore</h2>
    <p><img alt="OffsetStoreç±»å›¾.png" class="lazyload inited" data-src="https://user-gold-cdn.xitu.io/2018/10/21/166937eb48426e1d?imageView2/0/w/1280/h/960/ignore-error/1" data-width="904" data-height="480" src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;904&quot; height=&quot;480&quot;&gt;&lt;/svg&gt;"></p>
    <ul>
        <li><code>RemoteBrokerOffsetStore</code> ï¼š<code>Consumer</code> <strong>é›†ç¾¤æ¨¡å¼</strong> ä¸‹ï¼Œä½¿ç”¨è¿œç¨‹ <code>Broker</code> æ¶ˆè´¹è¿›åº¦ã€‚</li>
        <li><code>LocalFileOffsetStore</code> ï¼š<code>Consumer</code> <strong>å¹¿æ’­æ¨¡å¼</strong>ä¸‹ï¼Œä½¿ç”¨æœ¬åœ° <code>æ–‡ä»¶</code> æ¶ˆè´¹è¿›åº¦ã€‚</li>
    </ul>
    <h3 id="OffsetStore-load-â€¦" data-id="heading-49"><a href="#OffsetStore-load-â€¦" title="OffsetStore#load(â€¦)"></a>OffsetStore#load(â€¦)</h3>
    <h4 id="LocalFileOffsetStore-load-â€¦" data-id="heading-50"><a href="#LocalFileOffsetStore-load-â€¦" title="LocalFileOffsetStore#load(â€¦)"></a>LocalFileOffsetStore#load(â€¦)</h4>
    <pre><code> 1: @Override
 2: public void load() throws MQClientException {
 3:     // ä»æœ¬åœ°ç¡¬ç›˜è¯»å–æ¶ˆè´¹è¿›åº¦
 4:     OffsetSerializeWrapper offsetSerializeWrapper = this.readLocalOffset();
 5:     if (offsetSerializeWrapper != null &amp;&amp; offsetSerializeWrapper.getOffsetTable() != null) {
 6:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());
 7: 
 8:         // æ‰“å°æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦
 9:         for (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) {
10:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);
11:             log.info("load consumer's offset, {} {} {}",
12:                 this.groupName,
13:                 mq,
14:                 offset.get());
15:         }
16:     }
17: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ¶ˆè´¹è¿›åº¦åˆ°å†…å­˜ã€‚</li>
    </ul>
    <h5 id="OffsetSerializeWrapper" data-id="heading-51"><a href="#OffsetSerializeWrapper" title="OffsetSerializeWrapper"></a>OffsetSerializeWrapper</h5>
    <pre><code> 1: public class OffsetSerializeWrapper extends RemotingSerializable {
 2:     private ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable =
 3:             new ConcurrentHashMap&lt;&gt;();
 4: 
 5:     public ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; getOffsetTable() {
 6:         return offsetTable;
 7:     }
 8: 
 9:     public void setOffsetTable(ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable) {
10:         this.offsetTable = offsetTable;
11:     }
12: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæœ¬åœ° <code>Offset</code> å­˜å‚¨åºåˆ—åŒ–ã€‚</li>
    </ul>
    <pre><code>Yunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json
{
	"offsetTable":{{
			"brokerName":"broker-a",
			"queueId":3,
			"topic":"TopicTest"
		}:1470,{
			"brokerName":"broker-a",
			"queueId":2,
			"topic":"TopicTest"
		}:1471,{
			"brokerName":"broker-a",
			"queueId":1,
			"topic":"TopicTest"
		}:1470,{
			"brokerName":"broker-a",
			"queueId":0,
			"topic":"TopicTest"
		}:1470
	}
}
</code></pre>
    <h4 id="RemoteBrokerOffsetStore-load-â€¦" data-id="heading-52"><a href="#RemoteBrokerOffsetStore-load-â€¦" title="RemoteBrokerOffsetStore#load(â€¦)"></a>RemoteBrokerOffsetStore#load(â€¦)</h4>
    <pre><code>1: @Override
2: public void load() {
3: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šä¸è¿›è¡ŒåŠ è½½ï¼Œå®é™…è¯»å–æ¶ˆè´¹è¿›åº¦æ—¶ï¼Œä» <code>Broker</code> è·å–ã€‚</li>
    </ul>
    <h3 id="OffsetStore-readOffset-â€¦" data-id="heading-53"><a href="#OffsetStore-readOffset-â€¦" title="OffsetStore#readOffset(â€¦)"></a>OffsetStore#readOffset(â€¦)</h3>
    <p>è¯»å–æ¶ˆè´¹è¿›åº¦ç±»å‹ï¼š</p>
    <ul>
        <li><code>READ_FROM_MEMORY</code> ï¼šä»å†…å­˜è¯»å–ã€‚</li>
        <li><code>READ_FROM_STORE</code> ï¼šä»å­˜å‚¨( <code>Broker</code> æˆ– <code>æ–‡ä»¶</code> )è¯»å–ã€‚</li>
        <li><code>MEMORY_FIRST_THEN_STORE</code> ï¼šä¼˜å…ˆä»å†…å­˜è¯»å–ï¼Œè¯»å–ä¸åˆ°ï¼Œä»å­˜å‚¨è¯»å–ã€‚</li>
    </ul>
    <h4 id="LocalFileOffsetStore-readOffset-â€¦" data-id="heading-54"><a href="#LocalFileOffsetStore-readOffset-â€¦" title="LocalFileOffsetStore#readOffset(â€¦)"></a>LocalFileOffsetStore#readOffset(â€¦)</h4>
    <pre><code> 1: @Override
 2: public long readOffset(final MessageQueue mq, final ReadOffsetType type) {
 3:     if (mq != null) {
 4:         switch (type) {
 5:             case MEMORY_FIRST_THEN_STORE:
 6:             case READ_FROM_MEMORY: {
 7:                 AtomicLong offset = this.offsetTable.get(mq);
 8:                 if (offset != null) {
 9:                     return offset.get();
10:                 } else if (ReadOffsetType.READ_FROM_MEMORY == type) {
11:                     return -1;
12:                 }
13:             }
14:             case READ_FROM_STORE: {
15:                 OffsetSerializeWrapper offsetSerializeWrapper;
16:                 try {
17:                     offsetSerializeWrapper = this.readLocalOffset();
18:                 } catch (MQClientException e) {
19:                     return -1;
20:                 }
21:                 if (offsetSerializeWrapper != null &amp;&amp; offsetSerializeWrapper.getOffsetTable() != null) {
22:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);
23:                     if (offset != null) {
24:                         this.updateOffset(mq, offset.get(), false);
25:                         return offset.get();
26:                     }
27:                 }
28:             }
29:             default:
30:                 break;
31:         }
32:     }
33: 
34:     return -1;
35: }
</code></pre>
    <ul>
        <li>ç¬¬ 16 è¡Œ ï¼šä» <code>æ–‡ä»¶</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li>
    </ul>
    <h4 id="RemoteBrokerOffsetStore-readOffset-â€¦" data-id="heading-55"><a href="#RemoteBrokerOffsetStore-readOffset-â€¦" title="RemoteBrokerOffsetStore#readOffset(â€¦)"></a>RemoteBrokerOffsetStore#readOffset(â€¦)</h4>
    <pre><code> 1: @Override
 2: public long readOffset(final MessageQueue mq, final ReadOffsetType type) {
 3:     if (mq != null) {
 4:         switch (type) {
 5:             case MEMORY_FIRST_THEN_STORE:
 6:             case READ_FROM_MEMORY: {
 7:                 AtomicLong offset = this.offsetTable.get(mq);
 8:                 if (offset != null) {
 9:                     return offset.get();
10:                 } else if (ReadOffsetType.READ_FROM_MEMORY == type) {
11:                     return -1;
12:                 }
13:             }
14:             case READ_FROM_STORE: {
15:                 try {
16:                     long brokerOffset = this.fetchConsumeOffsetFromBroker(mq);
17:                     AtomicLong offset = new AtomicLong(brokerOffset);
18:                     this.updateOffset(mq, offset.get(), false);
19:                     return brokerOffset;
20:                 }
21:                 // No offset in broker
22:                 catch (MQBrokerException e) {
23:                     return -1;
24:                 }
25:                 //Other exceptions
26:                 catch (Exception e) {
27:                     log.warn("fetchConsumeOffsetFromBroker exception, " + mq, e);
28:                     return -2;
29:                 }
30:             }
31:             default:
32:                 break;
33:         }
34:     }
35: 
36:     return -1;
37: }
</code></pre>
    <ul>
        <li>ç¬¬ 16 è¡Œ ï¼šä» <code>Broker</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li>
    </ul>
    <h3 id="OffsetStore-updateOffset-â€¦" data-id="heading-56"><a href="#OffsetStore-updateOffset-â€¦" title="OffsetStore#updateOffset(â€¦)"></a>OffsetStore#updateOffset(â€¦)</h3>
    <p>è¯¥æ–¹æ³• <code>RemoteBrokerOffsetStore</code> ä¸ <code>LocalFileOffsetStore</code> å®ç°ç›¸åŒã€‚</p>
    <pre><code> 1: @Override
 2: public void updateOffset(MessageQueue mq, long offset, boolean increaseOnly) {
 3:     if (mq != null) {
 4:         AtomicLong offsetOld = this.offsetTable.get(mq);
 5:         if (null == offsetOld) {
 6:             offsetOld = this.offsetTable.putIfAbsent(mq, new AtomicLong(offset));
 7:         }
 8: 
 9:         if (null != offsetOld) {
10:             if (increaseOnly) {
11:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);
12:             } else {
13:                 offsetOld.set(offset);
14:             }
15:         }
16:     }
17: }
</code></pre>
    <h3 id="OffsetStore-persistAll-â€¦" data-id="heading-57"><a href="#OffsetStore-persistAll-â€¦" title="OffsetStore#persistAll(â€¦)"></a>OffsetStore#persistAll(â€¦)</h3>
    <h4 id="LocalFileOffsetStore-persistAll-â€¦" data-id="heading-58"><a href="#LocalFileOffsetStore-persistAll-â€¦" title="LocalFileOffsetStore#persistAll(â€¦)"></a>LocalFileOffsetStore#persistAll(â€¦)</h4>
    <pre><code> 1: @Override
 2: public void persistAll(Set&lt;MessageQueue&gt; mqs) {
 3:     if (null == mqs || mqs.isEmpty())
 4:         return;
 5: 
 6:     OffsetSerializeWrapper offsetSerializeWrapper = new OffsetSerializeWrapper();
 7:     for (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : this.offsetTable.entrySet()) {
 8:         if (mqs.contains(entry.getKey())) {
 9:             AtomicLong offset = entry.getValue();
10:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);
11:         }
12:     }
13: 
14:     String jsonString = offsetSerializeWrapper.toJson(true);
15:     if (jsonString != null) {
16:         try {
17:             MixAll.string2File(jsonString, this.storePath);
18:         } catch (IOException e) {
19:             log.error("persistAll consumer offset Exception, " + this.storePath, e);
20:         }
21:     }
22: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ã€‚<strong>å°†æ¶ˆè´¹è¿›åº¦å†™å…¥æ–‡ä»¶</strong>ã€‚</li>
    </ul>
    <h4 id="RemoteBrokerOffsetStore-persistAll-â€¦" data-id="heading-59"><a href="#RemoteBrokerOffsetStore-persistAll-â€¦" title="RemoteBrokerOffsetStore#persistAll(â€¦)"></a>RemoteBrokerOffsetStore#persistAll(â€¦)</h4>
    <pre><code> 1: @Override
 2: public void persistAll(Set&lt;MessageQueue&gt; mqs) {
 3:     if (null == mqs || mqs.isEmpty())
 4:         return;
 5: 
 6:     // æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—
 7:     final HashSet&lt;MessageQueue&gt; unusedMQ = new HashSet&lt;&gt;();
 8:     if (!mqs.isEmpty()) {
 9:         for (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : this.offsetTable.entrySet()) {
10:             MessageQueue mq = entry.getKey();
11:             AtomicLong offset = entry.getValue();
12:             if (offset != null) {
13:                 if (mqs.contains(mq)) {
14:                     try {
15:                         this.updateConsumeOffsetToBroker(mq, offset.get());
16:                         log.info("[persistAll] Group: {} ClientId: {} updateConsumeOffsetToBroker {} {}",
17:                             this.groupName,
18:                             this.mQClientFactory.getClientId(),
19:                             mq,
20:                             offset.get());
21:                     } catch (Exception e) {
22:                         log.error("updateConsumeOffsetToBroker exception, " + mq.toString(), e);
23:                     }
24:                 } else {
25:                     unusedMQ.add(mq);
26:                 }
27:             }
28:         }
29:     }
30: 
31:     // ç§»é™¤ä¸é€‚ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—
32:     if (!unusedMQ.isEmpty()) {
33:         for (MessageQueue mq : unusedMQ) {
34:             this.offsetTable.remove(mq);
35:             log.info("remove unused mq, {}, {}", mq, this.groupName);
36:         }
37:     }
38: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šæŒä¹…åŒ–æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„çš„æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ï¼Œå¹¶ç§»é™¤éæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
    </ul>
    <h4 id="MQClientInstance-persistAllConsumerOffset-â€¦" data-id="heading-60"><a href="#MQClientInstance-persistAllConsumerOffset-â€¦" title="MQClientInstance#persistAllConsumerOffset(â€¦)"></a>MQClientInstance#persistAllConsumerOffset(â€¦)</h4>
    <pre><code> 1: private void startScheduledTask() {
 2:     // å®šæ—¶åŒæ­¥æ¶ˆè´¹è¿›åº¦
 3:     this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {
 4: 
 5:         @Override
 6:         public void run() {
 7:             try {
 8:                 MQClientInstance.this.cleanOfflineBroker();
 9:                 MQClientInstance.this.sendHeartbeatToAllBrokerWithLock();
10:             } catch (Exception e) {
11:                 log.error("ScheduledTask sendHeartbeatToAllBroker exception", e);
12:             }
13:         }
14:     }, 1000, this.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);
15: }
</code></pre>
    <ul>
        <li>è¯´æ˜ ï¼šå®šæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œé»˜è®¤å‘¨æœŸï¼š5000msã€‚</li>
        <li><strong>é‡è¦è¯´æ˜ ï¼š</strong>
            <ul>
                <li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong> </li>
                <li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong> </li>
                <li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong> </li>
            </ul>
        </li>
    </ul>
    <h1 id="9ã€ç»“å°¾" data-id="heading-61"><a href="#9ã€ç»“å°¾" title="9ã€ç»“å°¾"></a>9ã€ç»“å°¾</h1>
    <p><img alt="çŸ¥è¯†æ˜Ÿçƒ" class="lazyload inited" data-src="https://user-gold-cdn.xitu.io/2018/10/18/166840b9e1e4b9c1?imageView2/0/w/1280/h/960/ignore-error/1" data-width="987" data-height="555" src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;987&quot; height=&quot;555&quot;&gt;&lt;/svg&gt;"></p>
    <p>ğŸ˜ˆå¯èƒ½æ˜¯æœ¬ç³»åˆ—æœ€é•¿çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœ‰è¡¨è¾¾é”™è¯¯å’Œä¸æ¸…æ™°ï¼Œè¯·å¤šå¤šè§è°…ã€‚<br>æ„Ÿè°¢å¯¹æœ¬ç³»åˆ—çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯ç¿»åˆ°ç»“å°¾ã€‚ğŸ˜œçœŸçš„æœ‰ä¸¢ä¸¢é•¿ã€‚</p>
</div><div data-v-41d33d72="" class="footer"><ul data-v-41d33d72="" class="tag-list"><li data-v-41d33d72="" class="item"><a data-v-41d33d72="" href="/tag/Java" class="">Java</a></li></ul><section data-v-41d33d72=""><div data-v-a0f279e6="" data-v-41d33d72="" class="wechat-banner wechat-banner"><img data-v-a0f279e6="" src="https://b-gold-cdn.xitu.io/v3/static/img/backend.58ef824.png" class="wechat-img"></div></section><!----><div data-v-41d33d72="" class="related-entry-list-box"><div data-v-41d33d72="" class="title">ç›¸å…³çƒ­é—¨æ–‡ç« </div><ul data-v-41d33d72="" class="related-entry-list"><li data-v-41d33d72="" class="item"><div data-v-9db545a6="" data-v-41d33d72="" st:block="relatedEntry" class="related-entry related-entry"><a data-v-9db545a6="" href="/entry/5bcc88c46fb9a05d3c803037/detail" target="_blank" rel="" st:name="link" class="entry-link"><div data-v-b2db8566="" data-v-009ea7bb="" data-v-9db545a6="" data-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAACgBAMAAACPjaivAAAAElBMVEXi6O3////R3ujj6e/c5u3X4usQB3wbAAABCElEQVR42u3Vy03FQBBE0U6BDBCfPSEQAvlHw44FmvaoEbJLz+dGcORWeUqSJEmSJEmS/trTphoGCAi4CRAQcNMtgfUrQMDjbjgSQMBJgIDTjgyAj3JiQMBJtwTG/2bigfEnBgScdEtg/G8mHhh/YkDASYCAgJsAAQE3AQICbgIEBNwECPgvwJef3mrY2cCvGnY28KOGnQx8rcs7Btb1LYE5E2mAORNpgEEXXgNzJtIAgz7gGpgzkQaYM5EGmPKKtMCciRwBPyuiFvheGS2BQRdeA3Mm0gOfK6QlMGciDTBnIg0w6MJrYM5EGmDQB1wDcybSAHMm0gBTXpEWmDMRSZIkSZIk6cK+AUdTxLnCoi0gAAAAAElFTkSuQmCC" class="lazy thumb thumb loaded" style="background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAACgBAMAAACPjaivAAAAElBMVEXi6O3////R3ujj6e/c5u3X4usQB3wbAAABCElEQVR42u3Vy03FQBBE0U6BDBCfPSEQAvlHw44FmvaoEbJLz+dGcORWeUqSJEmSJEmS/trTphoGCAi4CRAQcNMtgfUrQMDjbjgSQMBJgIDTjgyAj3JiQMBJtwTG/2bigfEnBgScdEtg/G8mHhh/YkDASYCAgJsAAQE3AQICbgIEBNwECPgvwJef3mrY2cCvGnY28KOGnQx8rcs7Btb1LYE5E2mAORNpgEEXXgNzJtIAgz7gGpgzkQaYM5EGmPKKtMCciRwBPyuiFvheGS2BQRdeA3Mm0gOfK6QlMGciDTBnIg0w6MJrYM5EGmDQB1wDcybSAHMm0gBTXpEWmDMRSZIkSZIk6cK+AUdTxLnCoi0gAAAAAElFTkSuQmCC); background-size: cover;"></div><div data-v-9db545a6="" class="info"><div data-v-9db545a6="" class="row title-row"><span data-v-9db545a6="" class="title">è¯¦è§£JVMå¦‚ä½•å¤„ç†å¼‚å¸¸</span></div><div data-v-9db545a6="" class="row meta-row"><ul data-v-9db545a6="" class="meta-list"><li data-v-9db545a6="" class="meta user"><div data-v-9db545a6="" class="username">æŠ€æœ¯å°é»‘å±‹</div></li><li data-v-9db545a6="" class="meta like"><div data-v-9db545a6="" class="icon icon-likes iconfont icon-xlcollection"></div><div data-v-9db545a6="" class="count">4</div></li><!----></ul></div></div></a></div></li><li data-v-41d33d72="" class="item"><div data-v-9db545a6="" data-v-41d33d72="" st:block="relatedEntry" class="related-entry related-entry"><a data-v-9db545a6="" href="/post/5bcc90866fb9a05cea7fc51e" target="_blank" rel="" st:name="link" class="entry-link"><div data-v-b2db8566="" data-v-009ea7bb="" data-v-9db545a6="" data-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAACgBAMAAACPjaivAAAAElBMVEXi6O3////R3ujj6e/c5u3X4usQB3wbAAABCElEQVR42u3Vy03FQBBE0U6BDBCfPSEQAvlHw44FmvaoEbJLz+dGcORWeUqSJEmSJEmS/trTphoGCAi4CRAQcNMtgfUrQMDjbjgSQMBJgIDTjgyAj3JiQMBJtwTG/2bigfEnBgScdEtg/G8mHhh/YkDASYCAgJsAAQE3AQICbgIEBNwECPgvwJef3mrY2cCvGnY28KOGnQx8rcs7Btb1LYE5E2mAORNpgEEXXgNzJtIAgz7gGpgzkQaYM5EGmPKKtMCciRwBPyuiFvheGS2BQRdeA3Mm0gOfK6QlMGciDTBnIg0w6MJrYM5EGmDQB1wDcybSAHMm0gBTXpEWmDMRSZIkSZIk6cK+AUdTxLnCoi0gAAAAAElFTkSuQmCC" class="lazy thumb thumb loaded" style="background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAACgBAMAAACPjaivAAAAElBMVEXi6O3////R3ujj6e/c5u3X4usQB3wbAAABCElEQVR42u3Vy03FQBBE0U6BDBCfPSEQAvlHw44FmvaoEbJLz+dGcORWeUqSJEmSJEmS/trTphoGCAi4CRAQcNMtgfUrQMDjbjgSQMBJgIDTjgyAj3JiQMBJtwTG/2bigfEnBgScdEtg/G8mHhh/YkDASYCAgJsAAQE3AQICbgIEBNwECPgvwJef3mrY2cCvGnY28KOGnQx8rcs7Btb1LYE5E2mAORNpgEEXXgNzJtIAgz7gGpgzkQaYM5EGmPKKtMCciRwBPyuiFvheGS2BQRdeA3Mm0gOfK6QlMGciDTBnIg0w6MJrYM5EGmDQB1wDcybSAHMm0gBTXpEWmDMRSZIkSZIk6cK+AUdTxLnCoi0gAAAAAElFTkSuQmCC); background-size: cover;"></div><div data-v-9db545a6="" class="info"><div data-v-9db545a6="" class="row title-row"><span data-v-9db545a6="" class="title">2018 å¹´ç¬¬ 42 å‘¨æ²¸ç‚¹çœ‹ç‚¹ï¼šå¼€å‘éœ€æ±‚ï¼Œè¯·ç”¨æ•°æ®è¯´è¯</span></div><div data-v-9db545a6="" class="row meta-row"><ul data-v-9db545a6="" class="meta-list"><li data-v-9db545a6="" class="meta user"><div data-v-9db545a6="" class="username">æ²¸ç‚¹æ—¥æŠ¥å‘˜</div></li><li data-v-9db545a6="" class="meta like"><div data-v-9db545a6="" class="icon icon-likes iconfont icon-xlcollection"></div><div data-v-9db545a6="" class="count">3</div></li><!----></ul></div></div></a></div></li><li data-v-41d33d72="" class="item"><div data-v-9db545a6="" data-v-41d33d72="" st:block="relatedEntry" class="related-entry related-entry"><a data-v-9db545a6="" href="/entry/5bca54015188255c63763d6a/detail" target="_blank" rel="" st:name="link" class="entry-link"><div data-v-b2db8566="" data-v-009ea7bb="" data-v-9db545a6="" data-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAACgBAMAAACPjaivAAAAElBMVEXi6O3////R3ujj6e/c5u3X4usQB3wbAAABCElEQVR42u3Vy03FQBBE0U6BDBCfPSEQAvlHw44FmvaoEbJLz+dGcORWeUqSJEmSJEmS/trTphoGCAi4CRAQcNMtgfUrQMDjbjgSQMBJgIDTjgyAj3JiQMBJtwTG/2bigfEnBgScdEtg/G8mHhh/YkDASYCAgJsAAQE3AQICbgIEBNwECPgvwJef3mrY2cCvGnY28KOGnQx8rcs7Btb1LYE5E2mAORNpgEEXXgNzJtIAgz7gGpgzkQaYM5EGmPKKtMCciRwBPyuiFvheGS2BQRdeA3Mm0gOfK6QlMGciDTBnIg0w6MJrYM5EGmDQB1wDcybSAHMm0gBTXpEWmDMRSZIkSZIk6cK+AUdTxLnCoi0gAAAAAElFTkSuQmCC" class="lazy thumb thumb loaded" style="background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAACgBAMAAACPjaivAAAAElBMVEXi6O3////R3ujj6e/c5u3X4usQB3wbAAABCElEQVR42u3Vy03FQBBE0U6BDBCfPSEQAvlHw44FmvaoEbJLz+dGcORWeUqSJEmSJEmS/trTphoGCAi4CRAQcNMtgfUrQMDjbjgSQMBJgIDTjgyAj3JiQMBJtwTG/2bigfEnBgScdEtg/G8mHhh/YkDASYCAgJsAAQE3AQICbgIEBNwECPgvwJef3mrY2cCvGnY28KOGnQx8rcs7Btb1LYE5E2mAORNpgEEXXgNzJtIAgz7gGpgzkQaYM5EGmPKKtMCciRwBPyuiFvheGS2BQRdeA3Mm0gOfK6QlMGciDTBnIg0w6MJrYM5EGmDQB1wDcybSAHMm0gBTXpEWmDMRSZIkSZIk6cK+AUdTxLnCoi0gAAAAAElFTkSuQmCC); background-size: cover;"></div><div data-v-9db545a6="" class="info"><div data-v-9db545a6="" class="row title-row"><span data-v-9db545a6="" class="title">åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰</span></div><div data-v-9db545a6="" class="row meta-row"><ul data-v-9db545a6="" class="meta-list"><li data-v-9db545a6="" class="meta user"><div data-v-9db545a6="" class="username">Javaå…¬ä¼—å·_èŠ‹é“æºç _æ¯æ—¥æ›´æ–°</div></li><li data-v-9db545a6="" class="meta like"><div data-v-9db545a6="" class="icon icon-likes iconfont icon-xlcollection"></div><div data-v-9db545a6="" class="count">31</div></li><!----></ul></div></div></a></div></li><li data-v-41d33d72="" class="item"><div data-v-9db545a6="" data-v-41d33d72="" st:block="relatedEntry" class="related-entry related-entry"><a data-v-9db545a6="" href="/post/5bc75096f265da0aa94a4043" target="_blank" rel="" st:name="link" class="entry-link"><div data-v-b2db8566="" data-v-009ea7bb="" data-v-9db545a6="" data-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAACgBAMAAACPjaivAAAAElBMVEXi6O3////R3ujj6e/c5u3X4usQB3wbAAABCElEQVR42u3Vy03FQBBE0U6BDBCfPSEQAvlHw44FmvaoEbJLz+dGcORWeUqSJEmSJEmS/trTphoGCAi4CRAQcNMtgfUrQMDjbjgSQMBJgIDTjgyAj3JiQMBJtwTG/2bigfEnBgScdEtg/G8mHhh/YkDASYCAgJsAAQE3AQICbgIEBNwECPgvwJef3mrY2cCvGnY28KOGnQx8rcs7Btb1LYE5E2mAORNpgEEXXgNzJtIAgz7gGpgzkQaYM5EGmPKKtMCciRwBPyuiFvheGS2BQRdeA3Mm0gOfK6QlMGciDTBnIg0w6MJrYM5EGmDQB1wDcybSAHMm0gBTXpEWmDMRSZIkSZIk6cK+AUdTxLnCoi0gAAAAAElFTkSuQmCC" class="lazy thumb thumb loaded" style="background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAACgBAMAAACPjaivAAAAElBMVEXi6O3////R3ujj6e/c5u3X4usQB3wbAAABCElEQVR42u3Vy03FQBBE0U6BDBCfPSEQAvlHw44FmvaoEbJLz+dGcORWeUqSJEmSJEmS/trTphoGCAi4CRAQcNMtgfUrQMDjbjgSQMBJgIDTjgyAj3JiQMBJtwTG/2bigfEnBgScdEtg/G8mHhh/YkDASYCAgJsAAQE3AQICbgIEBNwECPgvwJef3mrY2cCvGnY28KOGnQx8rcs7Btb1LYE5E2mAORNpgEEXXgNzJtIAgz7gGpgzkQaYM5EGmPKKtMCciRwBPyuiFvheGS2BQRdeA3Mm0gOfK6QlMGciDTBnIg0w6MJrYM5EGmDQB1wDcybSAHMm0gBTXpEWmDMRSZIkSZIk6cK+AUdTxLnCoi0gAAAAAElFTkSuQmCC); background-size: cover;"></div><div data-v-9db545a6="" class="info"><div data-v-9db545a6="" class="row title-row"><span data-v-9db545a6="" class="title">èŠä¸€èŠ RestTemplate</span></div><div data-v-9db545a6="" class="row meta-row"><ul data-v-9db545a6="" class="meta-list"><li data-v-9db545a6="" class="meta user"><div data-v-9db545a6="" class="username">glmapper</div></li><li data-v-9db545a6="" class="meta like"><div data-v-9db545a6="" class="icon icon-likes iconfont icon-xlcollection"></div><div data-v-9db545a6="" class="count">28</div></li><!----></ul></div></div></a></div></li></ul></div></div></article><div data-v-4f97d566="" data-v-41d33d72="" class="comment-list-box" id="comment-box" data-v-3f216172=""><div data-v-4f97d566="" class="title">è¯„è®º</div><div data-v-1cbbd4f0="" data-v-4f97d566="" class="comment-form comment-form"><div data-v-1cbbd4f0="" class="avatar-box"><div data-v-b2db8566="" data-v-1b9df826="" data-v-1cbbd4f0="" data-src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjM2cHgiIGhlaWdodD0iMzZweCIgdmlld0JveD0iMCAwIDM2IDM2IiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggMy4zLjMgKDEyMDgxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5kZWZhdWx0X2dyYXZhdGFyPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+PC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCIgc2tldGNoOnR5cGU9Ik1TUGFnZSI+CiAgICAgICAgPGcgaWQ9ImRlZmF1bHRfZ3JhdmF0YXIiIHNrZXRjaDp0eXBlPSJNU0FydGJvYXJkR3JvdXAiPgogICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLTIxMC0rLUltcG9ydGVkLUxheWVycy1Db3B5LUNvcHkiIHNrZXRjaDp0eXBlPSJNU0xheWVyR3JvdXAiPgogICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0yMTAiIGZpbGw9IiNEOEQ4RDgiIHNrZXRjaDp0eXBlPSJNU1NoYXBlR3JvdXAiIHg9IjAiIHk9IjAiIHdpZHRoPSIzNiIgaGVpZ2h0PSIzNiI+PC9yZWN0PgogICAgICAgICAgICAgICAgPHBhdGggZD0iTTI3Ljg2OTAzMjEsMjYuODUzNjU2OCBMOCwyNi44NTM2NTY4IEM4LDI1Ljg0OTQ1MTQgOC40NzE4MjUsMjQuMTEwOTQ2NiAxMS41MTg5MDQ1LDIyLjM4ODMxNzYgQzEyLjE1Nzg5NiwyMi4wMjcxMjEzIDE1LjM0Mzk1MTIsMjAuMDk2MTA5OCAxNS42MTU5Njc3LDE5LjYzNzE3MjEgQzE1LjkyNDU4MjgsMTkuMTE3MjA4MSAxNi4wMTA2Mzg5LDE4LjQ3NjE4MzcgMTUuNDIwMTE1OCwxNy41MzI1MDg1IEMxNS4zNzI2MzY2LDE3LjQ1NjEwMTYgMTQuNDM0OTIxNSwxNi4wMDgzMzkxIDE0LjE0NTEwMDMsMTUuMDMwNDI5NyBDMTMuOTQwMzQ2LDE0LjMzODMwMiAxMy45MTc1OTU1LDEzLjU0NTQ1NjEgMTMuOTE3NTk1NSwxMi43MTM0MTQ0IEMxMy45MTc1OTU1LDkuODM2MjQ3MDIgMTUuNzIyMzAxNCw4IDE3Ljk0ODM4NTYsOCBDMjAuMTc0NDY5OSw4IDIxLjk3OTE3NTgsOS44MzYyNDcwMiAyMS45NzkxNzU4LDEyLjcxMzQxNDQgQzIxLjk3OTE3NTgsMTMuMzk5MDkyMiAyMS45NjYzMTY4LDE0LjA1NTk5MzMgMjEuODQ3MTI0MSwxNC42NTM4NTI3IEMyMS42Mzk4OTcsMTUuNjkwMzA3NyAyMC43NzU4NzM2LDE3LjAwNTU5ODQgMjAuNTg4NDI5NSwxNy4zMzA1NzU5IEMyMC41NDM5MTc3LDE3LjQwNzQ3OSAyMC41MDc4MTM3LDE3LjQ2NzUxMyAyMC40ODUwNjMzLDE3LjUwMTI1MTEgQzIwLjA3OTAxNjgsMTguMTA3MDQ4OSAxOS45NjI3OTE2LDE4LjU1MzU4MjkgMjAuMDAwODczOSwxOC45MTUyNzU1IEMyMC4wNDQzOTY1LDE5LjMyODU2NzUgMjAuMzEzOTQwMSwxOS42MTYzMzM4IDIwLjY2NzA2NywxOS44NTQ0ODUzIEMyMS4wMzQ1MzY2LDIwLjEwMjA2MzYgMjQuMDExODgxLDIyLjE0OTY3IDI0LjM3Nzg2NjgsMjIuMzg4MzE3NiBDMjYuODcxNTE2MywyNC4wMTY2NzgzIDI3Ljg2OTAzMjEsMjUuNjA2MzM4NSAyNy44NjkwMzIxLDI2Ljg1MzY1NjggTDI3Ljg2OTAzMjEsMjYuODUzNjU2OCBaIiBpZD0iSW1wb3J0ZWQtTGF5ZXJzLUNvcHkiIGZpbGw9IiNGRkZGRkYiIHNrZXRjaDp0eXBlPSJNU1NoYXBlR3JvdXAiPjwvcGF0aD4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" class="lazy avatar avatar" title="" style="background-image: none;"></div></div><div data-v-1cbbd4f0="" class="form-box"><div data-v-1cbbd4f0="" class="input-box"><div data-v-1cbbd4f0="" contenteditable="true" spellcheck="false" placeholder="è¾“å…¥è¯„è®º..." class="rich-input empty"><br data-v-1cbbd4f0=""></div><!----></div><!----></div><input data-v-1cbbd4f0="" type="file" class="hidden"></div><!----><!----></div></div><div data-v-41d33d72="" data-v-3f216172="" st:block="aside" class="entry-public-aside"><div data-v-70a2cd6d="" data-v-fb64097a="" data-v-41d33d72="" class="sidebar-block app-download-sidebar-block shadow"><!----><div data-v-70a2cd6d="" class="block-body"><a data-v-fb64097a="" data-v-70a2cd6d="" class="app-link" href="https://juejin.im/app" target="_blank"><img data-v-fb64097a="" data-v-70a2cd6d="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAEx0lEQVR4Xu2c7XbbMAxD0zffm2cna7NlbuwLkJJjN+hfUiQF8ENS0nxcr9frJX+HQeDjRsjHr/3juT74fOb/Ub6MTomX7C9tdv2NQjCEfCEZQlIhT4sqFZIK+UTA7fFuj+7a7653473rr1bIVk91ndHQVob01hAm+xQvrSc52Sf5o/0QcrlcCHCSE+AkDyELhAhwkhPgJLcJmd1SKvZpk26Lc/W7M2ZtvdSyKoBRwM6Mqvh3AXb1aX+UMCEE7j0hxHiuSYUMuCdQSe/dsqiFpEKaFdJ9e+omBCUcJcCPmyEhhChfyCmDRmboMjRl5oz0r/hTW+Ihjr2VDakbVPPIrThKOPJ76Ja1ByEEYAgx7wXVjLuvCyHGB1CpkH/p9jYz5EdVCLULktNrKcmVU5RzaqJ49/Znv/a6G3A3FELMlhVCviMwsiKlCumSQOudnl4Z+l37tJ72V5Wf4lsn1NJeIa8CTutCSPEzdQK2Kg8hIeQzd6hHk5wykNZ35eS/Kv9TIdXFo9ZVZgD5HnkKIl8j5SFkJJoDbIWQASCONFEe6u5z9TJo6uEjN/nMVjd+iq9q/7SEVDd8B7K7PoQsEOgC2l0fQkLIdg6cfQbsHb/q7+kpS3nMUx0869mK/dEtwW1Ro/en2gshg55OCHCS3xMwhLwrIdSCunLKQJLP9q/aH1IhS2fKjCCAOj2fNj/77ayz/xDyxR4lCJHsrl/TDyEh5BOBURmlHqvJH8mpQlz5rhXiBuf2XLJPM6KyntaQXP18ZkrLouC6hwCyH0IIIZCnQv4BNKRCFECXnLg929Xf8kf5U9kP2VSP8UM+MaxswAXY1e8QMrulbtkPIZTaK08rswgPIWckhE4tZ29ZI/anHmtv/G/hJVUIBaz0XHWoPbvoURK78bnxdu0r/u46IaT4/O5URAhZPM10K2z3CtljBhAorrx7DCZ/s+2v+R/yvSzKoArhrwbMnXkUr3oxDiErSIYQM8Vmt5QQYhIyW31Pwr/90+fszbn2R8wcAtQ5tirxOPa28JDuIS6gXX0FAPIRQgghQ/72hCgAUMapxzqDl6mq7n7cYNxDwV1fPva6G3D1XULdDbv2XQK27CtPJyFk8O91hZCNXzWd0YLdinEr+O0rxAXY1a+27EMce+ktzAVDqRCy6dwrKH5HHkIKb1nOkL7phhDjV7PXKuWlFTKixKkFuMdOtwe7+hQv2SN51b58DyEHrrybgc4xU2kxeybMVjwhRJghzgyotMBvr72vbllUXUp8Myvu7QhRACfSqKeTfM+Whd/LogwgMEhO9iuEVG/Ca8fQ0TPJje/uX/plawKc5CHkf4RSIc1/oesmnHPKkyqk21JmVAiB5M4E156rr86wQxDibm5GgrgxuPohZIGYCogLtKqv+k+FqIg29X4UIZUWdbQZovJ5igqpHAq6N/fqPUIFfi1hQojweYVzbA0hBUAVgN+6QiozQh2S1Yx91Qw6RMs6GyEzKyyEiCXktjBX33pcnJHB3ZbTXS/y8FfNBdjVPz0hLqB7608lpLuZ7j1iRoXOHtrOPegxFmmGhBAfgRDSfEwcPZOGE+LnhLeCACC55+312upMOcTXgLozRrkXuDOjmuE3P7SfrXhDSAFAqrcOIb8BQLPhcIRSNNMAAAAASUVORK5CYII=" class="qr-img"><div data-v-fb64097a="" data-v-70a2cd6d="" class="content-box"><div data-v-fb64097a="" data-v-70a2cd6d="" class="headline">ä¸‹è½½æ˜é‡‘å®¢æˆ·ç«¯</div><div data-v-fb64097a="" data-v-70a2cd6d="" class="desc">ä¸€ä¸ªå¸®åŠ©å¼€å‘è€…æˆé•¿çš„ç¤¾åŒº</div></div><!----></a></div></div><div data-v-70a2cd6d="" data-v-1988842d="" data-v-41d33d72="" class="sidebar-block wechat-sidebar-block pure"><div data-v-a0f279e6="" data-v-1988842d="" class="wechat-banner" data-v-70a2cd6d=""><img data-v-a0f279e6="" src="https://b-gold-cdn.xitu.io/v3/static/img/backend.ba44b94.png" class="wechat-img"></div><!----></div><div data-v-1f85cb5f="" data-v-17a8ac96="" data-v-41d33d72="" class="index-book-collect" place="entry" category="5562b419e4b00c57d9b94ae2"><div data-v-1f85cb5f="" class="header"><div data-v-1f85cb5f="" class="title">æ˜é‡‘å°å†Œ</div><div data-v-1f85cb5f="" class="controllers"><div data-v-1f85cb5f="" class="arrow icon ion-chevron-left"></div><div data-v-1f85cb5f="" class="arrow icon ion-chevron-right"></div></div></div><div data-v-1f85cb5f="" class="slide-book transition--next"><div data-v-133abdc5="" data-v-1f85cb5f="" class="slide-book-list item"><a data-v-133abdc5="" href="/book/5b7be023e51d4538850305d0" class="item"><div data-v-133abdc5="" class="poster"><div data-v-b2db8566="" data-v-009ea7bb="" data-v-133abdc5="" data-src="https://user-gold-cdn.xitu.io/2018/9/18/165eb6f3cb9eb04f?imageView2/1/w/104/h/144/q/95/interlace/1" class="lazy thumb poster-img loaded" style="background-image: url(https://user-gold-cdn.xitu.io/2018/9/18/165eb6f3cb9eb04f?imageView2/1/w/104/h/144/q/95/interlace/1); background-size: cover;"></div></div><div data-v-133abdc5="" class="content-text"><div data-v-133abdc5="" class="title">å¾®ä¿¡å°æ¸¸æˆå¼€å‘å…¥é—¨ï¼šä» 0 åˆ° 1 å®ç°äº•å­—æ£‹æ¸¸æˆ</div><div data-v-133abdc5="" class="price"><div data-v-133abdc5="" class="new">æ–°äººä»· ï¿¥4.95</div><div data-v-133abdc5="" class="delete">ï¿¥9.9</div></div></div></a><a data-v-133abdc5="" href="/book/5a157c155188254a701eb3c1" class="item"><div data-v-133abdc5="" class="poster"><div data-v-b2db8566="" data-v-009ea7bb="" data-v-133abdc5="" data-src="https://user-gold-cdn.xitu.io/2017/12/18/160691fc2995dbf9?imageView2/1/w/104/h/144/q/95/interlace/1" class="lazy thumb poster-img loaded" style="background-image: url(https://user-gold-cdn.xitu.io/2017/12/18/160691fc2995dbf9?imageView2/1/w/104/h/144/q/95/interlace/1); background-size: cover;"></div></div><div data-v-133abdc5="" class="content-text"><div data-v-133abdc5="" class="title">åŸºäº Python å®ç°å¾®ä¿¡å…¬ä¼—å·çˆ¬è™«</div><div data-v-133abdc5="" class="price"><div data-v-133abdc5="" class="new">æ–°äººä»· ï¿¥9.95</div><div data-v-133abdc5="" class="delete">ï¿¥19.9</div></div></div></a></div></div><div data-v-1f85cb5f="" class="book-newuser"><div data-v-1f85cb5f="" class="newuser-title"><span data-v-1f85cb5f="">æ–°äººä¸“äº«å¥½ç¤¼</span></div><div data-v-1f85cb5f="" class="giftbag"><img data-v-1f85cb5f="" src="https://b-gold-cdn.xitu.io/v3/static/img/45.b99ea03.svg"><div data-v-1f85cb5f="" class="content-text"><div data-v-1f85cb5f="" class="title">é€ä½ <span data-v-1f85cb5f="" class="highlight">45å…ƒ</span>ä¹°å°å†Œ</div><div data-v-1f85cb5f="" class="btn-box"><div data-v-1f85cb5f="" class="btn-giftbag">ç«‹å³é¢†å–</div></div></div></div></div></div><!----><div data-v-70a2cd6d="" data-v-f6632f66="" data-v-41d33d72="" class="sidebar-block related-entry-sidebar-block sticky-section shadow" st:block="relatedEntrySidebarBlock" data-v-3f216172=""><div data-v-70a2cd6d="" class="block-title">ç›¸å…³æ–‡ç« </div><div data-v-70a2cd6d="" class="block-body"><div data-v-f6632f66="" data-v-70a2cd6d="" class="entry-list"><a data-v-f6632f66="" href="/entry/5bcc88c46fb9a05d3c803037" target="_blank" rel="" st:name="link" class="item" data-v-70a2cd6d=""><div data-v-f6632f66="" class="entry-title">è¯¦è§£JVMå¦‚ä½•å¤„ç†å¼‚å¸¸</div><div data-v-f6632f66="" class="entry-meta-box"><div data-v-f6632f66="" class="entry-meta"><img data-v-f6632f66="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgIDxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgxNnYxNkgweiIvPgogICAgICAgIDxwYXRoIGZpbGw9IiNCMkJBQzIiIGQ9Ik00LjIzNCA2LjY5M3Y3LjI0M0gyLjg4MWMtLjQ4NiAwLS44ODEtLjQ5Mi0uODgxLTEuMDk1VjcuODc1YzAtLjYzLjQxMi0xLjE4Mi44OC0xLjE4MmgxLjM1NHptMy42ODgtMy43QzguMDEgMi40MDQgOC40OSAxLjk5IDkuMDE4IDJjLjc1NC4wMTUgMS4yMDQuNjYzIDEuMzYuOTgzLjI4NC41ODUuMjkyIDEuNTQ5LjA5NyAyLjE2Ny0uMTc3LjU2LS41ODYgMS4yOTYtLjU4NiAxLjI5NmgzLjA2NmMuMzI0IDAgLjYyNS4xNjQuODI2LjQ0OS4yMDQuMjkuMjcuNjY4LjE3OCAxLjAxMWwtMS4zODcgNS4xODNjLS4xMjYuNDk5LS41NDQuODQ3LTEuMDE2Ljg0N0g1LjUzVjYuNjkzYzEuMzg1LS4zMDkgMi4yMzYtMi42MzIgMi4zOTItMy43eiIvPgogICAgPC9nPgo8L3N2Zz4K" class="icon"><span data-v-f6632f66="" class="count">4</span></div><div data-v-f6632f66="" class="entry-meta"><img data-v-f6632f66="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgIDxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgxNnYxNkgweiIvPgogICAgICAgIDxwYXRoIGZpbGw9IiNCMkJBQzIiIGQ9Ik0yIDR2OC4wMzhoNC40NDRMMTEuMTExIDE1di0yLjk2MkgxNFY0eiIvPgogICAgPC9nPgo8L3N2Zz4K" class="icon"><span data-v-f6632f66="" class="count">0</span></div></div></a><a data-v-f6632f66="" href="/post/5bcc90866fb9a05cea7fc51e" target="_blank" rel="" st:name="link" class="item" data-v-70a2cd6d=""><div data-v-f6632f66="" class="entry-title">2018 å¹´ç¬¬ 42 å‘¨æ²¸ç‚¹çœ‹ç‚¹ï¼šå¼€å‘éœ€æ±‚ï¼Œè¯·ç”¨æ•°æ®è¯´è¯</div><div data-v-f6632f66="" class="entry-meta-box"><div data-v-f6632f66="" class="entry-meta"><img data-v-f6632f66="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgIDxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgxNnYxNkgweiIvPgogICAgICAgIDxwYXRoIGZpbGw9IiNCMkJBQzIiIGQ9Ik00LjIzNCA2LjY5M3Y3LjI0M0gyLjg4MWMtLjQ4NiAwLS44ODEtLjQ5Mi0uODgxLTEuMDk1VjcuODc1YzAtLjYzLjQxMi0xLjE4Mi44OC0xLjE4MmgxLjM1NHptMy42ODgtMy43QzguMDEgMi40MDQgOC40OSAxLjk5IDkuMDE4IDJjLjc1NC4wMTUgMS4yMDQuNjYzIDEuMzYuOTgzLjI4NC41ODUuMjkyIDEuNTQ5LjA5NyAyLjE2Ny0uMTc3LjU2LS41ODYgMS4yOTYtLjU4NiAxLjI5NmgzLjA2NmMuMzI0IDAgLjYyNS4xNjQuODI2LjQ0OS4yMDQuMjkuMjcuNjY4LjE3OCAxLjAxMWwtMS4zODcgNS4xODNjLS4xMjYuNDk5LS41NDQuODQ3LTEuMDE2Ljg0N0g1LjUzVjYuNjkzYzEuMzg1LS4zMDkgMi4yMzYtMi42MzIgMi4zOTItMy43eiIvPgogICAgPC9nPgo8L3N2Zz4K" class="icon"><span data-v-f6632f66="" class="count">3</span></div><div data-v-f6632f66="" class="entry-meta"><img data-v-f6632f66="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgIDxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgxNnYxNkgweiIvPgogICAgICAgIDxwYXRoIGZpbGw9IiNCMkJBQzIiIGQ9Ik0yIDR2OC4wMzhoNC40NDRMMTEuMTExIDE1di0yLjk2MkgxNFY0eiIvPgogICAgPC9nPgo8L3N2Zz4K" class="icon"><span data-v-f6632f66="" class="count">0</span></div></div></a><a data-v-f6632f66="" href="/entry/5bca54015188255c63763d6a" target="_blank" rel="" st:name="link" class="item" data-v-70a2cd6d=""><div data-v-f6632f66="" class="entry-title">åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰</div><div data-v-f6632f66="" class="entry-meta-box"><div data-v-f6632f66="" class="entry-meta"><img data-v-f6632f66="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgIDxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgxNnYxNkgweiIvPgogICAgICAgIDxwYXRoIGZpbGw9IiNCMkJBQzIiIGQ9Ik00LjIzNCA2LjY5M3Y3LjI0M0gyLjg4MWMtLjQ4NiAwLS44ODEtLjQ5Mi0uODgxLTEuMDk1VjcuODc1YzAtLjYzLjQxMi0xLjE4Mi44OC0xLjE4MmgxLjM1NHptMy42ODgtMy43QzguMDEgMi40MDQgOC40OSAxLjk5IDkuMDE4IDJjLjc1NC4wMTUgMS4yMDQuNjYzIDEuMzYuOTgzLjI4NC41ODUuMjkyIDEuNTQ5LjA5NyAyLjE2Ny0uMTc3LjU2LS41ODYgMS4yOTYtLjU4NiAxLjI5NmgzLjA2NmMuMzI0IDAgLjYyNS4xNjQuODI2LjQ0OS4yMDQuMjkuMjcuNjY4LjE3OCAxLjAxMWwtMS4zODcgNS4xODNjLS4xMjYuNDk5LS41NDQuODQ3LTEuMDE2Ljg0N0g1LjUzVjYuNjkzYzEuMzg1LS4zMDkgMi4yMzYtMi42MzIgMi4zOTItMy43eiIvPgogICAgPC9nPgo8L3N2Zz4K" class="icon"><span data-v-f6632f66="" class="count">31</span></div><div data-v-f6632f66="" class="entry-meta"><img data-v-f6632f66="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgIDxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgxNnYxNkgweiIvPgogICAgICAgIDxwYXRoIGZpbGw9IiNCMkJBQzIiIGQ9Ik0yIDR2OC4wMzhoNC40NDRMMTEuMTExIDE1di0yLjk2MkgxNFY0eiIvPgogICAgPC9nPgo8L3N2Zz4K" class="icon"><span data-v-f6632f66="" class="count">0</span></div></div></a><a data-v-f6632f66="" href="/post/5bc75096f265da0aa94a4043" target="_blank" rel="" st:name="link" class="item" data-v-70a2cd6d=""><div data-v-f6632f66="" class="entry-title">èŠä¸€èŠ RestTemplate</div><div data-v-f6632f66="" class="entry-meta-box"><div data-v-f6632f66="" class="entry-meta"><img data-v-f6632f66="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgIDxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgxNnYxNkgweiIvPgogICAgICAgIDxwYXRoIGZpbGw9IiNCMkJBQzIiIGQ9Ik00LjIzNCA2LjY5M3Y3LjI0M0gyLjg4MWMtLjQ4NiAwLS44ODEtLjQ5Mi0uODgxLTEuMDk1VjcuODc1YzAtLjYzLjQxMi0xLjE4Mi44OC0xLjE4MmgxLjM1NHptMy42ODgtMy43QzguMDEgMi40MDQgOC40OSAxLjk5IDkuMDE4IDJjLjc1NC4wMTUgMS4yMDQuNjYzIDEuMzYuOTgzLjI4NC41ODUuMjkyIDEuNTQ5LjA5NyAyLjE2Ny0uMTc3LjU2LS41ODYgMS4yOTYtLjU4NiAxLjI5NmgzLjA2NmMuMzI0IDAgLjYyNS4xNjQuODI2LjQ0OS4yMDQuMjkuMjcuNjY4LjE3OCAxLjAxMWwtMS4zODcgNS4xODNjLS4xMjYuNDk5LS41NDQuODQ3LTEuMDE2Ljg0N0g1LjUzVjYuNjkzYzEuMzg1LS4zMDkgMi4yMzYtMi42MzIgMi4zOTItMy43eiIvPgogICAgPC9nPgo8L3N2Zz4K" class="icon"><span data-v-f6632f66="" class="count">28</span></div><div data-v-f6632f66="" class="entry-meta"><img data-v-f6632f66="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgIDxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgxNnYxNkgweiIvPgogICAgICAgIDxwYXRoIGZpbGw9IiNCMkJBQzIiIGQ9Ik0yIDR2OC4wMzhoNC40NDRMMTEuMTExIDE1di0yLjk2MkgxNFY0eiIvPgogICAgPC9nPgo8L3N2Zz4K" class="icon"><span data-v-f6632f66="" class="count">0</span></div></div></a></div></div></div></div></div><div data-v-2febaf4d="" data-v-41d33d72="" class="article-suspended-panel article-suspended-panel" data-v-3f216172=""><div data-v-2febaf4d="" badge="22" class="like-btn panel-btn like-adjust with-badge"></div><div data-v-2febaf4d="" badge="0" class="comment-btn panel-btn comment-adjust"></div><div data-v-2febaf4d="" class="collect-btn panel-btn"><!----></div><div data-v-2febaf4d="" class="share-title">åˆ†äº«</div><div data-v-2febaf4d="" class="weibo-btn share-btn panel-btn"></div><div data-v-2febaf4d="" class="qq-btn share-btn panel-btn"></div><div data-v-2febaf4d="" class="wechat-btn share-btn panel-btn"><img data-v-2febaf4d="" src="" class="wechat-qr-code-img shadow" style="display: none;"></div></div><div data-v-f0e3c22e="" data-v-41d33d72="" class="image-viewer-box" data-v-3f216172=""><!----></div><div data-v-00a4671b="" data-v-41d33d72="" st:block="mobileBottomBar" class="mobile-bottom-bar" data-v-3f216172=""><div data-v-00a4671b="" class="bar-container"><a data-v-00a4671b="" href="https://juejin.im/about" class="left"><img data-v-00a4671b="" src="https://b-gold-cdn.xitu.io/images/logo-bold.svg"><span data-v-00a4671b="">ä¸€ä¸ªå¸®åŠ©å¼€å‘è€…æˆé•¿çš„ç¤¾åŒº</span></a><a data-v-00a4671b="" st:name="openInAppBtn" class="button">æ‰“å¼€åº”ç”¨<div data-v-00a4671b="" class="pop-up" style="display: none;"><a data-v-00a4671b="" class="pop-up-content"></a></div></a></div></div></main></div><div data-v-19078e6d="" data-v-6ede48a3="" class="recommend-box"><div data-v-19078e6d="" class="extension"><div data-v-19078e6d="" data-growing-container="true" data-growing-title="æ˜é‡‘æ’ä»¶" class="link"><div data-v-19078e6d="" class="title">æ˜é‡‘æµè§ˆå™¨æ’ä»¶ - ä¸‹è½½æ’ä»¶ï¼Œé€ä½ <span data-v-19078e6d="" class="price">45å…ƒ</span>ä¹°å°å†Œ</div></div><div data-v-19078e6d="" class="ion-close"></div></div><!----></div></div>
      
      <script type="text/javascript" src="https://b-gold-cdn.xitu.io/v3/static/js/manifest.20254fa563d3539b68bf.js"></script><script type="text/javascript" src="https://b-gold-cdn.xitu.io/v3/static/js/vendor.e6fd81aa1499049a5bee.js"></script><script type="text/javascript" src="https://b-gold-cdn.xitu.io/v3/static/js/app.a99a1e8180beec940a3f.js"></script>
    </body></html>